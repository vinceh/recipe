# Database Architecture

This document describes the recipe database schema, field definitions, data types, and organizational principles.

## Overview

The recipe database uses a normalized relational schema with PostgreSQL and the Mobility gem for internationalization (i18n). All recipes support translation into 7 languages: English, Japanese, Korean, Traditional Chinese, Simplified Chinese, Spanish, and French.

## Table Structure

### Core Tables

#### `recipes`
Stores the main recipe information with source language and structural data.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | UUID | Primary key | Generated by PostgreSQL |
| `name` | String | Recipe name (deprecated - use Mobility) | Max 255 characters |
| `source_language` | String | Language the recipe was authored in | ISO 639-1 code: `en`, `ja`, `ko`, `zh-tw`, `zh-cn`, `es`, `fr` |
| `requires_precision` | Boolean | Whether precise measurements are critical | `true` or `false` |
| `precision_reason` | String | Reason why precision is required | One of: `baking`, `confectionery`, `fermentation`, `molecular` |
| `difficulty_level` | Integer | Recipe difficulty/skill level | Enum: `0` = easy, `1` = medium, `2` = hard |
| `servings_original` | Integer | Default number of servings | Positive integer |
| `servings_min` | Integer | Minimum servings for scaling | Positive integer, ≤ `servings_original` |
| `servings_max` | Integer | Maximum servings for scaling | Positive integer, ≥ `servings_original` |
| `prep_minutes` | Integer | Preparation time | Non-negative integer (minutes) |
| `cook_minutes` | Integer | Active cooking time | Non-negative integer (minutes) |
| `total_minutes` | Integer | Total time from start to finish | Non-negative integer (minutes), typically ≥ prep + cook |
| `source_url` | String | Original recipe source URL | Valid HTTP(S) URL or null |
| `admin_notes` | Text | Internal notes (not visible to users) | Any text |
| `variants_generated` | Boolean | Whether step variants have been created | `true` or `false` |
| `variants_generated_at` | DateTime | Timestamp of last variant generation | ISO 8601 timestamp or null |
| `translations_completed` | Boolean | Whether all language translations are complete | `true` or `false` |
| `translation_status` | JSONB | Progress tracking for each language | See [Translation Status JSONB](#translation-status-jsonb) |
| `created_at` | DateTime | Created timestamp | ISO 8601 timestamp |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 timestamp |

**Indexes:**
- Primary key on `id` (UUID)
- Index on `source_language` (for filtering by authoring language)
- Index on `difficulty_level` (for filtering by recipe difficulty)
- Index on `created_at` (for chronological queries)

#### `recipe_translations`
Mobility gem table for translating recipe name and other text fields.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `recipe_id` | UUID | Foreign key to recipes | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Field name being translated | NOT NULL, e.g., `name`, `description` |
| `value` | Text | Translated content | Text or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(recipe_id, locale, key)` - one translation per recipe/language/field combination

**Indexes:**
- Primary key on `id`
- Index on `(recipe_id, locale)` for efficient lookup by recipe and language
- Index on `recipe_id` for foreign key queries

**Translatable Fields:**
- `name` - recipe name
- `description` - recipe description, overview, and context (NOT NULL, TEXT type)

---

### Ingredient Tables

#### `ingredient_groups`
Groups ingredients for organizational purposes (e.g., "Sauce", "Main Ingredients").

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | UUID | Primary key | Generated by PostgreSQL |
| `recipe_id` | UUID | Foreign key to recipes | NOT NULL, indexed |
| `order` | Integer | Display order within recipe | ≥ 0, ordered by this field |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Foreign key index on `recipe_id`

#### `ingredient_group_translations`
Mobility gem table for translating ingredient group names.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `ingredient_group_id` | UUID | Foreign key to ingredient_groups | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Field name being translated | NOT NULL, always `name` |
| `value` | Text | Translated group name | Text or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(ingredient_group_id, locale, key)`

**Translatable Fields:** `name` (e.g., "Sauce" → "ソース")

#### `recipe_ingredients`
Individual ingredients within an ingredient group.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | UUID | Primary key | Generated by PostgreSQL |
| `ingredient_group_id` | UUID | Foreign key to ingredient_groups | NOT NULL, indexed |
| `order` | Integer | Display order within group | ≥ 0 |
| `amount` | Decimal | Quantity of ingredient | Precision: 8 digits, Scale: 2 (e.g., `100.50`) |
| `unit` | String | Unit of measurement | Examples: `cup`, `tbsp`, `g`, `ml`, `oz`, `lb` |
| `optional` | Boolean | Whether ingredient is optional | `true` or `false` |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Foreign key index on `ingredient_group_id`

#### `recipe_ingredient_translations`
Mobility gem table for translating ingredient names and preparation notes.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `recipe_ingredient_id` | UUID | Foreign key to recipe_ingredients | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Field name | NOT NULL, one of: `ingredient_name`, `preparation_notes` |
| `value` | Text | Translated content | Text or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(recipe_ingredient_id, locale, key)`

**Translatable Fields:**
- `ingredient_name` - the ingredient name (e.g., "all-purpose flour" → "薄力粉")
- `preparation_notes` - how to prepare it (e.g., "sifted" → "ふるった")

---

### Step Tables

#### `recipe_steps`
Individual cooking instructions and steps.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | UUID | Primary key | Generated by PostgreSQL |
| `recipe_id` | UUID | Foreign key to recipes | NOT NULL, indexed |
| `order` | Integer | Step number | ≥ 1, ordered by this field |
| `timing_minutes` | Integer | Time for this step | Non-negative integer or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Foreign key index on `recipe_id`
- Index on `(recipe_id, order)` for efficient step retrieval

#### `recipe_step_translations`
Mobility gem table for translating step instructions in 3 variants.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `recipe_step_id` | UUID | Foreign key to recipe_steps | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Instruction variant type | NOT NULL, one of: `instruction_original`, `instruction_easier`, `instruction_no_equipment` |
| `value` | Text | Translated instruction | Text |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(recipe_step_id, locale, key)` - one translation per step/language/variant

**Indexes:**
- Primary key on `id`
- Index on `(recipe_step_id, locale)` for efficient lookup
- Index on `recipe_step_id` for foreign key queries

**Translatable Fields:**
- `instruction_original` - base instruction as written
- `instruction_easier` - simplified version for beginners
- `instruction_no_equipment` - version without special equipment (when applicable)

**Notes:** Each step has up to 3 instructions × 7 languages = up to 21 translation rows per step. This allows complete flexibility in step variant generation and translation.

---

### Nutrition Table

#### `recipe_nutrition`
Nutritional information per serving.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | UUID | Primary key | Generated by PostgreSQL |
| `recipe_id` | UUID | Foreign key to recipes (one-to-one) | NOT NULL, unique constraint |
| `calories` | Decimal | Energy content | Precision: 8, Scale: 2 (e.g., `245.50` calories) |
| `protein_g` | Decimal | Protein content | Precision: 6, Scale: 2 (grams, e.g., `12.50`) |
| `carbs_g` | Decimal | Carbohydrate content | Precision: 6, Scale: 2 (grams, e.g., `45.25`) |
| `fat_g` | Decimal | Fat content | Precision: 6, Scale: 2 (grams, e.g., `8.75`) |
| `fiber_g` | Decimal | Dietary fiber content | Precision: 6, Scale: 2 (grams, e.g., `3.50`) |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Unique constraint on `recipe_id` (one nutrition record per recipe)

**Notes:** Decimal columns use:
- Precision: Total number of significant digits
- Scale: Number of digits after the decimal point
- All nutrition values are per serving

---

### Reference Data Tables (Tags & Classifications)

#### `recipe_dietary_tags` (Join Table)
Many-to-many relationship between recipes and dietary tags.

| Field | Type | Description |
|-------|------|-------------|
| `id` | UUID | Primary key |
| `recipe_id` | UUID | Foreign key to recipes |
| `dietary_tag_id` | UUID | Foreign key to data_references |
| `created_at` | DateTime | Created timestamp |

**Unique Constraint:** `(recipe_id, dietary_tag_id)` - prevent duplicate tags per recipe

**Indexes:** Foreign key indexes on both columns

**Examples:** vegetarian, vegan, gluten-free, dairy-free, nut-free, paleo, keto, low-carb

#### `recipe_cuisines` (Join Table)
Many-to-many relationship between recipes and cuisines.

| Field | Type | Description |
|-------|------|-------------|
| `id` | UUID | Primary key |
| `recipe_id` | UUID | Foreign key to recipes |
| `cuisine_id` | UUID | Foreign key to data_references |
| `created_at` | DateTime | Created timestamp |

**Unique Constraint:** `(recipe_id, cuisine_id)`

**Indexes:** Foreign key indexes

**Examples:** italian, french, japanese, thai, mexican, indian, chinese, korean, mediterranean, middle-eastern

#### `data_references`
Reference data for categories like dietary tags and cuisines.

| Field | Type | Description |
|-------|------|-------------|
| `id` | UUID | Primary key |
| `reference_type` | String | Type of reference: `dietary_tag`, `cuisine`, `unit` |
| `key` | String | Machine-readable key (kebab-case) |
| `sort_order` | Integer | Display order |
| `active` | Boolean | Whether this reference is currently in use |
| `created_at` | DateTime | Created timestamp |
| `updated_at` | DateTime | Last updated timestamp |

**Unique Constraint:** `(reference_type, key)` - one key per reference type

**Indexes:** Index on `reference_type` for filtering

#### `data_reference_translations`
Mobility gem table for translating data reference display names.

| Field | Type | Description |
|-------|------|-------------|
| `id` | Integer | Primary key |
| `data_reference_id` | UUID | Foreign key to data_references |
| `locale` | String | Language code |
| `key` | String | Field name (always `display_name`) |
| `value` | Text | Translated name (e.g., "Vegetarian" → "ベジタリアン") |
| `created_at` | DateTime | Created timestamp |
| `updated_at` | DateTime | Last updated timestamp |

**Unique Constraint:** `(data_reference_id, locale, key)`

**Translatable Fields:** `display_name` - the user-facing display name

---

### Equipment Table

#### `equipment` (JSONB Array - Deferred Normalization)
Equipment needed for the recipe. Currently stored as JSONB array of strings (normalization deferred to future phase).

**Current Structure:**
```json
[
  "large pot",
  "wooden spoon",
  "cutting board",
  "chef's knife"
]
```

**Notes:** This field will be normalized in a future phase into a proper `equipment` table with translations via Mobility. For now, equipment names are not translatable - they remain in the source language.

---

### Active Storage Tables (File Storage)

Recipe images are stored using Rails Active Storage. This framework provides three tables to manage file uploads.

#### `active_storage_blobs`
Stores metadata about uploaded files.

| Field | Type | Description |
|-------|------|-------------|
| `id` | BigInt | Primary key |
| `key` | String | Unique storage key (UUID format) |
| `filename` | String | Original filename uploaded |
| `content_type` | String | MIME type (e.g., `image/jpeg`, `image/png`) |
| `metadata` | JSON | Additional file metadata |
| `byte_size` | BigInt | File size in bytes |
| `checksum` | String | MD5 checksum for integrity verification |
| `created_at` | DateTime | Upload timestamp |

**Indexes:**
- Primary key on `id`
- Unique index on `key` (for fast retrieval)

**Notes:** One blob record per uploaded file, regardless of how many models reference it.

#### `active_storage_attachments`
Links stored files (blobs) to models using polymorphic association.

| Field | Type | Description |
|-------|------|-------------|
| `id` | BigInt | Primary key |
| `name` | String | Attachment name (e.g., `image`) |
| `record_type` | String | Model type (e.g., `Recipe`) |
| `record_id` | UUID | Model ID (e.g., recipe ID) |
| `blob_id` | BigInt | Foreign key to `active_storage_blobs` |
| `created_at` | DateTime | Attachment timestamp |

**Unique Constraint:** `(record_type, record_id, name, blob_id)` - prevents duplicate attachments

**Indexes:**
- Unique index on `(record_type, record_id, name, blob_id)`
- Index on `blob_id` for fast blob lookup

**Usage:** For recipes, this links recipe images to their corresponding recipe records.

#### `active_storage_variant_records`
Stores pre-generated image variants (thumbnails, resized versions, etc.).

| Field | Type | Description |
|-------|------|-------------|
| `id` | BigInt | Primary key |
| `blob_id` | BigInt | Foreign key to `active_storage_blobs` |
| `variation_digest` | String | Hash of variant transformation parameters |

**Unique Constraint:** `(blob_id, variation_digest)` - one variant per unique transformation

**Indexes:**
- Unique index on `(blob_id, variation_digest)`

**Notes:** Currently not in use - added automatically by Rails. Future enhancement for image thumbnails and responsive sizes.

**Relationship to Recipes:**
- Recipe has many attachments (polymorphic)
- Each recipe can have one image attachment via `has_one_attached :image`
- Image attachment references blob via `active_storage_attachments`
- Blob contains file metadata and storage key

---

## JSONB Structures

### Translation Status JSONB
Location: `recipes.translation_status`

Tracks translation progress for each language independently.

**Structure:**
```json
{
  "ja": {
    "status": "completed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": "2025-10-20T10:45:00Z",
    "error": null
  },
  "ko": {
    "status": "in_progress",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": null,
    "error": null
  },
  "zh-tw": {
    "status": "pending",
    "started_at": null,
    "completed_at": null,
    "error": null
  },
  "zh-cn": {
    "status": "failed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": null,
    "error": "API timeout after 30 seconds"
  },
  "es": {
    "status": "completed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": "2025-10-20T10:35:00Z",
    "error": null
  },
  "fr": {
    "status": "completed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": "2025-10-20T10:40:00Z",
    "error": null
  }
}
```

**Fields:**
- `status` - One of: `pending`, `in_progress`, `completed`, `failed`
- `started_at` - ISO 8601 timestamp when translation job started (null if pending)
- `completed_at` - ISO 8601 timestamp when translation finished (null if not completed)
- `error` - Error message if status is `failed`, null otherwise

**Supported Languages:**
- `en` - English (source language, not translated)
- `ja` - 日本語 (Japanese)
- `ko` - 한국어 (Korean)
- `zh-tw` - 繁體中文 (Traditional Chinese)
- `zh-cn` - 简体中文 (Simplified Chinese)
- `es` - Español (Spanish)
- `fr` - Français (French)

---

## Data Organization Principles

### Internationalization (i18n)

**Supported Languages:** 7 (English + 6 target languages)

**Translation Approach:**
- **Mobility Gem with Table Backend:** Each translatable model has a `{model}_translations` table
- **Fallback Strategy:** If translation missing for a language, falls back to `source_language`
- **User-Facing Language:** Determined by frontend UI language selection, passed via `?locale=` query parameter
- **API Behavior:** Returns translated content when available, source language as fallback

**Translatable Content:**
- Recipe name (via `recipe_translations`)
- Ingredient group names (via `ingredient_group_translations`)
- Ingredient names & preparation notes (via `recipe_ingredient_translations`)
- Step instructions - all 3 variants (via `recipe_step_translations`)
- Data reference display names like "Vegetarian" (via `data_reference_translations`)
- Equipment names (deferred - currently stored as JSONB, non-translatable)

**Non-Translatable Content:**
- Numeric fields (servings, timing, nutrition)
- Amounts and units
- Boolean flags (requires_precision, optional, active, etc.)
- IDs and foreign keys

### Data Integrity

**Foreign Key Constraints:** All relationships use explicit foreign keys with CASCADE delete where appropriate:
- `ingredient_groups` → `recipes` (CASCADE delete)
- `recipe_ingredients` → `ingredient_groups` (CASCADE delete)
- `recipe_steps` → `recipes` (CASCADE delete)
- `recipe_nutrition` → `recipes` (CASCADE delete)
- Join tables → `recipes` (CASCADE delete)

**Unique Constraints:** Prevent duplicates:
- Email in `users` table
- Recipe name in source language per recipe
- Dietary tag per recipe (via join table)
- Translation rows per entity/language/field combination

**Indexes:** Optimized for common queries:
- Lookups by recipe ID (foreign keys)
- Filtering by source language
- Searching by creation date
- Retrieving steps in order
- Finding recipes by tags/cuisines/dietary restrictions

### Numeric Precision

**Timing Fields:** Integer minutes
- `prep_minutes`, `cook_minutes`, `total_minutes`, `timing_minutes`
- Range: 0 to 2,147,483,647 (sufficient for any recipe)

**Nutrition Fields:** Decimal with 2 decimal places
- `calories`, `protein_g`, `carbs_g`, `fat_g`, `fiber_g`
- Precision: 8 digits total, Scale: 2 decimal places
- Example: `245.50` represents 245.50 calories or grams
- Supports values from 0.00 to 999999.99

**Amount Fields:** Decimal with 2 decimal places
- `recipe_ingredients.amount`
- Precision: 8 digits total, Scale: 2 decimal places
- Example: `2.50` represents 2.50 cups of flour

### Units & Standards

**Timing:** Always in minutes
- No conversion needed between display and storage
- `total_minutes` should be ≥ (prep + cook)

**Nutrition:** Always in gram-based units
- Calories: no unit needed (calories are the unit)
- Protein, carbs, fat, fiber: grams (g)
- Store as decimals to support precision (e.g., 12.50g protein)

**Ingredient Amounts:** User-specified units
- Common units: cup, tbsp, tsp, ml, l, g, kg, oz, lb, count, pinch, dash
- Not normalized (user specifies the unit they prefer)
- Handled by frontend for scaling operations

---

## Related Documentation

- **i18n Implementation:** See [i18n guide](./i18n.md) for translation workflow and API usage
- **Architecture Overview:** See [architecture.md](./architecture.md) for system-level design
- **Getting Started:** See [entry.md](./entry.md) for navigation and project overview
