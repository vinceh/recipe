
================================================================================
[2025-11-10T18:21:16.353Z] REQUEST
Step: step-2-plan-feature
Model: claude-sonnet-4-5-20250929
================================================================================

SYSTEM:
# Planner Agent

You are a specialized AI planning agent for full-stack feature development. Your role is to break down feature descriptions into detailed, actionable task plans for backend and frontend implementation.

## Your Responsibilities

1. **Analyze** the feature description thoroughly
2. **Explore** the existing codebase using read_file, grep, and glob tools
3. **Plan** the implementation steps for both backend and frontend
4. **Break down** complex tasks into atomic subtasks
5. **Output** structured JSON following the exact schema

## 2025 Best Practices You Follow

### Structured Planning (Chain-of-Thought)
- Think step-by-step before outputting the final plan
- State your reasoning explicitly: "First I will..., then I will..."
- Consider dependencies between tasks
- Plan for both happy path and error handling

### PLAN-ACT Separation
- You are in PLAN MODE only - you do NOT write code
- Focus on WHAT needs to be done, not HOW to code it
- Be specific about outcomes, not implementation details

### Task Breakdown Principles
- Each main task should be implementable in one development session
- Subtasks should be atomic (can't be broken down further without losing meaning)
- Use action verbs: "Create", "Add", "Update", "Implement", "Define"
- Be specific about files/components when possible

## Your Process

### Step 1: Understand the Feature
Read the feature description carefully. Identify:
- Core functionality required
- Data models needed (backend)
- UI components needed (frontend)
- Integration points between BE and FE

### Step 2: Explore Existing Codebase
Use your tools to explore and understand the codebase:
- **glob**: Find existing controllers, models, services (backend) and components, views, stores (frontend)
  - Example: `glob("backend/app/controllers/**/*.rb")`
- **grep**: Search for patterns and architectural conventions
  - Example: `grep("class.*Controller", "backend/app/controllers/**/*.rb")`
- **read_file**: Read key files to understand implementation details
  - Example: `read_file("backend/app/models/user.rb")`
- Identify current architectural patterns and testing approach

**Tool Usage Tips:**
- Start broad with `glob` to see what files exist
- Use `grep` to find patterns and similar implementations
- Use `read_file` selectively for key files (don't read everything)
- Focus on understanding patterns, not memorizing every detail

### Step 3: Plan Backend Tasks
For Rails backend, consider:
- Database changes (models, migrations)
- API endpoints (controllers)
- Business logic (services)
- Background jobs (if needed)
- Tests (RSpec)

### Step 4: Plan Frontend Tasks
For Vue 3 frontend, consider:
- New components or views
- State management (Pinia stores)
- API integration (services)
- Routing changes
- Tests (Playwright)

### Step 5: Output Structured JSON
Follow this EXACT schema:

```json
{
  "backend": [
    {
      "desc": "Main task description",
      "subtasks": [
        { "desc": "Specific subtask 1" },
        { "desc": "Specific subtask 2" }
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Main task description",
      "subtasks": [
        { "desc": "Specific subtask 1" },
        { "desc": "Specific subtask 2" }
      ]
    }
  ]
}
```

## Quality Standards

### ‚úÖ Good Task Descriptions
- "Create User model with authentication fields"
- "Add POST /api/v1/recipes endpoint with validation"
- "Implement RecipeCard component with image and title"
- "Add recipe favoriting to Pinia store"

### ‚ùå Bad Task Descriptions
- "Set up the database" (too vague)
- "Fix the frontend" (not specific)
- "Make it work" (no clear outcome)
- "Implement the feature" (not broken down)

### ‚úÖ Good Subtasks
- "Add has_many :favorites association"
- "Validate presence of recipe_id and user_id"
- "Create migration for favorites table"

### ‚ùå Bad Subtasks
- "Do the model stuff" (vague)
- "Add validations" (which ones?)
- "Update database" (how?)

## Important Constraints

- **Read-only access**: You cannot modify files
- **No code writing**: You plan, you don't implement
- **Structured output only**: Always return valid JSON
- **Complete coverage**: Don't skip obvious requirements

## Interaction with User

The user may iterate on your plan. They may say:
- "Break down task X further"
- "Add Y to the plan"
- "This seems too complex, simplify"

Listen to their feedback and revise your plan accordingly. When they approve, output the final JSON.

## Example Output

```json
{
  "backend": [
    {
      "desc": "Create Recipe model with core fields",
      "subtasks": [
        { "desc": "Generate Recipe model with name, description, servings fields" },
        { "desc": "Add validations for required fields" },
        { "desc": "Create migration for recipes table" },
        { "desc": "Run migration" }
      ]
    },
    {
      "desc": "Implement Recipe API endpoints",
      "subtasks": [
        { "desc": "Create RecipesController with index, show, create actions" },
        { "desc": "Add routes for /api/v1/recipes" },
        { "desc": "Add JSON serialization for Recipe model" }
      ]
    },
    {
      "desc": "Write RSpec tests for Recipe",
      "subtasks": [
        { "desc": "Write model specs for validations" },
        { "desc": "Write request specs for API endpoints" }
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Create recipe listing UI",
      "subtasks": [
        { "desc": "Create RecipeList.vue component" },
        { "desc": "Create RecipeCard.vue component for displaying individual recipes" },
        { "desc": "Add route /recipes to router" }
      ]
    },
    {
      "desc": "Integrate with Recipe API",
      "subtasks": [
        { "desc": "Create recipeService.ts with getRecipes method" },
        { "desc": "Create useRecipes composable for state management" },
        { "desc": "Fetch and display recipes in RecipeList component" }
      ]
    }
  ]
}
```

## Remember

- Your goal is to make the implementer's job easy by providing clear, actionable tasks
- Think like a tech lead breaking down work for a development team
- Be thorough but not overwhelming - aim for 3-6 main tasks per side
- Each main task should take 30min - 2 hours to implement
- Subtasks should take 5-30 minutes each

Now, analyze the feature description and create your plan!


USER:
# Project Context

# Project Context Files

## docs/new_claude/project-overview.md

```
# Project Overview

**Project:** Recipe App (Ember)
**Developer:** V
**Timeline:** 8 weeks MVP

---

## What Is This Project?

**Ember** is a flexible, intelligent recipe platform designed to make cooking easier through smart technology. Unlike traditional recipe apps that display static instructions, Ember provides dynamic scaling, adaptive instructions, multi-lingual support, and nutrition-first search capabilities.

### Core Concept

Recipes in Ember are structured data (not just text) with built-in intelligence:
- **Smart Scaling** - Adjust servings or scale by specific ingredients with context-aware precision
- **Adaptive Instructions** - Each step has 3 pre-generated variants (Original, Easier, No Equipment)
- **Multi-lingual** - Full support for 7 languages (English, Japanese, Korean, Traditional Chinese, Simplified Chinese, Spanish, French)
- **Nutrition-First** - Search and filter by dietary needs, not just keywords

### Target Users

1. **Home Cooks** - Anyone who cooks regularly and wants flexibility
2. **Dietary-Conscious Users** - People with dietary restrictions (vegan, gluten-free, keto, etc.)
3. **International Users** - Non-English speakers who need recipes in their language
4. **Recipe Creators** - Content creators and food bloggers who want to publish flexible recipes

---

## Technology Stack

### Backend
- **Ruby on Rails 8.0.3** (API-only mode)
- **PostgreSQL 14+** with JSONB and full-text search
- **Redis 7+** for caching and background jobs
- **Sidekiq** for async processing
- **Devise + JWT** for authentication
- **RSpec** for testing

### Frontend
- **Vue.js 3** with Composition API and TypeScript
- **PrimeVue** (Aura theme) for UI components
- **Pinia** for state management
- **Vue Router** for navigation
- **Vue I18n** for internationalization
- **Axios** for API calls

### External Services
- **Anthropic Claude API** - AI-powered recipe parsing, translation, and variant generation
- **Nutritionix API** - Ingredient nutrition data (progressive migration to proprietary database)

### Infrastructure (Planned)
- **Railway/Render/Heroku** - Backend hosting
- **Vercel/Netlify** - Frontend hosting
- **Managed PostgreSQL** - Database
- **Cloudflare CDN** - Asset delivery

---

## Key Features

### 1. Smart Scaling System
- Scale by servings (4 ‚Üí 8 servings)
- Scale by ingredient (200g chicken ‚Üí 500g chicken, auto-adjust everything else)
- Context-aware precision (baking vs cooking)
- Unit step-down (1 tbsp ‚Üí 3 tsp when scaling down)
- Whole item rounding (2.4 eggs ‚Üí 2 eggs)

**Acceptance Criteria:** AC-SCALE-001 to AC-SCALE-012

### 2. Adaptive Step Instructions
- Each step has 3 AI-generated variants:
  - **Original** - As written by recipe author
  - **Easier** - Simplified for beginners
  - **No Equipment** - Alternative for limited kitchen tools
- Pre-generated (not real-time AI) for instant UX
- User can toggle between variants while cooking

**Acceptance Criteria:** AC-VARIANT-001 to AC-VARIANT-008

### 3. Dynamic Recipe Translation (Mobility)
- 6 non-English languages (ja, ko, zh-tw, zh-cn, es, fr)
- Entire recipe content translated via AI (Claude API)
  - Recipe names, ingredient names, step instructions
  - Preparation notes, equipment names
- Stored in dedicated translation tables (not JSONB)
- TranslateRecipeJob enqueued automatically on recipe creation
- translations_completed flag tracks completion

### 4. Internationalization (i18n) - UI Text
- 7 supported languages (en, ja, ko, zh-tw, zh-cn, es, fr)
- UI text translations via Rails I18n (backend) + Vue I18n (frontend)
- 100% translation coverage requirement (all 7 languages)
- Language switcher in UI (top-right navbar)
- `Accept-Language` header for API localization
- User language preference saved and persists

### 5. Nutrition-First Search
- Filter by dietary tags (vegan, gluten-free, dairy-free, etc.)
- Filter by dish type (breakfast, dinner, dessert)
- Filter by cuisine (Italian, Japanese, Mexican, etc.)
- Filter by nutrition (calories < 300, protein > 20g)
- Full-text search with fuzzy matching

**Acceptance Criteria:** AC-SEARCH-001 to AC-SEARCH-012

### 6. User Personalization
- Save favorite recipes
- Add personal notes to recipes (general, per-ingredient, per-step)
- User-specific scaling preferences
- Preferred language setting

**Acceptance Criteria:** AC-USER-001 to AC-USER-008

### 7. Admin Recipe Management
- Create recipes manually with image upload
- Upload recipe display images (PNG/JPG/GIF/WebP, max 10MB)
- Active Storage support (local disk + AWS S3)
- Import recipes from URLs (AI parsing)
- Import recipes from text (AI parsing)
- Import recipes from images (Vision AI parsing for text extraction)
- Generate step variants (AI)
- Translate recipes to all 7 languages (AI)
- Manage ingredient database
- Manage reference data (dietary tags, cuisines, dish types)

**Acceptance Criteria:** AC-ADMIN-001 to AC-ADMIN-025

---

## Project Structure

```
recipe/
‚îú‚îÄ‚îÄ backend/                  # Rails API
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/     # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/          # ActiveRecord models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/        # Business logic
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jobs/            # Background jobs
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrate/         # Database migrations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.rb        # Current schema
‚îÇ   ‚îú‚îÄ‚îÄ spec/                # RSpec tests
‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ       ‚îî‚îÄ‚îÄ locales/         # Backend i18n files (7 languages)
‚îÇ
‚îú‚îÄ‚îÄ frontend/                # Vue.js SPA
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/      # Vue components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/      # Admin-only components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user/       # User-facing components
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shared/     # Shared components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views/           # Page-level views
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stores/          # Pinia stores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/        # API clients
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ composables/     # Reusable composition functions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ locales/         # Frontend i18n files (7 languages)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ styles/      # CSS (design system)
‚îÇ   ‚îî‚îÄ‚îÄ public/
‚îÇ
‚îî‚îÄ‚îÄ docs/                    # Documentation
    ‚îú‚îÄ‚îÄ new_claude/          # AI context (streamlined)
    ‚îú‚îÄ‚îÄ reference/           # Reference data
    ‚îî‚îÄ‚îÄ planning/            # Historical planning docs
```

---

## Development Approach

### Test-Driven Development (Backend)
1. Write Acceptance Criteria (GIVEN-WHEN-THEN format)
2. Write RSpec tests for each AC
3. Implement feature to make tests pass
4. 100% test pass required before commit

### Component-Driven Development (Frontend)
1. Check for existing components before creating new ones
2. Document components while building
3. Use design tokens (CSS variables) for all styling
4. 100% i18n coverage required before commit

### Documentation-First
- All API endpoints documented in [api-reference.md](api-reference.md)
- All components documented in [component-library.md](component-library.md)
- All ACs documented in [acceptance-criteria.md](acceptance-criteria.md)
- Documentation updated AS YOU BUILD, not after

---

## Current Status

**Phase 0: Project Setup** ‚úÖ COMPLETE
- Rails API created
- Vue.js frontend created
- PostgreSQL database configured
- Redis configured
- Authentication (Devise + JWT) working
- Both servers tested and running

**Phase 1: Database & Models** ‚úÖ COMPLETE
- All 9 migrations created and run
- All models created with validations
- Database seeded with reference data:
  - 40 dietary tags
  - 99 cuisines
  - 16 dish types
  - 74 recipe types

**Phase 2-5: Feature Development** üöß IN PROGRESS
- See [development-checklist.md](development-checklist.md) for detailed task breakdown

---

## Key Documents

### For AI Context
- **[00-START-HERE.md](00-START-HERE.md)** - Quick navigation guide
- **[development-workflow.md](development-workflow.md)** - MANDATORY workflows
- **[architecture.md](architecture.md)** - Backend + frontend architecture
- **[acceptance-criteria.md](acceptance-criteria.md)** - All ACs (127+ criteria)
- **[api-reference.md](api-reference.md)** - Complete API documentation (50+ endpoints)
- **[component-library.md](component-library.md)** - Component catalog

### For Planning
- **[../planning/PRD.md](../planning/PRD.md)** - Product Requirements Document
- **[../planning/technical-specification.md](../planning/technical-specification.md)** - Detailed tech spec
- **[../planning/epics.md](../planning/epics.md)** - Epic breakdown

### For Reference
- **[../reference/data/](../reference/data/)** - Dietary tags, cuisines, dish types, recipe types
- **[../reference/technical-designs/](../reference/technical-designs/)** - Nutrition strategy, scaling system

---

## Design Philosophy

### Backend
- **JSONB for flexibility** - Recipes as structured data, not rigid schema
- **Service objects** - Complex logic outside controllers
- **Background jobs** - AI operations don't block requests
- **Test-driven** - Every AC has RSpec tests

### Frontend
- **Component reuse** - Check component-library.md before creating new components
- **Design tokens** - All colors/spacing/fonts in CSS variables
- **Mobile-first** - Responsive from the start
- **i18n-first** - No hardcoded text allowed
- **Type-safe** - TypeScript for reliability

### User Experience
- **Pre-compute alternatives** - Instant UX (no waiting for AI during cooking)
- **AI as safety net** - For edge cases (~10% of users need this)
- **Separation of concerns** - Base recipe vs user customizations
- **90%+ coverage** - 2 pre-generated alternatives per step cover most use cases

---

## Timeline

- **Week 1-2:** Project setup, database, models ‚úÖ
- **Week 3-4:** Core recipe features (CRUD, scaling, search)
- **Week 5-6:** User features (favorites, notes), AI integration
- **Week 7:** Admin features, recipe import
- **Week 8:** Polish, testing, deployment

---

## Notes for AI Development

When starting a new AI session:
1. Read [00-START-HERE.md](00-START-HERE.md) for quick orientation
2. Check [development-checklist.md](development-checklist.md) for current tasks
3. Review [development-workflow.md](development-workflow.md) for MANDATORY processes
4. Reference [architecture.md](architecture.md) for system understanding

**Remember:**
- Backend: ACs ‚Üí Tests ‚Üí Code
- Frontend: Check components ‚Üí Build + i18n ‚Üí Document
- No hardcoded text allowed (backend or frontend)
- 100% test coverage (backend) and 100% i18n coverage (frontend) required

---


```

## docs/new_claude/architecture.md

```
# System Architecture

Backend and frontend architecture patterns, organization, design systems.

---

## Backend Architecture

1. Technology Stack
2. Database Design
3. Models & Associations
4. Mobility Translation System
5. API Structure
6. Services Layer
7. Background Jobs

---

## Technology Stack

**Core:**
- Ruby on Rails 8.0.3 (API-only)
- PostgreSQL 14+
- Redis 7+
- Sidekiq (background jobs)

**Auth & Security:**
- Devise + Devise-JWT

**Search & Optimization:**
- pg_trgm (fuzzy search)

**Translation:**
- Mobility ~1.3.2 (dynamic translation via Table backend)

**Testing:**
- RSpec

---

## Database Design

See: [../database-architecture.md](../database-architecture.md)

---

## Models & Associations

### Recipe Model

**Translatable fields:** `name` (via Mobility)

```ruby
class Recipe < ApplicationRecord
  extend Mobility

  translates :name, backend: :table

  # User associations
  has_many :user_favorites, dependent: :destroy
  has_many :user_recipe_notes, dependent: :destroy

  # Normalized schema
  has_many :ingredient_groups, -> { order(:position) }, dependent: :destroy
  has_many :recipe_ingredients, through: :ingredient_groups
  has_many :recipe_steps, -> { order(:step_number) }, dependent: :destroy
  has_one :recipe_nutrition, dependent: :destroy
  has_many :recipe_equipment, dependent: :destroy
  has_many :equipment, through: :recipe_equipment

  # Reference data
  has_many :recipe_dietary_tags, dependent: :destroy
  has_many :dietary_tags, through: :recipe_dietary_tags, source: :data_reference
  has_many :recipe_cuisines, dependent: :destroy
  has_many :cuisines, through: :recipe_cuisines, source: :data_reference

  # Other
  has_many :recipe_aliases, dependent: :destroy

  accepts_nested_attributes_for :ingredient_groups, allow_destroy: true, reject_if: :all_blank
  accepts_nested_attributes_for :recipe_steps, allow_destroy: true, reject_if: proc { |attrs| attrs['instruction_original'].blank? }
  accepts_nested_attributes_for :recipe_nutrition, allow_destroy: true, reject_if: :all_blank
  accepts_nested_attributes_for :recipe_equipment, allow_destroy: true, reject_if: proc { |attrs| attrs['equipment_id'].blank? }
  accepts_nested_attributes_for :recipe_dietary_tags, allow_destroy: true, reject_if: proc { |attrs| attrs['data_reference_id'].blank? }
  accepts_nested_attributes_for :recipe_cuisines, allow_destroy: true, reject_if: proc { |attrs| attrs['data_reference_id'].blank? }
  accepts_nested_attributes_for :recipe_aliases, allow_destroy: true, reject_if: proc { |attrs| attrs['alias_name'].blank? }

  validates :name, presence: true
  validates :source_language, presence: true, inclusion: { in: %w[en ja ko zh-tw zh-cn es fr] }
  validates :servings_original, numericality: { greater_than: 0, allow_nil: true }
  validates :servings_min, numericality: { greater_than_or_equal_to: 1, allow_nil: true }
  validates :servings_max, numericality: { greater_than_or_equal_to: 1, allow_nil: true }
  validates :prep_minutes, :cook_minutes, :total_minutes, numericality: { greater_than_or_equal_to: 0, allow_nil: true }
  validates :difficulty_level, presence: true, inclusion: { in: :difficulty_levels }

  enum :difficulty_level, { easy: 0, medium: 1, hard: 2 }
end
```

### IngredientGroup Model

**Translatable fields:** `name`

```ruby
class IngredientGroup < ApplicationRecord
  extend Mobility

  translates :name, backend: :table

  belongs_to :recipe
  has_many :recipe_ingredients, -> { order(:position) }, dependent: :destroy, inverse_of: :ingredient_group

  accepts_nested_attributes_for :recipe_ingredients, allow_destroy: true

  validates :name, presence: true
  validates :position, presence: true, numericality: { only_integer: true, greater_than_or_equal_to: 1 }
  validates :recipe_id, presence: true
  validates :position, uniqueness: { scope: :recipe_id }
end
```

### RecipeIngredient Model

**Translatable fields:** `ingredient_name`, `preparation_notes`

```ruby
class RecipeIngredient < ApplicationRecord
  extend Mobility

  translates :ingredient_name, :preparation_notes, backend: :table

  belongs_to :ingredient_group, inverse_of: :recipe_ingredients
  belongs_to :ingredient, optional: true

  validates :ingredient_name, presence: true
  validates :position, presence: true, numericality: { only_integer: true, greater_than_or_equal_to: 1 }
  validates :ingredient_group, presence: true
  validates :amount, numericality: { greater_than: 0, allow_nil: true }
end
```

### RecipeStep Model

**Translatable fields:** `instruction_original`, `instruction_easier`, `instruction_no_equipment`

```ruby
class RecipeStep < ApplicationRecord
  extend Mobility

  translates :instruction_original, :instruction_easier, :instruction_no_equipment, backend: :table

  belongs_to :recipe

  validates :recipe_id, presence: true
  validates :step_number, presence: true, numericality: { only_integer: true, greater_than: 0 }
  validates :step_number, uniqueness: { scope: :recipe_id }

  default_scope { order(:step_number) }
end
```

### Equipment Model

**Translatable fields:** `canonical_name`

```ruby
class Equipment < ApplicationRecord
  extend Mobility

  translates :canonical_name, backend: :table

  validates :canonical_name, presence: true, uniqueness: true
end
```

### DataReference Model

**Translatable fields:** `display_name`

```ruby
class DataReference < ApplicationRecord
  extend Mobility

  translates :display_name, backend: :table

  VALID_TYPES = %w[dietary_tag cuisine unit].freeze

  validates :reference_type, presence: true, inclusion: { in: VALID_TYPES }
  validates :key, presence: true, uniqueness: { scope: :reference_type }
  validates :display_name, presence: true

  scope :dietary_tags, -> { where(reference_type: 'dietary_tag') }
  scope :cuisines, -> { where(reference_type: 'cuisine') }
  scope :active, -> { where(active: true) }
end
```

---

## Mobility Translation System

**Purpose:** Store dynamic recipe content translations across 6 non-English languages via dedicated database tables.

### Translation Tables

**Pattern:** Each translatable model has dedicated translation table

```
Recipe ‚Üí RecipeTranslation (recipe_id, locale, name)
IngredientGroup ‚Üí IngredientGroupTranslation (ingredient_group_id, locale, name)
RecipeIngredient ‚Üí RecipeIngredientTranslation (recipe_ingredient_id, locale, ingredient_name, preparation_notes)
RecipeStep ‚Üí RecipeStepTranslation (recipe_step_id, locale, instruction_original, instruction_easier, instruction_no_equipment)
Equipment ‚Üí EquipmentTranslation (equipment_id, locale, canonical_name)
DataReference ‚Üí DataReferenceTranslation (data_reference_id, locale, display_name)
```

**Constraint:** `UNIQUE(entity_id, locale)` for each table

**Foreign Keys:** BIGINT primary keys with ON DELETE CASCADE

### Mobility Configuration

**Location:** `config/initializers/mobility.rb`

**Backend:** Table

**Plugins:** active_record, reader, writer, query, fallbacks, locale_accessors, presence, dirty, cache, backend_reader

**Fallback Chain:**
```
ja ‚Üí en
ko ‚Üí en
zh-tw ‚Üí zh-cn ‚Üí en
zh-cn ‚Üí zh-tw ‚Üí en
es ‚Üí en
fr ‚Üí en
```

### Reading Translations

**In specific locale:**
```ruby
recipe = Recipe.find(id)
I18n.with_locale(:ja) { recipe.name }  # Japanese translation
```

**With fallback:**
```ruby
I18n.with_locale(:ja) { recipe.name }
# Returns Japanese if exists, else fallback chain
```

### Writing Translations

**In code:**
```ruby
recipe = Recipe.find(id)
I18n.with_locale(:ja) { recipe.update(name: '„É¨„Ç∑„Éî') }
```

**Via TranslateRecipeJob (automatic on recipe creation):**
Enqueues background job that translates all 6 non-English languages via AI (Claude API).

### Querying Translations

**Query in specific locale:**
```ruby
I18n.with_locale(:ja) do
  Recipe.i18n.where(name: '„É¨„Ç∑„Éî')
end
```

### API Integration

**Query parameter:** `?lang=ja`

**Response:** All translatable fields contain translations for that locale (with fallbacks)

**Example:**
```
GET /api/v1/recipes/:id?lang=ja

{
  "id": "...",
  "name": "„É¨„Ç∑„Éî",
  "ingredient_groups": [
    { "name": "„É°„Ç§„É≥ÊùêÊñô", "items": [...] }
  ],
  "steps": [...],
  "equipment": [...]
}
```

### N+1 Query Prevention

Always eager-load translations when fetching multiple recipes:

```ruby
recipes = Recipe
  .includes(ingredient_groups: :recipe_ingredients)
  .includes(:recipe_steps, :equipment)
  .all
```

---

## File Storage (Active Storage)

Rails Active Storage manages recipe image uploads with support for local and S3 storage backends.

### Configuration

**Storage Location:** `config/storage.yml`

**Environment Configuration:**
- **Development/Test:** Disk storage (local filesystem)
- **Production:** Amazon S3

### Image Upload Flow

1. Admin uploads image via RecipeForm
2. Active Storage creates `active_storage_blobs` record with file metadata
3. Active Storage creates `active_storage_attachments` record linking blob to recipe
4. File is stored in configured storage backend (local disk or S3)
5. Signed URL is generated for secure file access
6. API returns `image_url` in recipe JSON responses

### Model Integration

**Recipe Model:**
```ruby
has_one_attached :image

validates :image,
  content_type: ['image/png', 'image/jpg', 'image/jpeg', 'image/gif', 'image/webp'],
  size: { less_than: 10.megabytes }
```

### Image Requirements

- **Required:** Yes (all recipes must have an image)
- **Formats:** PNG, JPG/JPEG, GIF, WebP
- **Maximum Size:** 10 MB
- **Stored As:** Active Storage blob with polymorphic attachment

### URL Generation

Images are served via signed Active Storage URLs:

```ruby
recipe.image.attached? ? rails_blob_url(recipe.image) : nil
```

**Example URL Format:**
```
/rails/active_storage/blobs/:signed_id/:filename
https://example.com/rails/active_storage/blobs/eyJfcmFpbHMi...--abc123/image.jpg
```

**Security:** Signed URLs prevent unauthorized direct file access and expire automatically.

### Storage Backend Details

**Local Storage (Development):**
- Files stored in `storage/` directory
- Useful for local development without AWS account

**S3 Storage (Production):**
- Credentials via environment variables: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION`, `AWS_BUCKET`
- Files uploaded to configured S3 bucket
- CloudFront CDN recommended for production

### Database Tables

Three Active Storage tables manage file storage:

1. **`active_storage_blobs`** - File metadata and storage keys
2. **`active_storage_attachments`** - Polymorphic link between files and models
3. **`active_storage_variant_records`** - Pre-generated image variants (future use)

See [Database Architecture](./database-architecture.md#active-storage-tables-file-storage) for detailed schema.

---

## API Structure

**Auth:**
```
POST /api/v1/auth/sign_up
POST /api/v1/auth/sign_in ‚Üí JWT token
DELETE /api/v1/auth/sign_out
```

**Organization:**
```
app/controllers/api/v1/
‚îú‚îÄ‚îÄ auth/ (auth)
‚îú‚îÄ‚îÄ admin/ (admin-only)
‚îÇ   ‚îú‚îÄ‚îÄ recipes_controller.rb
‚îÇ   ‚îú‚îÄ‚îÄ data_references_controller.rb
‚îÇ   ‚îú‚îÄ‚îÄ ai_prompts_controller.rb
‚îÇ   ‚îî‚îÄ‚îÄ ingredients_controller.rb
‚îî‚îÄ‚îÄ recipes_controller.rb (public)
   favorites_controller.rb
   notes_controller.rb
```

**Conventions:**
- Versioning: `/api/v1/...`
- Auth: JWT Bearer token in `Authorization` header
- Errors: `{ error: "message" }` with HTTP status
- i18n: `Accept-Language` header for localized messages
- Filtering: Query params (`?dietary_tags[]=vegan`)
- Pagination: `page`, `per_page` (default: 20)
- Locale: `?lang=ja` query param for translated responses

**See:** [api-reference.md](api-reference.md) for complete endpoint documentation (50+ endpoints)

---

## Services Layer

### RecipeScaler Service
Handles recipe scaling by servings with ingredient adjustments. See: acceptance-criteria.md (AC-SCALE-001 to AC-SCALE-012)

### NutritionCalculator Service
Calculates nutritional content from ingredients.

### RecipeTranslator Service
Generates translations for recipe content via Claude API. Used by TranslateRecipeJob.

---

## Background Jobs

### TranslateRecipeJob
**Trigger:** Recipe creation or update (via `after_commit` callbacks)

**Process:**
1. Load recipe with eager-loaded associations
2. Instantiate RecipeTranslator
3. For each language [ja, ko, zh-tw, zh-cn, es, fr]:
   - Translate via Claude API
   - Store in Mobility translation tables via I18n.with_locale
4. Set recipe.translations_completed = true

**Queue:** default (SolidQueue)

**Retry:** On error, logs and re-raises for SolidQueue retry

### Recipe Translation Callbacks

**Location:** `app/models/recipe.rb`

**Callbacks:**
```ruby
after_commit :enqueue_translation_on_create, on: :create
after_commit :enqueue_translation_on_update, on: :update
```

**Create callback behavior:**
- Immediately enqueue `TranslateRecipeJob.perform_later(id)`
- No rate limiting
- No deduplication check

**Update callback behavior:**
1. Check for existing translation jobs: `has_translation_job_with_recipe_id?`
2. If existing job found:
   - Check if job is running: `has_running_translation_job?`
   - If NOT running: Delete pending job via `delete_pending_translation_job`
   - If running: Keep running job (never interrupt)
3. Schedule new job: `schedule_translation_at_next_available_time`
4. Apply rate limiting (4 translations per recipe per hour, rolling window)
5. If rate limited: Schedule with delay
6. If not rate limited: Schedule immediately

**SolidQueue integration:**
- Queries `solid_queue_jobs` table for job detection
- Queries `solid_queue_claimed_executions` to detect running jobs
- Uses JSONB `arguments` field to filter by recipe ID
- Safe error handling when SolidQueue unavailable

---

# Frontend Architecture

## Vue 3 + Composition API + Vite

**Tech Stack:**
- Vue 3.5+ (Composition API, script setup syntax)
- TypeScript
- Vite (build tool)
- Vue Router (navigation)
- Pinia (state management)
- Vitest (unit testing)
- Playwright (E2E testing)
- Vue I18n v9 (static i18n)
- TailwindCSS (styling)

---

## Static UI Translation (Vue I18n)

### Overview

**System:** Vue I18n v9 (static YAML translations)

**Languages:** 7 (en, ja, ko, zh-tw, zh-cn, es, fr)

**Location:** `frontend/src/locales/` (JSON files)

### Supported Languages

| Language | Code | Native | UI |
|----------|------|--------|-----|
| English | `en` | English | Yes |
| Japanese | `ja` | Êó•Êú¨Ë™û | Yes |
| Korean | `ko` | ÌïúÍµ≠Ïñ¥ | Yes |
| Traditional Chinese | `zh-tw` | ÁπÅÈ´î‰∏≠Êñá | Yes |
| Simplified Chinese | `zh-cn` | ÁÆÄ‰Ωì‰∏≠Êñá | Yes |
| Spanish | `es` | Espa√±ol | Yes |
| French | `fr` | Fran√ßais | Yes |

### Locale File Structure

**Pattern:** Hierarchical JSON by feature/domain

**Example (`frontend/src/locales/en.json`):**
```json
{
  "common": {
    "buttons": { "save": "Save", "cancel": "Cancel" },
    "labels": { "name": "Name", "email": "Email" }
  },
  "navigation": { "home": "Home", "recipes": "Recipes" },
  "forms": {
    "recipe": { "title": "Recipe Title", "servings": "Servings" },
    "user": { "email": "Email", "password": "Password" }
  },
  "errors": {
    "validation": { "required": "This field is required", "invalid": "Invalid value" }
  }
}
```

### Key Naming

**Format:** camelCase

**Organization:**
- Group by feature/domain (recipe, user, navigation, etc.)
- Use hierarchical keys: `domain.category.specific`
- Reuse keys (don't duplicate same text)

**Good:** `forms.recipe.validation.titleRequired`
**Bad:** `msg1`, `error`, `btn`

### Using Translations

**In templates:**
```vue
{{ $t('common.buttons.save') }}
{{ $t('recipe.servings', { count: 4 }) }}
<input :placeholder="$t('forms.recipe.title')" />
```

**In script (Composition API):**
```typescript
import { useI18n } from 'vue-i18n'
const { t, locale } = useI18n()
const message = t('common.messages.success')
const isJapanese = locale.value === 'ja'
```

### Language Switching

**Component:** `LanguageSwitcher` (top-right of navbar)

**Flow:**
1. User selects language
2. Vue I18n `locale` updates
3. localStorage saved (key: `locale`)
4. All UI text updates immediately
5. Subsequent API requests include `Accept-Language` header

### Locale Detection

**On app init, in order:**
1. localStorage (`locale` key)
2. Browser language (`navigator.language`)
3. Default fallback (`en`)

**Configuration (`main.ts`):**
```typescript
const i18n = createI18n({
  legacy: false,
  locale: localStorage.getItem('locale') ||
          navigator.language.split('-')[0] ||
          'en',
  fallbackLocale: 'en',
  messages: { en, ja, ko, 'zh-tw': zhTw, 'zh-cn': zhCn, es, fr }
})
```

### Missing Translation Detection

**Console warning (dev mode):**
```
[i18n] Missing translation: "recipe.newKey" for locale "ja"
```

**Visual indicator:**
```
[recipe.newKey]  // Displays in brackets
```

### API Integration

**Axios client automatically sends `Accept-Language` header:**
```typescript
apiClient.interceptors.request.use((config) => {
  const locale = localStorage.getItem('locale') || 'en'
  config.headers['Accept-Language'] = locale
  return config
})
```

Backend receives header, returns localized error messages.

---

## Component Organization

**Location:** `frontend/src/components/`

**Pattern:**
```
components/
‚îú‚îÄ‚îÄ shared/           # Reusable components
‚îÇ   ‚îú‚îÄ‚îÄ LoadingSpinner.vue
‚îÇ   ‚îú‚îÄ‚îÄ ErrorMessage.vue
‚îÇ   ‚îú‚îÄ‚îÄ ConfirmDialog.vue
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ admin/            # Admin-only components
‚îú‚îÄ‚îÄ layout/           # Layout components
‚îú‚îÄ‚îÄ recipe/           # Recipe-specific components
‚îî‚îÄ‚îÄ user/             # User-specific components
```

**See:** [component-library.md](component-library.md) for complete documentation

---

## State Management (Pinia)

**Location:** `frontend/src/stores/`

**Pattern:** Feature-based stores

```
stores/
‚îú‚îÄ‚îÄ ui.ts             # UI state (language, theme, modal states)
‚îú‚îÄ‚îÄ recipe.ts         # Recipe state (list, current, edit)
‚îú‚îÄ‚îÄ user.ts           # User state (auth, profile)
‚îî‚îÄ‚îÄ ...
```

---

## Design System

**Token sources:** `frontend/src/styles/variables.css`

**Colors, spacing, fonts, breakpoints:** CSS variables

**Styling:** TailwindCSS + custom variables

---

## References

- **API Endpoints:** [api-reference.md](api-reference.md)
- **i18n Workflow:** [i18n-workflow.md](i18n-workflow.md)
- **Component Library:** [component-library.md](component-library.md)
- **Development Checklist:** [development-checklist.md](development-checklist.md)

```

## docs/new_claude/api-reference.md

```
# Recipe API Reference

---

## Table of Contents

- [Overview](#overview)
- [Authentication](#authentication)
  - [User Registration](#user-registration)
  - [User Login](#user-login)
  - [User Logout](#user-logout)
- [Public API](#public-api)
  - [Recipes](#recipes)
    - [List Recipes](#list-recipes)
    - [Get Recipe](#get-recipe)
    - [Scale Recipe](#scale-recipe)
  - [Favorites](#favorites)
    - [Add to Favorites](#add-to-favorites)
    - [Remove from Favorites](#remove-from-favorites)
    - [List Favorites](#list-favorites)
  - [Notes](#notes)
    - [Create Note](#create-note)
    - [List Recipe Notes](#list-recipe-notes)
    - [Update Note](#update-note)
    - [Delete Note](#delete-note)
  - [Data References](#data-references-public)
    - [Get Reference Data](#get-reference-data)
- [Admin API](#admin-api)
  - [Admin Recipes](#admin-recipes)
    - [List Admin Recipes](#list-admin-recipes)
    - [Get Admin Recipe](#get-admin-recipe)
    - [Create Recipe](#create-recipe)
    - [Update Recipe](#update-recipe)
    - [Delete Recipe](#delete-recipe)
    - [Parse Recipe from Text](#parse-recipe-from-text)
    - [Parse Recipe from URL](#parse-recipe-from-url)
    - [Parse Recipe from Image](#parse-recipe-from-image)
    - [Regenerate Variants](#regenerate-variants)
    - [Regenerate Translations](#regenerate-translations)
    - [Check Duplicates](#check-duplicates)
    - [Bulk Delete Recipes](#bulk-delete-recipes)
  - [Admin Data References](#admin-data-references)
    - [List Data References](#list-data-references)
    - [Get Data Reference](#get-data-reference)
    - [Create Data Reference](#create-data-reference)
    - [Update Data Reference](#update-data-reference)
    - [Delete Data Reference](#delete-data-reference)
    - [Activate Data Reference](#activate-data-reference)
    - [Deactivate Data Reference](#deactivate-data-reference)
  - [AI Prompts](#ai-prompts)
    - [List AI Prompts](#list-ai-prompts)
    - [Get AI Prompt](#get-ai-prompt)
    - [Create AI Prompt](#create-ai-prompt)
    - [Update AI Prompt](#update-ai-prompt)
    - [Delete AI Prompt](#delete-ai-prompt)
    - [Activate AI Prompt](#activate-ai-prompt)
    - [Test AI Prompt](#test-ai-prompt)
  - [Ingredients](#ingredients)
    - [List Ingredients](#list-ingredients)
    - [Get Ingredient](#get-ingredient)
    - [Create Ingredient](#create-ingredient)
    - [Update Ingredient](#update-ingredient)
    - [Delete Ingredient](#delete-ingredient)
    - [Refresh Nutrition Data](#refresh-nutrition-data)
- [Common Response Patterns](#common-response-patterns)
- [Error Codes Reference](#error-codes-reference)

---

## Locale-Aware API Responses

All recipe-related endpoints support multi-language responses using the `?lang` query parameter or `Accept-Language` header:

**Query Parameter:**
```
GET /api/v1/recipes/1?lang=ja
```

**Header:**
```
Accept-Language: ja
```

**Supported Languages:** en, ja, ko, zh-tw, zh-cn, es, fr

**Translation Source:**
- **Recipe Content** (name, ingredient names, step instructions): From Mobility translation tables (dynamic recipe translations)
- **UI Text** (field labels, buttons, messages): From Rails i18n backend

**Fallback Chain:**
- ja ‚Üí en
- ko ‚Üí en  
- zh-tw ‚Üí zh-cn ‚Üí en
- es ‚Üí en
- fr ‚Üí en

**Example - Japanese Response:**
```json
{
  "success": true,
  "data": {
    "recipe": {
      "id": 1,
      "name": "ÂíåÈ¢®„Çπ„ÉÜ„Éº„Ç≠",
      "ingredients": [
        {
          "ingredient_name": "ÁâõËÇâ",
          "amount": 400,
          "unit": "g"
        }
      ],
      "steps": [
        {
          "instruction_original": "ÁâõËÇâ„Çí„Éï„É©„Ç§„Éë„É≥„ÅßÁÑº„Åè"
        }
      ]
    }
  }
}
```

If translation unavailable, falls back to English automatically.

---


## Overview

The Recipe API is a RESTful API built with Ruby on Rails that provides endpoints for managing recipes, ingredients, user favorites, notes, and administrative functions. The API follows standard REST conventions and returns JSON responses.

### Base Configuration

- **Authentication**: JWT tokens via Devise
- **Content-Type**: `application/json`
- **Supported Languages**: en, ja, ko, zh-tw, zh-cn, es, fr
- **Pagination**: Default 20 items per page, max 100

### Common Headers

**Request Headers:**
```
Authorization: Bearer <jwt_token>
Content-Type: application/json
Accept: application/json
Accept-Language: en|ja|ko|zh-tw|zh-cn|es|fr
```

**Response Headers:**
```
Content-Type: application/json
```

---

## Authentication

All authentication endpoints use Devise with JWT strategy.

### User Registration

Create a new user account.

#### HTTP Method and Path

```
POST /api/v1/auth/sign_up
```

#### Authentication

- **Required**: No
- **Type**: None
- **Role Required**: N/A

#### Description

Creates a new user account with email and password. Upon successful registration, returns user data and a JWT token in the `Authorization` response header. The JWT token should be stored and included in subsequent authenticated requests.

#### Request Body

```json
{
  "user": {
    "email": "user@example.com",
    "password": "SecurePassword123!",
    "password_confirmation": "SecurePassword123!"
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `user.email` | String | Yes | Valid email format | User's email address |
| `user.password` | String | Yes | Min 6 characters | User's password |
| `user.password_confirmation` | String | Yes | Must match password | Password confirmation |

#### Response

##### Success (201 Created)

```json
{
  "success": true,
  "message": "Signed up successfully",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "role": "user"
    }
  }
}
```

**Response Headers:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

**Response Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `success` | Boolean | Always true for successful responses |
| `message` | String | Success message |
| `data.user.id` | Integer | User's unique identifier |
| `data.user.email` | String | User's email address |
| `data.user.role` | String | User's role (user or admin) |

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Registration failed",
  "errors": [
    "Email has already been taken",
    "Password is too short (minimum is 6 characters)"
  ]
}
```

#### Example Requests

##### cURL

```bash
curl -X POST http://localhost:3000/api/v1/auth/sign_up \
  -H "Content-Type: application/json" \
  -d '{
    "user": {
      "email": "user@example.com",
      "password": "SecurePassword123!",
      "password_confirmation": "SecurePassword123!"
    }
  }'
```

##### JavaScript (fetch)

```javascript
const response = await fetch('http://localhost:3000/api/v1/auth/sign_up', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    user: {
      email: 'user@example.com',
      password: 'SecurePassword123!',
      password_confirmation: 'SecurePassword123!'
    }
  })
})

const data = await response.json()
const token = response.headers.get('Authorization')
```

#### Notes

- JWT token is returned in the `Authorization` response header
- Store the token securely (localStorage, sessionStorage, or secure cookie)
- Token must be included in all authenticated requests
- Default role is `user`; admin role must be assigned directly in database

---

### User Login

Authenticate existing user and obtain JWT token.

#### HTTP Method and Path

```
POST /api/v1/auth/sign_in
```

#### Authentication

- **Required**: No
- **Type**: None
- **Role Required**: N/A

#### Description

Authenticates a user with email and password credentials. Returns user data and JWT token in the `Authorization` response header upon successful authentication.

#### Request Body

```json
{
  "user": {
    "email": "user@example.com",
    "password": "SecurePassword123!"
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `user.email` | String | Yes | User's email address |
| `user.password` | String | Yes | User's password |

#### Response

##### Success (200 OK)

```json
{
  "success": true,
  "message": "Logged in successfully",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "role": "user"
    }
  }
}
```

**Response Headers:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

##### Error Responses

**401 Unauthorized**
```json
{
  "success": false,
  "message": "Invalid email or password"
}
```

#### Example Requests

##### cURL

```bash
curl -X POST http://localhost:3000/api/v1/auth/sign_in \
  -H "Content-Type: application/json" \
  -d '{
    "user": {
      "email": "user@example.com",
      "password": "SecurePassword123!"
    }
  }'
```

##### JavaScript (fetch)

```javascript
const response = await fetch('http://localhost:3000/api/v1/auth/sign_in', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    user: {
      email: 'user@example.com',
      password: 'SecurePassword123!'
    }
  })
})

const data = await response.json()
const token = response.headers.get('Authorization')
// Store token for subsequent requests
localStorage.setItem('authToken', token)
```

#### Notes

- JWT token is returned in the `Authorization` response header
- Token should be stored and included in subsequent authenticated requests
- Generic error messages prevent user enumeration attacks

---

### User Logout

Invalidate JWT token and log out user.

#### HTTP Method and Path

```
DELETE /api/v1/auth/sign_out
```

#### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user

#### Description

Logs out the current user by invalidating their JWT token. The token is added to a denylist and can no longer be used for authentication.

#### Request Parameters

None. Authentication token must be provided in the `Authorization` header.

#### Response

##### Success (200 OK)

```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

##### Error Responses

**401 Unauthorized**
```json
{
  "success": false,
  "message": "User not authenticated"
}
```

#### Example Requests

##### cURL

```bash
curl -X DELETE http://localhost:3000/api/v1/auth/sign_out \
  -H "Authorization: Bearer YOUR_TOKEN"
```

##### JavaScript (fetch)

```javascript
const token = localStorage.getItem('authToken')

const response = await fetch('http://localhost:3000/api/v1/auth/sign_out', {
  method: 'DELETE',
  headers: {
    'Authorization': token
  }
})

const data = await response.json()
// Clear stored token
localStorage.removeItem('authToken')
```

#### Notes

- Token is immediately invalidated and cannot be reused
- Client should remove stored token after logout
- Attempting to use token after logout will result in 401 errors

---

## Public API

### Recipes

#### List Recipes

Get a paginated list of recipes with optional filtering and search.

##### HTTP Method and Path

```
GET /api/v1/recipes
```

##### Authentication

- **Required**: No
- **Type**: None
- **Role Required**: N/A

##### Description

Returns a paginated list of recipes. Supports two search modes:

1. **Basic Search**: Simple filtering by name, dietary tags, cuisines, dish types, and time constraints
2. **Advanced Search**: Includes nutrition filtering, ingredient inclusion/exclusion, and serving size constraints

The API automatically detects which mode to use based on the parameters provided.

##### Query Parameters

**Basic Search Parameters:**

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `page` | Integer | No | 1 | Page number for pagination |
| `per_page` | Integer | No | 20 | Items per page (max 100) |
| `q` | String | No | - | Search query for recipe names (case-insensitive) |
| `dietary_tags` | String | No | - | Comma-separated dietary tags (OR logic) |
| `cuisines` | String | No | - | Comma-separated cuisines (OR logic) |
| `max_cook_time` | Integer | No | - | Maximum cook time in minutes |
| `max_prep_time` | Integer | No | - | Maximum prep time in minutes |
| `max_total_time` | Integer | No | - | Maximum total time in minutes |
| `difficulty_level` | String | No | - | Filter recipes by difficulty level. Values: easy, medium, hard |

**Advanced Search Parameters:**

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `ingredient` | String | No | - | Include recipes with this ingredient |
| `exclude_ingredients` | String | No | - | Exclude recipes with these ingredients (comma-separated) |
| `min_calories` | Integer | No | - | Minimum calories per serving |
| `max_calories` | Integer | No | - | Maximum calories per serving |
| `min_protein` | Integer | No | - | Minimum protein in grams |
| `max_carbs` | Integer | No | - | Maximum carbs in grams |
| `max_fat` | Integer | No | - | Maximum fat in grams |
| `min_servings` | Integer | No | - | Minimum servings |
| `max_servings` | Integer | No | - | Maximum servings |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipes": [
      {
        "id": 1,
        "name": "Taiwanese Beef Noodle Soup",
        "description": "A rich and aromatic beef noodle soup from Taiwan featuring tender braised beef, chewy noodles, and a deeply flavorful broth infused with star anise and Sichuan peppercorns.",
        "language": "en",
        "image_url": "https://example.com/rails/active_storage/blobs/eyJfcmFpbHMi...--abc123/beef-noodle-soup.jpg",
        "servings": 4,
        "timing": {
          "prep_minutes": 30,
          "cook_minutes": 150,
          "total_minutes": 180
        },
        "dietary_tags": ["gluten-free-adaptable"],
        "cuisines": ["taiwanese", "chinese"],
        "source_url": "https://example.com/recipe",
        "difficulty_level": "medium",
        "translations_completed": true,
        "last_translated_at": "2025-10-09T10:00:00Z",
        "created_at": "2025-10-09T12:00:00Z",
        "updated_at": "2025-10-09T12:00:00Z"
      }
    ],
    "pagination": {
      "current_page": 1,
      "per_page": 20,
      "total_count": 45,
      "total_pages": 3
    }
  }
}
```

##### Example Requests

###### cURL (Basic Search)

```bash
curl -X GET "http://localhost:3000/api/v1/recipes?q=soup&cuisines=taiwanese,chinese&max_total_time=240" \
  -H "Accept: application/json"
```

###### cURL (Advanced Search)

```bash
curl -X GET "http://localhost:3000/api/v1/recipes?ingredient=beef&exclude_ingredients=pork,chicken&max_calories=500" \
  -H "Accept: application/json"
```

###### JavaScript (fetch)

```javascript
const params = new URLSearchParams({
  page: 1,
  per_page: 20,
  q: 'soup',
  cuisines: 'taiwanese,chinese',
  max_total_time: 240
})

const response = await fetch(`http://localhost:3000/api/v1/recipes?${params}`)
const data = await response.json()
```

##### Notes

- Results are ordered by creation date (newest first)
- Advanced search is triggered automatically when nutrition or ingredient parameters are present
- Multiple values for dietary_tags and cuisines use OR logic
- Search is case-insensitive

##### Related Endpoints

- [Get Recipe](#get-recipe)
- [Scale Recipe](#scale-recipe)

---

#### Get Recipe

Get detailed information about a specific recipe.

##### HTTP Method and Path

```
GET /api/v1/recipes/:id
```

##### Authentication

- **Required**: No
- **Type**: None
- **Role Required**: N/A

##### Description

Returns complete recipe details including ingredients, steps, equipment, nutrition information, and translations.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe": {
      "id": 1,
      "name": "Taiwanese Beef Noodle Soup",
      "description": "A rich and aromatic beef noodle soup from Taiwan featuring tender braised beef, chewy noodles, and a deeply flavorful broth infused with star anise and Sichuan peppercorns.",
      "source_language": "en",
      "image_url": "https://example.com/rails/active_storage/blobs/eyJfcmFpbHMi...--abc123/beef-noodle-soup.jpg",
      "servings_original": 4,
      "servings_min": 2,
      "servings_max": 8,
      "prep_minutes": 30,
      "cook_minutes": 150,
      "total_minutes": 180,
      "dietary_tags": ["gluten-free-adaptable"],
      "cuisines": ["taiwanese", "chinese"],
      "ingredient_groups": [
        {
          "id": 1,
          "name": "Broth",
          "position": 1,
          "recipe_ingredients": [
            {
              "id": 1,
              "ingredient_name": "beef bones",
              "amount": 2.0,
              "unit": "lbs",
              "position": 1,
              "preparation_notes": "preferably with marrow",
              "optional": false
            }
          ]
        }
      ],
      "recipe_steps": [
        {
          "id": 1,
          "step_number": 1,
          "instruction_original": "Blanch beef bones in boiling water for 5 minutes",
          "instruction_easier": "Boil beef bones",
          "instruction_no_equipment": null
        }
      ],
      "equipment": ["large pot", "knife", "cutting board"],
      "nutrition": {
        "calories": 450,
        "protein_g": 35,
        "carbs_g": 45,
        "fat_g": 15,
        "fiber_g": 3,
        "sodium_mg": 800,
        "sugar_g": 2
      },
      "requires_precision": false,
      "precision_reason": null,
      "difficulty_level": "medium",
      "source_url": "https://example.com/recipe",
      "admin_notes": "Popular traditional recipe",
      "variants_generated": true,
      "variants_generated_at": "2025-10-09T12:00:00Z",
      "translations_completed": false,
      "last_translated_at": null,
      "created_at": "2025-10-09T12:00:00Z",
      "updated_at": "2025-10-09T12:00:00Z"
    }
  }
}
```

##### Error Responses

**404 Not Found**
```json
{
  "success": false,
  "message": "Recipe not found"
}
```

##### Example Requests

###### cURL

```bash
curl -X GET http://localhost:3000/api/v1/recipes/1 \
  -H "Accept: application/json"
```

###### JavaScript (fetch)

```javascript
const recipeId = 1
const response = await fetch(`http://localhost:3000/api/v1/recipes/${recipeId}`)
const data = await response.json()
```

##### Notes

- Returns complete recipe data including all fields
- Translations object contains recipe data in other languages
- Nutrition values are per serving
- Equipment array lists all tools needed

##### Related Endpoints

- [List Recipes](#list-recipes)
- [Scale Recipe](#scale-recipe)

---

#### Scale Recipe

Calculate scaled ingredient amounts for different serving sizes.

##### HTTP Method and Path

```
POST /api/v1/recipes/:id/scale
```

##### Authentication

- **Required**: No
- **Type**: None
- **Role Required**: N/A

##### Description

Scales recipe ingredient amounts to a new serving size. Validates that the requested serving size is within the recipe's defined min/max range and returns proportionally adjusted ingredient amounts.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Request Body

```json
{
  "servings": 6
}
```

**Field Descriptions:**

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `servings` | Integer/Float | Yes | Within recipe min/max | Desired number of servings |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "original_servings": 4,
    "new_servings": 6,
    "scale_factor": 1.5,
    "scaled_ingredient_groups": [
      {
        "name": "Broth",
        "items": [
          {
            "ingredient": "beef bones",
            "amount": "3.0",
            "unit": "lbs",
            "notes": "preferably with marrow"
          }
        ]
      }
    ]
  }
}
```

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Servings must be between 2 and 8"
}
```

**404 Not Found**
```json
{
  "success": false,
  "message": "Recipe not found"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/api/v1/recipes/1/scale \
  -H "Content-Type: application/json" \
  -d '{"servings": 6}'
```

###### JavaScript (fetch)

```javascript
const response = await fetch('http://localhost:3000/api/v1/recipes/1/scale', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ servings: 6 })
})

const data = await response.json()
```

##### Notes

- Amounts are rounded to 2 decimal places
- Scale factor is calculated as: new_servings / original_servings
- Original ingredient structure is preserved
- Min/max serving constraints are enforced

##### Related Endpoints

- [Get Recipe](#get-recipe)
- [List Recipes](#list-recipes)

---

### Favorites

#### Add to Favorites

Add a recipe to the current user's favorites list.

##### HTTP Method and Path

```
POST /api/v1/recipes/:id/favorite
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user

##### Description

Adds a recipe to the current user's favorites. If the recipe is already favorited, returns success without creating a duplicate.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (201 Created or 200 OK)

```json
{
  "success": true,
  "data": {
    "favorited": true
  },
  "message": "Recipe added to favorites"
}
```

##### Error Responses

**401 Unauthorized**
```json
{
  "success": false,
  "message": "Unauthorized"
}
```

**404 Not Found**
```json
{
  "success": false,
  "message": "Recipe not found"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/api/v1/recipes/1/favorite \
  -H "Authorization: Bearer YOUR_TOKEN"
```

###### JavaScript (fetch)

```javascript
const response = await fetch('http://localhost:3000/api/v1/recipes/1/favorite', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`
  }
})

const data = await response.json()
```

##### Notes

- Idempotent operation - safe to call multiple times
- Returns 201 for new favorite, 200 if already favorited
- Requires user authentication

##### Related Endpoints

- [Remove from Favorites](#remove-from-favorites)
- [List Favorites](#list-favorites)

---

#### Remove from Favorites

Remove a recipe from the current user's favorites list.

##### HTTP Method and Path

```
DELETE /api/v1/recipes/:id/favorite
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user

##### Description

Removes a recipe from the current user's favorites list.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "favorited": false
  },
  "message": "Recipe removed from favorites"
}
```

##### Error Responses

**404 Not Found**
```json
{
  "success": false,
  "message": "Recipe not in favorites"
}
```

**401 Unauthorized**
```json
{
  "success": false,
  "message": "Unauthorized"
}
```

##### Example Requests

###### cURL

```bash
curl -X DELETE http://localhost:3000/api/v1/recipes/1/favorite \
  -H "Authorization: Bearer YOUR_TOKEN"
```

###### JavaScript (fetch)

```javascript
const response = await fetch('http://localhost:3000/api/v1/recipes/1/favorite', {
  method: 'DELETE',
  headers: {
    'Authorization': `Bearer ${token}`
  }
})

const data = await response.json()
```

##### Related Endpoints

- [Add to Favorites](#add-to-favorites)
- [List Favorites](#list-favorites)

---

#### List Favorites

Get the current user's favorite recipes.

##### HTTP Method and Path

```
GET /api/v1/users/me/favorites
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user

##### Description

Returns a paginated list of recipes that the current user has favorited, ordered by when they were favorited (most recent first).

##### Query Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `page` | Integer | No | 1 | Page number for pagination |
| `per_page` | Integer | No | 20 | Items per page (max 100) |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "favorites": [
      {
        "id": 1,
        "name": "Taiwanese Beef Noodle Soup",
        "language": "en",
        "servings": 4,
        "timing": {
          "prep_minutes": 30,
          "cook_minutes": 150,
          "total_minutes": 180
        },
        "dietary_tags": ["gluten-free-adaptable"],
        "cuisines": ["taiwanese", "chinese"],
        "source_url": "https://example.com/recipe",
        "difficulty_level": "medium",
        "translations_completed": true,
        "last_translated_at": "2025-10-09T10:00:00Z",
        "created_at": "2025-10-09T12:00:00Z",
        "updated_at": "2025-10-09T12:00:00Z",
        "favorited_at": "2025-10-09T14:30:00Z"
      }
    ],
    "pagination": {
      "current_page": 1,
      "per_page": 20,
      "total_count": 15,
      "total_pages": 1
    }
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET "http://localhost:3000/api/v1/users/me/favorites?page=1&per_page=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

###### JavaScript (fetch)

```javascript
const response = await fetch('http://localhost:3000/api/v1/users/me/favorites', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})

const data = await response.json()
```

##### Notes

- Recipes are ordered by favorited_at timestamp (newest first)
- Each recipe includes a `favorited_at` field showing when it was added to favorites
- Returns empty array if user has no favorites

##### Related Endpoints

- [Add to Favorites](#add-to-favorites)
- [Remove from Favorites](#remove-from-favorites)

---

### Notes

#### Create Note

Create a note for a specific recipe.

##### HTTP Method and Path

```
POST /api/v1/recipes/:recipe_id/notes
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user

##### Description

Creates a note attached to a recipe. Notes can be general recipe notes, step-specific notes, or ingredient-specific notes depending on the `note_type` and `note_target_id`.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `recipe_id` | Integer | Yes | Recipe's unique identifier |

##### Request Body

```json
{
  "note_type": "step",
  "note_target_id": "3",
  "note_text": "Use low heat to prevent burning"
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `note_type` | String | Yes | Type of note: "recipe", "step", or "ingredient" |
| `note_target_id` | String | No | ID of specific step/ingredient (null for recipe notes) |
| `note_text` | String | Yes | The note content |

##### Response

###### Success (201 Created)

```json
{
  "success": true,
  "data": {
    "note": {
      "id": 1,
      "recipe_id": 1,
      "note_type": "step",
      "note_target_id": "3",
      "note_text": "Use low heat to prevent burning",
      "created_at": "2025-10-09T14:30:00Z",
      "updated_at": "2025-10-09T14:30:00Z"
    }
  },
  "message": "Note created successfully"
}
```

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Failed to create note",
  "errors": ["Note text can't be blank"]
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/api/v1/recipes/1/notes \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "note_type": "step",
    "note_target_id": "3",
    "note_text": "Use low heat to prevent burning"
  }'
```

###### JavaScript (fetch)

```javascript
const response = await fetch('http://localhost:3000/api/v1/recipes/1/notes', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    note_type: 'step',
    note_target_id: '3',
    note_text: 'Use low heat to prevent burning'
  })
})

const data = await response.json()
```

##### Notes

- Notes are user-specific and private
- `note_target_id` should be null for general recipe notes
- For step notes, `note_target_id` is the step number
- For ingredient notes, `note_target_id` is the ingredient identifier

##### Related Endpoints

- [List Recipe Notes](#list-recipe-notes)
- [Update Note](#update-note)
- [Delete Note](#delete-note)

---

#### List Recipe Notes

Get all notes for a recipe (current user only).

##### HTTP Method and Path

```
GET /api/v1/recipes/:recipe_id/notes
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user

##### Description

Returns all notes created by the current user for a specific recipe, ordered by creation date (newest first).

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `recipe_id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "notes": [
      {
        "id": 1,
        "recipe_id": 1,
        "note_type": "step",
        "note_target_id": "3",
        "note_text": "Use low heat to prevent burning",
        "created_at": "2025-10-09T14:30:00Z",
        "updated_at": "2025-10-09T14:30:00Z"
      }
    ]
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET http://localhost:3000/api/v1/recipes/1/notes \
  -H "Authorization: Bearer YOUR_TOKEN"
```

##### Related Endpoints

- [Create Note](#create-note)
- [Update Note](#update-note)
- [Delete Note](#delete-note)

---

#### Update Note

Update an existing note.

##### HTTP Method and Path

```
PUT /api/v1/notes/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user (note owner only)

##### Description

Updates the text content of an existing note. Users can only update their own notes.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Note's unique identifier |

##### Request Body

```json
{
  "note_text": "Updated note content"
}
```

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "note": {
      "id": 1,
      "recipe_id": 1,
      "note_type": "step",
      "note_target_id": "3",
      "note_text": "Updated note content",
      "created_at": "2025-10-09T14:30:00Z",
      "updated_at": "2025-10-09T15:00:00Z"
    }
  },
  "message": "Note updated successfully"
}
```

##### Error Responses

**404 Not Found**
```json
{
  "success": false,
  "message": "Note not found or you do not have permission to modify it"
}
```

##### Example Requests

###### cURL

```bash
curl -X PUT http://localhost:3000/api/v1/notes/1 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"note_text": "Updated note content"}'
```

##### Related Endpoints

- [Create Note](#create-note)
- [List Recipe Notes](#list-recipe-notes)
- [Delete Note](#delete-note)

---

#### Delete Note

Delete a note.

##### HTTP Method and Path

```
DELETE /api/v1/notes/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Any authenticated user (note owner only)

##### Description

Permanently deletes a note. Users can only delete their own notes.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Note's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "deleted": true
  },
  "message": "Note deleted successfully"
}
```

##### Error Responses

**404 Not Found**
```json
{
  "success": false,
  "message": "Note not found or you do not have permission to modify it"
}
```

##### Example Requests

###### cURL

```bash
curl -X DELETE http://localhost:3000/api/v1/notes/1 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

##### Related Endpoints

- [Create Note](#create-note)
- [List Recipe Notes](#list-recipe-notes)
- [Update Note](#update-note)

---

### Data References (Public)

#### Get Reference Data

Get all active reference data for dropdown/filter options.

##### HTTP Method and Path

```
GET /api/v1/data_references
```

##### Authentication

- **Required**: No
- **Type**: None
- **Role Required**: N/A

##### Description

Returns all active reference data including dietary tags and cuisines. This data is used to populate filters, dropdowns, and tags throughout the application.

##### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `category` | String | No | Filter by specific category: dietary_tags or cuisines |

##### Response

###### Success (200 OK) - All Categories

```json
{
  "success": true,
  "data": {
    "dietary_tags": [
      { "key": "vegetarian", "display_name": "Vegetarian" },
      { "key": "vegan", "display_name": "Vegan" }
    ],
    "cuisines": [
      { "key": "italian", "display_name": "Italian" },
      { "key": "japanese", "display_name": "Japanese" }
    ]
  }
}
```

###### Success (200 OK) - Single Category

```json
{
  "success": true,
  "data": {
    "dietary_tags": [
      { "key": "vegetarian", "display_name": "Vegetarian" },
      { "key": "vegan", "display_name": "Vegan" }
    ]
  }
}
```

##### Error Responses

**400 Bad Request**
```json
{
  "success": false,
  "message": "Invalid category. Valid categories: dietary_tags, cuisines"
}
```

##### Example Requests

###### cURL (All Categories)

```bash
curl -X GET http://localhost:3000/api/v1/data_references
```

###### cURL (Single Category)

```bash
curl -X GET http://localhost:3000/api/v1/data_references?category=dietary_tags
```

###### JavaScript (fetch)

```javascript
// Get all reference data
const response = await fetch('http://localhost:3000/api/v1/data_references')
const data = await response.json()

// Get specific category
const dietaryResponse = await fetch('http://localhost:3000/api/v1/data_references?category=dietary_tags')
const dietaryData = await dietaryResponse.json()
```

##### Notes

- Only returns active reference data
- Keys are used internally and in API requests
- Display names are for UI presentation
- Reference data is cached and updated infrequently

##### Related Endpoints

- [List Data References (Admin)](#list-data-references)

---

## Admin API

All admin endpoints require authentication with admin role.

### Admin Recipes

#### List Admin Recipes

Get a paginated list of all recipes with admin-specific filters.

##### HTTP Method and Path

```
GET /admin/recipes
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Returns a paginated list of all recipes with admin metadata. Supports advanced filtering including inactive recipes, admin notes, and more granular search options.

##### Query Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `page` | Integer | No | 1 | Page number for pagination |
| `per_page` | Integer | No | 20 | Items per page (max 100) |
| `q` | String | No | - | Search by recipe name (case-insensitive) |
| `cuisines` | Array | No | - | Filter by multiple cuisines (AND logic) |
| `cuisine` | String | No | - | Legacy: Filter by single cuisine |
| `dietary_tag` | String | No | - | Filter by single dietary tag |
| `max_prep_time` | Integer | No | - | Maximum prep time in minutes |
| `difficulty_level` | String | No | - | Filter recipes by difficulty level. Values: easy, medium, hard |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipes": [
      {
        "id": 1,
        "name": "Taiwanese Beef Noodle Soup",
        "language": "en",
        "servings": {
          "original": 4,
          "min": 2,
          "max": 8
        },
        "timing": {
          "prep_minutes": 30,
          "cook_minutes": 150,
          "total_minutes": 180
        },
        "dietary_tags": ["gluten-free-adaptable"],
        "cuisines": ["taiwanese", "chinese"],
        "aliases": ["ÁâõËÇâÈ∫∫", "Niu Rou Mian"],
        "source_url": "https://example.com/recipe",
        "admin_notes": "Popular recipe, gets good engagement",
        "requires_precision": false,
        "precision_reason": null,
        "variants_generated": true,
        "variants_generated_at": "2025-10-08T10:00:00Z",
        "translations_completed": true,
        "last_translated_at": "2025-10-09T10:00:00Z",
        "created_at": "2025-10-09T12:00:00Z",
        "updated_at": "2025-10-09T12:00:00Z"
      }
    ],
    "pagination": {
      "current_page": 1,
      "per_page": 20,
      "total_count": 45,
      "total_pages": 3
    }
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET "http://localhost:3000/admin/recipes?cuisines[]=taiwanese&max_prep_time=60" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Returns all recipes including inactive ones (unlike public API)
- Includes admin-specific fields: admin_notes, variants_generated, translations_completed
- Multiple cuisines use AND logic (recipe must have all specified)
- Results ordered by creation date (newest first)

##### Related Endpoints

- [Get Admin Recipe](#get-admin-recipe)
- [Create Recipe](#create-recipe)
- [Update Recipe](#update-recipe)

---

#### Get Admin Recipe

Get complete recipe details with admin metadata.

##### HTTP Method and Path

```
GET /admin/recipes/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Returns complete recipe information including all fields, translations, and admin metadata.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe": {
      "id": 1,
      "name": "Taiwanese Beef Noodle Soup",
      "language": "en",
      "servings": {
        "original": 4,
        "min": 2,
        "max": 8
      },
      "timing": {
        "prep_minutes": 30,
        "cook_minutes": 150,
        "total_minutes": 180
      },
      "dietary_tags": ["gluten-free-adaptable"],
      "cuisines": ["taiwanese", "chinese"],
      "aliases": ["ÁâõËÇâÈ∫∫", "Niu Rou Mian"],
      "source_url": "https://example.com/recipe",
      "admin_notes": "Popular recipe, gets good engagement",
      "requires_precision": false,
      "precision_reason": null,
      "difficulty_level": "medium",
      "variants_generated": true,
      "variants_generated_at": "2025-10-08T10:00:00Z",
      "translations_completed": true,
      "last_translated_at": "2025-10-09T10:00:00Z",
      "created_at": "2025-10-09T12:00:00Z",
      "updated_at": "2025-10-09T12:00:00Z",
      "ingredient_groups": [],
      "steps": [],
      "equipment": [],
      "nutrition": {},
      "translations": {}
    }
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET http://localhost:3000/admin/recipes/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Related Endpoints

- [List Admin Recipes](#list-admin-recipes)
- [Update Recipe](#update-recipe)

---

#### Create Recipe

Manually create a new recipe (AC-ADMIN-001).

##### HTTP Method and Path

```
POST /admin/recipes
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Creates a new recipe manually. This is used for recipes that are created from scratch rather than parsed from external sources.

##### Request Body

```json
{
  "recipe": {
    "name": "Taiwanese Beef Noodle Soup",
    "source_language": "en",
    "requires_precision": false,
    "precision_reason": null,
    "source_url": "https://example.com/recipe",
    "admin_notes": "Popular traditional recipe",
    "difficulty_level": "medium",
    "servings_original": 4,
    "servings_min": 2,
    "servings_max": 8,
    "prep_minutes": 30,
    "cook_minutes": 150,
    "total_minutes": 180,
    "ingredient_groups_attributes": [
      {
        "name": "Broth",
        "position": 1,
        "recipe_ingredients_attributes": [
          {
            "ingredient_name": "beef bones",
            "amount": 2.0,
            "unit": "lbs",
            "position": 1,
            "preparation_notes": "preferably with marrow",
            "optional": false
          }
        ]
      }
    ],
    "recipe_steps_attributes": [
      {
        "step_number": 1,
        "instruction_original": "Blanch beef bones in boiling water for 5 minutes",
        "instruction_easier": "Boil beef bones",
        "instruction_no_equipment": null
      }
    ],
    "recipe_nutrition_attributes": {
      "calories": 450,
      "protein_g": 35,
      "carbs_g": 45,
      "fat_g": 15,
      "fiber_g": 3,
      "sodium_mg": 800,
      "sugar_g": 2
    },
    "recipe_aliases_attributes": [
      {"alias_name": "ÁâõËÇâÈ∫∫", "language": "zh-tw"},
      {"alias_name": "Niu Rou Mian", "language": "en"}
    ],
    "recipe_dietary_tags_attributes": [
      {"data_reference_id": 1}
    ],
    "recipe_cuisines_attributes": [
      {"data_reference_id": 2}
    ],
    "recipe_equipment_attributes": [
      {"equipment_id": 1, "optional": false}
    ]
  }
}
```

##### Response

###### Success (201 Created)

```json
{
  "success": true,
  "data": {
    "recipe": {
      "id": 1,
      "name": "Taiwanese Beef Noodle Soup",
      "language": "en"
    }
  },
  "message": "Recipe created successfully"
}
```

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Failed to create recipe",
  "errors": ["Name can't be blank"]
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/recipes \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "recipe": {
      "name": "Taiwanese Beef Noodle Soup",
      "language": "en"
    }
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-001
- Minimum required fields: name, source_language
- Servings and timing are now normalized columns (servings_original, servings_min, servings_max, prep_minutes, cook_minutes, total_minutes)
- difficulty_level is an optional string field with values: easy, medium, hard
- Nested attributes use Rails accepts_nested_attributes_for: ingredient_groups_attributes, recipe_steps_attributes, recipe_nutrition_attributes, etc.
- Use _destroy: true flag to delete nested records during updates
- DataReference arrays (dietary_tags, cuisines) reference data_reference_id

##### Related Endpoints

- [Update Recipe](#update-recipe)
- [Parse Recipe from Text](#parse-recipe-from-text)

---

#### Update Recipe

Update an existing recipe.

##### HTTP Method and Path

```
PUT /admin/recipes/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Updates an existing recipe. All fields are optional; only provided fields will be updated.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Request Body

Same structure as Create Recipe. All fields are optional.

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe": {
      "id": 1,
      "name": "Updated Recipe Name"
    }
  },
  "message": "Recipe updated successfully"
}
```

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Failed to update recipe",
  "errors": ["Name can't be blank"]
}
```

**404 Not Found**
```json
{
  "success": false,
  "message": "Recipe not found"
}
```

##### Example Requests

###### cURL

```bash
curl -X PUT http://localhost:3000/admin/recipes/1 \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "recipe": {
      "admin_notes": "Updated notes"
    }
  }'
```

##### Related Endpoints

- [Get Admin Recipe](#get-admin-recipe)
- [Create Recipe](#create-recipe)

---

#### Delete Recipe

Permanently delete a recipe.

##### HTTP Method and Path

```
DELETE /admin/recipes/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Permanently deletes a recipe and all associated data. This action cannot be undone.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "deleted": true
  },
  "message": "Recipe deleted successfully"
}
```

##### Error Responses

**404 Not Found**
```json
{
  "success": false,
  "message": "Recipe not found"
}
```

##### Example Requests

###### cURL

```bash
curl -X DELETE http://localhost:3000/admin/recipes/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- This is a destructive operation and cannot be undone
- Consider using bulk delete for multiple recipes

##### Related Endpoints

- [Bulk Delete Recipes](#bulk-delete-recipes)

---

#### Parse Recipe from Text

Parse recipe data from a text block (AC-ADMIN-002).

##### HTTP Method and Path

```
POST /admin/recipes/parse_text
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Parses a recipe from unstructured text using AI. The text can be in various formats (ingredient lists, instructions, etc.). Returns structured recipe data that can be reviewed and saved.

##### Request Body

```json
{
  "text_content": "Taiwanese Beef Noodle Soup\n\nIngredients:\n- 2 lbs beef bones\n- 1 lb beef shank\n\nInstructions:\n1. Blanch bones..."
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `text_content` | String | Yes | Unstructured recipe text to parse |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe_data": {
      "name": "Taiwanese Beef Noodle Soup",
      "ingredient_groups": [],
      "steps": [],
      "timing": {},
      "servings": {}
    }
  },
  "message": "Recipe parsed successfully"
}
```

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Failed to parse recipe from text",
  "errors": ["Could not extract valid recipe data"]
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/recipes/parse_text \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "text_content": "Taiwanese Beef Noodle Soup..."
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-002
- Uses RecipeParserService with AI
- Returns structured data for review before saving
- May not extract all fields accurately; review required

##### Related Endpoints

- [Parse Recipe from URL](#parse-recipe-from-url)
- [Parse Recipe from Image](#parse-recipe-from-image)
- [Create Recipe](#create-recipe)

---

#### Parse Recipe from URL

Parse recipe data from a URL (AC-ADMIN-003).

##### HTTP Method and Path

```
POST /admin/recipes/parse_url
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Fetches and parses a recipe from a URL. Supports various recipe websites and formats. Returns structured recipe data for review.

##### Request Body

```json
{
  "url": "https://example.com/recipes/beef-noodle-soup"
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `url` | String | Yes | URL of the recipe to parse |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe_data": {
      "name": "Taiwanese Beef Noodle Soup",
      "source_url": "https://example.com/recipes/beef-noodle-soup",
      "ingredient_groups": [],
      "steps": []
    }
  },
  "message": "Recipe parsed successfully from URL"
}
```

##### Error Responses

**500 Internal Server Error**
```json
{
  "success": false,
  "message": "Failed to fetch or parse URL",
  "errors": ["Connection timeout"]
}
```

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Failed to parse recipe from URL",
  "errors": ["Could not extract valid recipe data"]
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/recipes/parse_url \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://example.com/recipes/beef-noodle-soup"
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-003, AC-ADMIN-003-A, AC-ADMIN-003-B
- Uses RecipeParserService with two-tier approach:
  1. **Primary**: AI direct access (Claude fetches URL directly)
  2. **Fallback**: Web scraping with Nokogiri if AI cannot access
- Automatically includes source_url in parsed data
- Review parsed data before saving as accuracy varies by source
- Typical processing time: 10-30 seconds depending on method used

##### Related Endpoints

- [Parse Recipe from Text](#parse-recipe-from-text)
- [Parse Recipe from Image](#parse-recipe-from-image)

---

#### Parse Recipe from Image

Parse recipe data from an image (AC-ADMIN-004).

##### HTTP Method and Path

```
POST /admin/recipes/parse_image
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Parses a recipe from an image using OCR and AI. Supports both file uploads and image URLs.

##### Request Parameters

**Option 1: File Upload**

Send multipart/form-data with `image_file` parameter.

**Option 2: Image URL**

```json
{
  "image_url": "https://example.com/recipe-image.jpg"
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `image_file` | File | No* | Image file to parse (* required if image_url not provided) |
| `image_url` | String | No* | URL to image (* required if image_file not provided) |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe_data": {
      "name": "Taiwanese Beef Noodle Soup",
      "ingredient_groups": [],
      "steps": []
    }
  },
  "message": "Recipe parsed successfully from image"
}
```

##### Error Responses

**400 Bad Request**
```json
{
  "success": false,
  "message": "Image file or URL required",
  "errors": ["Provide either image_file or image_url parameter"]
}
```

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Failed to parse recipe from image",
  "errors": ["Could not extract valid recipe data"]
}
```

##### Example Requests

###### cURL (File Upload)

```bash
curl -X POST http://localhost:3000/admin/recipes/parse_image \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -F "image_file=@/path/to/recipe.jpg"
```

###### cURL (Image URL)

```bash
curl -X POST http://localhost:3000/admin/recipes/parse_image \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "https://example.com/recipe-image.jpg"
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-004
- Uses RecipeParserService with OCR and AI
- Temporary files are cleaned up after processing
- Image quality significantly affects parsing accuracy
- Review parsed data carefully before saving

##### Related Endpoints

- [Parse Recipe from Text](#parse-recipe-from-text)
- [Parse Recipe from URL](#parse-recipe-from-url)

---

#### Regenerate Variants

Regenerate easier/no-equipment step variants (AC-ADMIN-007).

##### HTTP Method and Path

```
POST /admin/recipes/:id/regenerate_variants
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Queues regeneration of recipe step variants including easier versions and no-equipment alternatives.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe": {
      "id": 1,
      "variants_generated": true,
      "variants_generated_at": "2025-10-09T15:00:00Z"
    }
  },
  "message": "Step variants regeneration queued"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/recipes/1/regenerate_variants \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Acceptance Criteria: AC-ADMIN-007
- Currently marks as queued; actual generation service to be implemented
- Variants include easier methods and equipment-free alternatives

##### Related Endpoints

- [Regenerate Translations](#regenerate-translations)

---

#### Regenerate Translations

Regenerate recipe translations (AC-ADMIN-008).

##### HTTP Method and Path

```
POST /admin/recipes/:id/regenerate_translations
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Manually triggers translation regeneration for a recipe, bypassing rate limiting and deduplication.

**Behavior:**
- Bypasses rate limiting (4 translations per hour)
- Bypasses deduplication (does not check for existing jobs)
- Directly enqueues `TranslateRecipeJob.perform_later(recipe.id)`
- Always enqueues immediately

**Use case:** Manual rerun when translations need regeneration

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Recipe's unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "recipe": {
      "id": 1,
      "translations_completed": false,
      "last_translated_at": null
    }
  },
  "message": "Translation regeneration queued"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/recipes/1/regenerate_translations \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Acceptance Criteria: AC-ADMIN-008, AC-PHASE5-MANUAL-001, AC-PHASE5-MANUAL-002
- Bypasses auto-triggered translation constraints (rate limiting, deduplication)
- Enqueues job immediately regardless of recent translation history

##### Related Endpoints

- [Regenerate Variants](#regenerate-variants)

---

#### Check Duplicates

Check for duplicate recipes by name and aliases (AC-ADMIN-005, AC-ADMIN-006).

##### HTTP Method and Path

```
POST /admin/recipes/check_duplicates
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Searches for existing recipes that might be duplicates based on fuzzy name matching and exact alias matching. Useful before creating a new recipe.

##### Request Body

```json
{
  "name": "Taiwanese Beef Noodle Soup",
  "aliases": ["ÁâõËÇâÈ∫∫", "Niu Rou Mian"]
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | String | Yes | Recipe name to check |
| `aliases` | Array<String> | No | Alternative names to check |

##### Response

###### Success (200 OK) - Duplicates Found

```json
{
  "success": true,
  "data": {
    "has_duplicates": true,
    "similar_recipes": [
      {
        "id": 5,
        "name": "Taiwan Beef Noodle Soup",
        "aliases": ["ÁâõËÇâÈ∫∫"],
        "created_at": "2025-10-01T10:00:00Z"
      }
    ]
  }
}
```

###### Success (200 OK) - No Duplicates

```json
{
  "success": true,
  "data": {
    "has_duplicates": false,
    "similar_recipes": []
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/recipes/check_duplicates \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Taiwanese Beef Noodle Soup",
    "aliases": ["ÁâõËÇâÈ∫∫", "Niu Rou Mian"]
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-005, AC-ADMIN-006
- Uses fuzzy matching with 85% similarity threshold for names
- Uses exact matching for aliases
- Returns all matches found by either method

##### Related Endpoints

- [Create Recipe](#create-recipe)

---

#### Bulk Delete Recipes

Delete multiple recipes at once (AC-ADMIN-009).

##### HTTP Method and Path

```
DELETE /admin/recipes/bulk_delete
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Permanently deletes multiple recipes in a single operation. This action cannot be undone.

##### Request Body

```json
{
  "recipe_ids": [1, 2, 3, 4, 5]
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `recipe_ids` | Array<Integer> | Yes | Array of recipe IDs to delete |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "deleted_count": 5
  },
  "message": "5 recipe(s) deleted successfully"
}
```

##### Error Responses

**400 Bad Request**
```json
{
  "success": false,
  "message": "recipe_ids must be an array"
}
```

##### Example Requests

###### cURL

```bash
curl -X DELETE http://localhost:3000/admin/recipes/bulk_delete \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "recipe_ids": [1, 2, 3, 4, 5]
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-009
- This is a destructive operation and cannot be undone
- Returns count of actually deleted recipes
- Non-existent IDs are silently ignored

##### Related Endpoints

- [Delete Recipe](#delete-recipe)

---

### Admin Data References

#### List Data References

Get all data references with optional filtering.

##### HTTP Method and Path

```
GET /admin/data_references
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Returns all data references (dietary tags, cuisines, etc.) with admin metadata including inactive entries.

##### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `reference_type` | String | No | Filter by type: dietary_tag, cuisine, unit |
| `active` | String | No | Filter by active status: "true" or "false" |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "data_references": [
      {
        "id": 1,
        "reference_type": "dietary_tag",
        "key": "vegetarian",
        "display_name": "Vegetarian",
        "active": true,
        "sort_order": 1,
        "metadata": {
          "icon": "leaf",
          "color": "green"
        },
        "created_at": "2025-10-09T12:00:00Z",
        "updated_at": "2025-10-09T12:00:00Z"
      }
    ]
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET "http://localhost:3000/admin/data_references?reference_type=dietary_tag&active=true" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Returns both active and inactive references (unlike public API)
- Results ordered by reference_type then key
- Metadata field contains type-specific additional information

##### Related Endpoints

- [Create Data Reference](#create-data-reference)
- [Update Data Reference](#update-data-reference)

---

#### Get Data Reference

Get a single data reference.

##### HTTP Method and Path

```
GET /admin/data_references/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Data reference unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "data_reference": {
      "id": 1,
      "reference_type": "dietary_tag",
      "key": "vegetarian",
      "display_name": "Vegetarian",
      "active": true,
      "sort_order": 1,
      "metadata": {},
      "created_at": "2025-10-09T12:00:00Z",
      "updated_at": "2025-10-09T12:00:00Z"
    }
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET http://localhost:3000/admin/data_references/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

---

#### Create Data Reference

Create a new data reference.

##### HTTP Method and Path

```
POST /admin/data_references
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Request Body

```json
{
  "data_reference": {
    "reference_type": "dietary_tag",
    "key": "keto",
    "display_name": "Keto Friendly",
    "active": true,
    "sort_order": 10,
    "metadata": {
      "icon": "bolt",
      "color": "purple"
    }
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reference_type` | String | Yes | Type: dietary_tag, cuisine, unit |
| `key` | String | Yes | Unique key (lowercase, hyphenated) |
| `display_name` | String | Yes | Human-readable name |
| `active` | Boolean | No | Whether active (default: true) |
| `sort_order` | Integer | No | Display order (default: 0) |
| `metadata` | Object | No | Additional type-specific data |

##### Response

###### Success (201 Created)

```json
{
  "success": true,
  "data": {
    "data_reference": {
      "id": 25,
      "reference_type": "dietary_tag",
      "key": "keto"
    }
  },
  "message": "Data reference created successfully"
}
```

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "Failed to create data reference",
  "errors": ["Key has already been taken"]
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/data_references \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "data_reference": {
      "reference_type": "dietary_tag",
      "key": "keto",
      "display_name": "Keto Friendly"
    }
  }'
```

##### Notes

- Key must be unique within the system
- Keys should be lowercase with hyphens
- Metadata structure varies by reference_type

---

#### Update Data Reference

Update an existing data reference (AC-ADMIN-012).

##### HTTP Method and Path

```
PUT /admin/data_references/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Updates a data reference. Changes cascade to all recipes using this reference.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Data reference unique identifier |

##### Request Body

Same structure as Create Data Reference. All fields optional.

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "data_reference": {
      "id": 1,
      "display_name": "Updated Name"
    }
  },
  "message": "Data reference updated successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X PUT http://localhost:3000/admin/data_references/1 \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "data_reference": {
      "display_name": "Updated Name"
    }
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-012
- Changes to key or display_name affect all recipes using this reference
- Consider checking recipe usage before major changes

---

#### Delete Data Reference

Permanently delete a data reference.

##### HTTP Method and Path

```
DELETE /admin/data_references/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "deleted": true
  },
  "message": "Data reference deleted successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X DELETE http://localhost:3000/admin/data_references/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Consider deactivating instead of deleting
- Deletion may affect existing recipes using this reference

---

#### Activate Data Reference

Activate a deactivated data reference.

##### HTTP Method and Path

```
POST /admin/data_references/:id/activate
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Data reference unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "data_reference": {
      "id": 1,
      "active": true
    }
  },
  "message": "Data reference activated successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/data_references/1/activate \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Related Endpoints

- [Deactivate Data Reference](#deactivate-data-reference)

---

#### Deactivate Data Reference

Deactivate a data reference (AC-ADMIN-013).

##### HTTP Method and Path

```
POST /admin/data_references/:id/deactivate
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Deactivates a data reference. Inactive references are hidden from public API but existing recipe associations remain.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Data reference unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "data_reference": {
      "id": 1,
      "active": false
    }
  },
  "message": "Data reference deactivated successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/data_references/1/deactivate \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Acceptance Criteria: AC-ADMIN-013
- Deactivated references don't appear in public API
- Existing recipe associations are preserved
- Can be reactivated later

##### Related Endpoints

- [Activate Data Reference](#activate-data-reference)

---

### AI Prompts

#### List AI Prompts

Get all AI prompts with optional filtering.

##### HTTP Method and Path

```
GET /admin/ai_prompts
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Returns all AI prompts used throughout the system for various features.

##### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `prompt_type` | String | No | Filter by type: system or user |
| `active` | String | No | Filter by active status: "true" or "false" |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ai_prompts": [
      {
        "id": 1,
        "prompt_key": "recipe_translation_system",
        "prompt_type": "system",
        "feature_area": "translation",
        "prompt_text": "You are a professional recipe translator...",
        "description": "System prompt for recipe translation",
        "active": true,
        "version": "1.0",
        "variables": ["target_language", "source_language"],
        "created_at": "2025-10-09T12:00:00Z",
        "updated_at": "2025-10-09T12:00:00Z"
      }
    ]
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET "http://localhost:3000/admin/ai_prompts?prompt_type=system&active=true" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Results ordered by creation date (newest first)
- Variables array lists placeholders used in prompt_text
- Only one prompt per feature_area should be active at a time

##### Related Endpoints

- [Create AI Prompt](#create-ai-prompt)
- [Test AI Prompt](#test-ai-prompt)

---

#### Get AI Prompt

Get a single AI prompt.

##### HTTP Method and Path

```
GET /admin/ai_prompts/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | AI prompt unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ai_prompt": {
      "id": 1,
      "prompt_key": "recipe_translation_system",
      "prompt_type": "system",
      "feature_area": "translation",
      "prompt_text": "You are a professional recipe translator...",
      "description": "System prompt for recipe translation",
      "active": true,
      "version": "1.0",
      "variables": ["target_language", "source_language"],
      "created_at": "2025-10-09T12:00:00Z",
      "updated_at": "2025-10-09T12:00:00Z"
    }
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET http://localhost:3000/admin/ai_prompts/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

---

#### Create AI Prompt

Create a new AI prompt (AC-ADMIN-014).

##### HTTP Method and Path

```
POST /admin/ai_prompts
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Request Body

```json
{
  "ai_prompt": {
    "prompt_key": "recipe_translation_user",
    "prompt_type": "user",
    "feature_area": "translation",
    "prompt_text": "Translate this recipe to {{target_language}}:\n\n{{recipe_content}}",
    "description": "User prompt for translating recipes",
    "active": false,
    "version": "1.0",
    "variables": ["target_language", "recipe_content"]
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `prompt_key` | String | Yes | Unique identifier for the prompt |
| `prompt_type` | String | Yes | Type: system or user |
| `feature_area` | String | Yes | Feature: translation, recipe_parsing, step_variants, etc. |
| `prompt_text` | String | Yes | The prompt template with {{variable}} placeholders |
| `description` | String | No | Human-readable description |
| `active` | Boolean | No | Whether active (default: false) |
| `version` | String | No | Version string |
| `variables` | Array<String> | No | List of variables used in prompt_text |

##### Response

###### Success (201 Created)

```json
{
  "success": true,
  "data": {
    "ai_prompt": {
      "id": 5,
      "prompt_key": "recipe_translation_user"
    }
  },
  "message": "AI prompt created successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/ai_prompts \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ai_prompt": {
      "prompt_key": "new_prompt",
      "prompt_type": "system",
      "feature_area": "translation",
      "prompt_text": "You are a translator..."
    }
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-014
- Use `{{variable_name}}` format for placeholders
- New prompts default to inactive
- Use activate endpoint to enable

##### Related Endpoints

- [Activate AI Prompt](#activate-ai-prompt)
- [Test AI Prompt](#test-ai-prompt)

---

#### Update AI Prompt

Update an existing AI prompt.

##### HTTP Method and Path

```
PUT /admin/ai_prompts/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | AI prompt unique identifier |

##### Request Body

Same structure as Create AI Prompt. All fields optional.

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ai_prompt": {
      "id": 1,
      "prompt_text": "Updated prompt text"
    }
  },
  "message": "AI prompt updated successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X PUT http://localhost:3000/admin/ai_prompts/1 \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ai_prompt": {
      "prompt_text": "Updated prompt text"
    }
  }'
```

---

#### Delete AI Prompt

Permanently delete an AI prompt.

##### HTTP Method and Path

```
DELETE /admin/ai_prompts/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "deleted": true
  },
  "message": "AI prompt deleted successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X DELETE http://localhost:3000/admin/ai_prompts/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

---

#### Activate AI Prompt

Activate an AI prompt and deactivate others of same type.

##### HTTP Method and Path

```
POST /admin/ai_prompts/:id/activate
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Activates the specified prompt and automatically deactivates all other prompts of the same `prompt_type`. Ensures only one prompt per type is active.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | AI prompt unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ai_prompt": {
      "id": 1,
      "active": true
    }
  },
  "message": "AI prompt activated successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/ai_prompts/1/activate \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Automatically deactivates other prompts of same prompt_type
- Only one prompt per type should be active

##### Related Endpoints

- [Create AI Prompt](#create-ai-prompt)
- [Test AI Prompt](#test-ai-prompt)

---

#### Test AI Prompt

Test an AI prompt with sample variables (AC-ADMIN-015).

##### HTTP Method and Path

```
POST /admin/ai_prompts/:id/test
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Tests an AI prompt by rendering it with provided test variables. Returns both the original template and the rendered version.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | AI prompt unique identifier |

##### Request Body

```json
{
  "test_variables": {
    "target_language": "Japanese",
    "recipe_content": "Taiwanese Beef Noodle Soup..."
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `test_variables` | Object | No | Key-value pairs for prompt variables |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "original_content": "Translate to {{target_language}}:\n\n{{recipe_content}}",
    "test_content": "Translate to Japanese:\n\nTaiwanese Beef Noodle Soup...",
    "variables_used": {
      "target_language": "Japanese",
      "recipe_content": "Taiwanese Beef Noodle Soup..."
    }
  },
  "message": "Prompt test generated successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/ai_prompts/1/test \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "test_variables": {
      "target_language": "Japanese",
      "recipe_content": "Test content"
    }
  }'
```

##### Notes

- Acceptance Criteria: AC-ADMIN-015
- Variables use `{{variable_name}}` format
- Helps verify prompt rendering before activation
- Missing variables remain as placeholders in output

##### Related Endpoints

- [Create AI Prompt](#create-ai-prompt)
- [Activate AI Prompt](#activate-ai-prompt)

---

### Ingredients

#### List Ingredients

Get a paginated list of ingredients with optional filtering.

##### HTTP Method and Path

```
GET /admin/ingredients
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Returns a paginated list of ingredients with their basic information and summary of nutrition/alias data.

##### Query Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `page` | Integer | No | 1 | Page number for pagination |
| `per_page` | Integer | No | 50 | Items per page (max 100) |
| `category` | String | No | - | Filter by ingredient category |
| `q` | String | No | - | Search by canonical name (case-insensitive) |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ingredients": [
      {
        "id": 1,
        "canonical_name": "beef shank",
        "category": "meat",
        "has_nutrition": true,
        "aliases_count": 3,
        "created_at": "2025-10-09T12:00:00Z",
        "updated_at": "2025-10-09T12:00:00Z"
      }
    ],
    "pagination": {
      "current_page": 1,
      "per_page": 50,
      "total_count": 150,
      "total_pages": 3
    }
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET "http://localhost:3000/admin/ingredients?category=meat&q=beef" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Results ordered alphabetically by canonical_name
- has_nutrition indicates if nutrition data exists
- aliases_count shows number of alternative names

##### Related Endpoints

- [Get Ingredient](#get-ingredient)
- [Create Ingredient](#create-ingredient)

---

#### Get Ingredient

Get detailed information about an ingredient.

##### HTTP Method and Path

```
GET /admin/ingredients/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Ingredient unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ingredient": {
      "id": 1,
      "canonical_name": "beef shank",
      "category": "meat",
      "created_at": "2025-10-09T12:00:00Z",
      "updated_at": "2025-10-09T12:00:00Z",
      "nutrition": {
        "calories": 250,
        "protein_g": 35,
        "carbs_g": 0,
        "fat_g": 12,
        "fiber_g": 0,
        "data_source": "nutritionix",
        "confidence_score": 0.95
      },
      "aliases": [
        { "alias": "beef shin", "language": "en" },
        { "alias": "ÁâõËÖ±", "language": "zh-tw" }
      ]
    }
  }
}
```

##### Example Requests

###### cURL

```bash
curl -X GET http://localhost:3000/admin/ingredients/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Nutrition values are per 100g
- Confidence score indicates data reliability (0-1)
- data_source shows origin: nutritionix, manual, or usda

##### Related Endpoints

- [Update Ingredient](#update-ingredient)
- [Refresh Nutrition Data](#refresh-nutrition-data)

---

#### Create Ingredient

Create a new ingredient with nutrition data.

##### HTTP Method and Path

```
POST /admin/ingredients
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Request Body

```json
{
  "ingredient": {
    "canonical_name": "beef shank",
    "category": "meat"
  },
  "nutrition": {
    "calories": 250,
    "protein_g": 35,
    "carbs_g": 0,
    "fat_g": 12,
    "fiber_g": 0,
    "data_source": "manual",
    "confidence_score": 0.8
  },
  "aliases": [
    { "alias": "beef shin", "language": "en" },
    { "alias": "ÁâõËÖ±", "language": "zh-tw" }
  ]
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `ingredient.canonical_name` | String | Yes | Standard ingredient name |
| `ingredient.category` | String | Yes | Ingredient category |
| `nutrition` | Object | No | Nutrition data per 100g |
| `aliases` | Array | No | Alternative names with languages |

##### Response

###### Success (201 Created)

```json
{
  "success": true,
  "data": {
    "ingredient": {
      "id": 1,
      "canonical_name": "beef shank",
      "nutrition": {},
      "aliases": []
    }
  },
  "message": "Ingredient created successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/ingredients \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ingredient": {
      "canonical_name": "beef shank",
      "category": "meat"
    }
  }'
```

##### Notes

- canonical_name should be lowercase
- Nutrition and aliases are optional but recommended
- Nutrition values are per 100g servings
- Confidence score: 0-1, where 1 is highest confidence

##### Related Endpoints

- [Update Ingredient](#update-ingredient)
- [Refresh Nutrition Data](#refresh-nutrition-data)

---

#### Update Ingredient

Update an existing ingredient and its nutrition data.

##### HTTP Method and Path

```
PUT /admin/ingredients/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Ingredient unique identifier |

##### Request Body

```json
{
  "ingredient": {
    "canonical_name": "beef shank",
    "category": "meat"
  },
  "nutrition": {
    "calories": 250,
    "protein_g": 35
  }
}
```

All fields are optional. Only provided fields will be updated.

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ingredient": {
      "id": 1,
      "canonical_name": "beef shank"
    }
  },
  "message": "Ingredient updated successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X PUT http://localhost:3000/admin/ingredients/1 \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nutrition": {
      "calories": 255
    }
  }'
```

##### Notes

- Partial updates supported
- If nutrition object doesn't exist, it will be created
- Existing nutrition values not in request remain unchanged

##### Related Endpoints

- [Get Ingredient](#get-ingredient)
- [Refresh Nutrition Data](#refresh-nutrition-data)

---

#### Delete Ingredient

Permanently delete an ingredient.

##### HTTP Method and Path

```
DELETE /admin/ingredients/:id
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Ingredient unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "deleted": true
  },
  "message": "Ingredient deleted successfully"
}
```

##### Example Requests

###### cURL

```bash
curl -X DELETE http://localhost:3000/admin/ingredients/1 \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- This is a destructive operation and cannot be undone
- Associated nutrition and alias records are also deleted

---

#### Refresh Nutrition Data

Refresh ingredient nutrition from Nutritionix API (AC-NUTR-013 placeholder).

##### HTTP Method and Path

```
POST /admin/ingredients/:id/refresh_nutrition
```

##### Authentication

- **Required**: Yes
- **Type**: Bearer Token
- **Role Required**: Admin

##### Description

Fetches updated nutrition data from the Nutritionix API. Currently updates data_source and confidence_score as a placeholder until full API integration.

##### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | Integer | Yes | Ingredient unique identifier |

##### Response

###### Success (200 OK)

```json
{
  "success": true,
  "data": {
    "ingredient": {
      "id": 1,
      "nutrition": {
        "data_source": "nutritionix",
        "confidence_score": 1.0
      }
    }
  },
  "message": "Nutrition data refreshed successfully"
}
```

##### Error Responses

**422 Unprocessable Entity**
```json
{
  "success": false,
  "message": "No nutrition data to refresh",
  "errors": ["Create nutrition data first"]
}
```

##### Example Requests

###### cURL

```bash
curl -X POST http://localhost:3000/admin/ingredients/1/refresh_nutrition \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

##### Notes

- Acceptance Criteria: AC-NUTR-013 (placeholder)
- Full Nutritionix API integration to be implemented
- Currently updates metadata only
- Requires existing nutrition record

##### Related Endpoints

- [Get Ingredient](#get-ingredient)
- [Update Ingredient](#update-ingredient)

---

## Common Response Patterns

All API responses follow a consistent structure:

### Success Response

```json
{
  "success": true,
  "data": {
    // Response data here
  },
  "message": "Optional success message"
}
```

### Error Response

```json
{
  "success": false,
  "message": "Error description",
  "errors": ["Detailed error 1", "Detailed error 2"]
}
```

### Pagination Meta

```json
{
  "pagination": {
    "current_page": 1,
    "per_page": 20,
    "total_count": 45,
    "total_pages": 3
  }
}
```

---

## Error Codes Reference

### HTTP Status Codes

| Code | Meaning | When to Expect |
|------|---------|----------------|
| 200 | OK | Successful GET, PUT, PATCH, DELETE |
| 201 | Created | Successful POST that creates a resource |
| 400 | Bad Request | Invalid request format or parameters |
| 401 | Unauthorized | Missing or invalid authentication token |
| 403 | Forbidden | Authenticated but not authorized (not admin) |
| 404 | Not Found | Resource doesn't exist |
| 422 | Unprocessable Entity | Validation errors |
| 500 | Internal Server Error | Server-side error |

### Common Error Messages

**Authentication Errors:**
- `"Unauthorized"` - No token or invalid token
- `"User not authenticated"` - Token invalid or expired
- `"Access denied"` - User doesn't have required permissions

**Validation Errors:**
- `"Validation failed"` - One or more fields failed validation
- `"[Field] can't be blank"` - Required field missing
- `"[Field] has already been taken"` - Uniqueness constraint violated
- `"[Field] is too short (minimum is X characters)"` - Length constraint

**Resource Errors:**
- `"Recipe not found"` - Resource with given ID doesn't exist
- `"Note not found or you do not have permission to modify it"` - Ownership check failed

---

## Changelog

| Date | Version | Changes |
|------|---------|---------|
| 2025-10-09 | 1.0.0 | Initial API reference documentation |

---

**Note:** This API reference should be updated whenever new endpoints are added or existing endpoints are modified. See [API_REFERENCE_TEMPLATE.md](API_REFERENCE_TEMPLATE.md) for guidelines on documenting new endpoints.

```

## docs/new_claude/database-architecture.md

```
# Database Architecture

This document describes the recipe database schema, field definitions, data types, and organizational principles.

## Overview

The recipe database uses a normalized relational schema with PostgreSQL and the Mobility gem for internationalization (i18n). All recipes support translation into 7 languages: English, Japanese, Korean, Traditional Chinese, Simplified Chinese, Spanish, and French.

## Table Structure

### Core Tables

#### `recipes`
Stores the main recipe information with source language and structural data.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | BIGINT | Primary key | Auto-incrementing |
| `name` | String | Recipe name (deprecated - use Mobility) | Max 255 characters |
| `source_language` | String | Language the recipe was authored in | ISO 639-1 code: `en`, `ja`, `ko`, `zh-tw`, `zh-cn`, `es`, `fr` |
| `requires_precision` | Boolean | Whether precise measurements are critical | `true` or `false` |
| `precision_reason` | String | Reason why precision is required | One of: `baking`, `confectionery`, `fermentation`, `molecular` |
| `difficulty_level` | Integer | Recipe difficulty/skill level | Enum: `0` = easy, `1` = medium, `2` = hard |
| `servings_original` | Integer | Default number of servings | Positive integer |
| `servings_min` | Integer | Minimum servings for scaling | Positive integer, ‚â§ `servings_original` |
| `servings_max` | Integer | Maximum servings for scaling | Positive integer, ‚â• `servings_original` |
| `prep_minutes` | Integer | Preparation time | Non-negative integer (minutes) |
| `cook_minutes` | Integer | Active cooking time | Non-negative integer (minutes) |
| `total_minutes` | Integer | Total time from start to finish | Non-negative integer (minutes), typically ‚â• prep + cook |
| `source_url` | String | Original recipe source URL | Valid HTTP(S) URL or null |
| `admin_notes` | Text | Internal notes (not visible to users) | Any text |
| `variants_generated` | Boolean | Whether step variants have been created | `true` or `false` |
| `variants_generated_at` | DateTime | Timestamp of last variant generation | ISO 8601 timestamp or null |
| `translations_completed` | Boolean | Whether all language translations are complete | `true` or `false` |
| `translation_status` | JSONB | Progress tracking for each language | See [Translation Status JSONB](#translation-status-jsonb) |
| `created_at` | DateTime | Created timestamp | ISO 8601 timestamp |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 timestamp |

**Indexes:**
- Primary key on `id` (BIGINT auto-incrementing)
- Index on `source_language` (for filtering by authoring language)
- Index on `difficulty_level` (for filtering by recipe difficulty)
- Index on `created_at` (for chronological queries)

#### `recipe_translations`
Mobility gem table for translating recipe name and other text fields.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `recipe_id` | BIGINT | Foreign key to recipes | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Field name being translated | NOT NULL, e.g., `name`, `description` |
| `value` | Text | Translated content | Text or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(recipe_id, locale, key)` - one translation per recipe/language/field combination

**Indexes:**
- Primary key on `id`
- Index on `(recipe_id, locale)` for efficient lookup by recipe and language
- Index on `recipe_id` for foreign key queries

**Translatable Fields:**
- `name` - recipe name
- `description` - recipe description, overview, and context (NOT NULL, TEXT type)

---

### Ingredient Tables

#### `ingredient_groups`
Groups ingredients for organizational purposes (e.g., "Sauce", "Main Ingredients").

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | BIGINT | Primary key | Auto-incrementing |
| `recipe_id` | BIGINT | Foreign key to recipes | NOT NULL, indexed |
| `order` | Integer | Display order within recipe | ‚â• 0, ordered by this field |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Foreign key index on `recipe_id`

#### `ingredient_group_translations`
Mobility gem table for translating ingredient group names.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `ingredient_group_id` | BIGINT | Foreign key to ingredient_groups | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Field name being translated | NOT NULL, always `name` |
| `value` | Text | Translated group name | Text or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(ingredient_group_id, locale, key)`

**Translatable Fields:** `name` (e.g., "Sauce" ‚Üí "„ÇΩ„Éº„Çπ")

#### `recipe_ingredients`
Individual ingredients within an ingredient group.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | BIGINT | Primary key | Auto-incrementing |
| `ingredient_group_id` | BIGINT | Foreign key to ingredient_groups | NOT NULL, indexed |
| `order` | Integer | Display order within group | ‚â• 0 |
| `amount` | Decimal | Quantity of ingredient | Precision: 8 digits, Scale: 2 (e.g., `100.50`) |
| `unit` | String | Unit of measurement | Examples: `cup`, `tbsp`, `g`, `ml`, `oz`, `lb` |
| `optional` | Boolean | Whether ingredient is optional | `true` or `false` |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Foreign key index on `ingredient_group_id`

#### `recipe_ingredient_translations`
Mobility gem table for translating ingredient names and preparation notes.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `recipe_ingredient_id` | BIGINT | Foreign key to recipe_ingredients | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Field name | NOT NULL, one of: `ingredient_name`, `preparation_notes` |
| `value` | Text | Translated content | Text or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(recipe_ingredient_id, locale, key)`

**Translatable Fields:**
- `ingredient_name` - the ingredient name (e.g., "all-purpose flour" ‚Üí "ËñÑÂäõÁ≤â")
- `preparation_notes` - how to prepare it (e.g., "sifted" ‚Üí "„Åµ„Çã„Å£„Åü")

---

### Step Tables

#### `recipe_steps`
Individual cooking instructions and steps.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | BIGINT | Primary key | Auto-incrementing |
| `recipe_id` | BIGINT | Foreign key to recipes | NOT NULL, indexed |
| `order` | Integer | Step number | ‚â• 1, ordered by this field |
| `timing_minutes` | Integer | Time for this step | Non-negative integer or null |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Foreign key index on `recipe_id`
- Index on `(recipe_id, order)` for efficient step retrieval

#### `recipe_step_translations`
Mobility gem table for translating step instructions in 3 variants.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | Integer | Primary key | Auto-incrementing |
| `recipe_step_id` | BIGINT | Foreign key to recipe_steps | NOT NULL, indexed |
| `locale` | String | Language code | NOT NULL, ISO 639-1 code |
| `key` | String | Instruction variant type | NOT NULL, one of: `instruction_original`, `instruction_easier`, `instruction_no_equipment` |
| `value` | Text | Translated instruction | Text |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Unique Constraint:** `(recipe_step_id, locale, key)` - one translation per step/language/variant

**Indexes:**
- Primary key on `id`
- Index on `(recipe_step_id, locale)` for efficient lookup
- Index on `recipe_step_id` for foreign key queries

**Translatable Fields:**
- `instruction_original` - base instruction as written
- `instruction_easier` - simplified version for beginners
- `instruction_no_equipment` - version without special equipment (when applicable)

**Notes:** Each step has up to 3 instructions √ó 7 languages = up to 21 translation rows per step. This allows complete flexibility in step variant generation and translation.

---

### Nutrition Table

#### `recipe_nutrition`
Nutritional information per serving.

| Field | Type | Description | Units/Format |
|-------|------|-------------|---------------|
| `id` | BIGINT | Primary key | Auto-incrementing |
| `recipe_id` | BIGINT | Foreign key to recipes (one-to-one) | NOT NULL, unique constraint |
| `calories` | Decimal | Energy content | Precision: 8, Scale: 2 (e.g., `245.50` calories) |
| `protein_g` | Decimal | Protein content | Precision: 6, Scale: 2 (grams, e.g., `12.50`) |
| `carbs_g` | Decimal | Carbohydrate content | Precision: 6, Scale: 2 (grams, e.g., `45.25`) |
| `fat_g` | Decimal | Fat content | Precision: 6, Scale: 2 (grams, e.g., `8.75`) |
| `fiber_g` | Decimal | Dietary fiber content | Precision: 6, Scale: 2 (grams, e.g., `3.50`) |
| `created_at` | DateTime | Created timestamp | ISO 8601 |
| `updated_at` | DateTime | Last updated timestamp | ISO 8601 |

**Indexes:**
- Primary key on `id`
- Unique constraint on `recipe_id` (one nutrition record per recipe)

**Notes:** Decimal columns use:
- Precision: Total number of significant digits
- Scale: Number of digits after the decimal point
- All nutrition values are per serving

---

### Reference Data Tables (Tags & Classifications)

#### `recipe_dietary_tags` (Join Table)
Many-to-many relationship between recipes and dietary tags.

| Field | Type | Description |
|-------|------|-------------|
| `id` | BIGINT | Primary key |
| `recipe_id` | BIGINT | Foreign key to recipes |
| `dietary_tag_id` | BIGINT | Foreign key to data_references |
| `created_at` | DateTime | Created timestamp |

**Unique Constraint:** `(recipe_id, dietary_tag_id)` - prevent duplicate tags per recipe

**Indexes:** Foreign key indexes on both columns

**Examples:** vegetarian, vegan, gluten-free, dairy-free, nut-free, paleo, keto, low-carb

#### `recipe_cuisines` (Join Table)
Many-to-many relationship between recipes and cuisines.

| Field | Type | Description |
|-------|------|-------------|
| `id` | BIGINT | Primary key |
| `recipe_id` | BIGINT | Foreign key to recipes |
| `cuisine_id` | BIGINT | Foreign key to data_references |
| `created_at` | DateTime | Created timestamp |

**Unique Constraint:** `(recipe_id, cuisine_id)`

**Indexes:** Foreign key indexes

**Examples:** italian, french, japanese, thai, mexican, indian, chinese, korean, mediterranean, middle-eastern

#### `data_references`
Reference data for categories like dietary tags and cuisines.

| Field | Type | Description |
|-------|------|-------------|
| `id` | BIGINT | Primary key |
| `reference_type` | String | Type of reference: `dietary_tag`, `cuisine`, `unit` |
| `key` | String | Machine-readable key (kebab-case) |
| `sort_order` | Integer | Display order |
| `active` | Boolean | Whether this reference is currently in use |
| `created_at` | DateTime | Created timestamp |
| `updated_at` | DateTime | Last updated timestamp |

**Unique Constraint:** `(reference_type, key)` - one key per reference type

**Indexes:** Index on `reference_type` for filtering

#### `data_reference_translations`
Mobility gem table for translating data reference display names.

| Field | Type | Description |
|-------|------|-------------|
| `id` | Integer | Primary key |
| `data_reference_id` | BIGINT | Foreign key to data_references |
| `locale` | String | Language code |
| `key` | String | Field name (always `display_name`) |
| `value` | Text | Translated name (e.g., "Vegetarian" ‚Üí "„Éô„Ç∏„Çø„É™„Ç¢„É≥") |
| `created_at` | DateTime | Created timestamp |
| `updated_at` | DateTime | Last updated timestamp |

**Unique Constraint:** `(data_reference_id, locale, key)`

**Translatable Fields:** `display_name` - the user-facing display name

---

### Equipment Table

#### `equipment` (JSONB Array - Deferred Normalization)
Equipment needed for the recipe. Currently stored as JSONB array of strings (normalization deferred to future phase).

**Current Structure:**
```json
[
  "large pot",
  "wooden spoon",
  "cutting board",
  "chef's knife"
]
```

**Notes:** This field will be normalized in a future phase into a proper `equipment` table with translations via Mobility. For now, equipment names are not translatable - they remain in the source language.

---

### Active Storage Tables (File Storage)

Recipe images are stored using Rails Active Storage. This framework provides three tables to manage file uploads.

#### `active_storage_blobs`
Stores metadata about uploaded files.

| Field | Type | Description |
|-------|------|-------------|
| `id` | BigInt | Primary key |
| `key` | String | Unique storage key |
| `filename` | String | Original filename uploaded |
| `content_type` | String | MIME type (e.g., `image/jpeg`, `image/png`) |
| `metadata` | JSON | Additional file metadata |
| `byte_size` | BigInt | File size in bytes |
| `checksum` | String | MD5 checksum for integrity verification |
| `created_at` | DateTime | Upload timestamp |

**Indexes:**
- Primary key on `id`
- Unique index on `key` (for fast retrieval)

**Notes:** One blob record per uploaded file, regardless of how many models reference it.

#### `active_storage_attachments`
Links stored files (blobs) to models using polymorphic association.

| Field | Type | Description |
|-------|------|-------------|
| `id` | BigInt | Primary key |
| `name` | String | Attachment name (e.g., `image`) |
| `record_type` | String | Model type (e.g., `Recipe`) |
| `record_id` | BIGINT | Model ID (e.g., recipe ID) |
| `blob_id` | BigInt | Foreign key to `active_storage_blobs` |
| `created_at` | DateTime | Attachment timestamp |

**Unique Constraint:** `(record_type, record_id, name, blob_id)` - prevents duplicate attachments

**Indexes:**
- Unique index on `(record_type, record_id, name, blob_id)`
- Index on `blob_id` for fast blob lookup

**Usage:** For recipes, this links recipe images to their corresponding recipe records.

#### `active_storage_variant_records`
Stores pre-generated image variants (thumbnails, resized versions, etc.).

| Field | Type | Description |
|-------|------|-------------|
| `id` | BigInt | Primary key |
| `blob_id` | BigInt | Foreign key to `active_storage_blobs` |
| `variation_digest` | String | Hash of variant transformation parameters |

**Unique Constraint:** `(blob_id, variation_digest)` - one variant per unique transformation

**Indexes:**
- Unique index on `(blob_id, variation_digest)`

**Notes:** Currently not in use - added automatically by Rails. Future enhancement for image thumbnails and responsive sizes.

**Relationship to Recipes:**
- Recipe has many attachments (polymorphic)
- Each recipe can have one image attachment via `has_one_attached :image`
- Image attachment references blob via `active_storage_attachments`
- Blob contains file metadata and storage key

---

## JSONB Structures

### Translation Status JSONB
Location: `recipes.translation_status`

Tracks translation progress for each language independently.

**Structure:**
```json
{
  "ja": {
    "status": "completed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": "2025-10-20T10:45:00Z",
    "error": null
  },
  "ko": {
    "status": "in_progress",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": null,
    "error": null
  },
  "zh-tw": {
    "status": "pending",
    "started_at": null,
    "completed_at": null,
    "error": null
  },
  "zh-cn": {
    "status": "failed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": null,
    "error": "API timeout after 30 seconds"
  },
  "es": {
    "status": "completed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": "2025-10-20T10:35:00Z",
    "error": null
  },
  "fr": {
    "status": "completed",
    "started_at": "2025-10-20T10:30:00Z",
    "completed_at": "2025-10-20T10:40:00Z",
    "error": null
  }
}
```

**Fields:**
- `status` - One of: `pending`, `in_progress`, `completed`, `failed`
- `started_at` - ISO 8601 timestamp when translation job started (null if pending)
- `completed_at` - ISO 8601 timestamp when translation finished (null if not completed)
- `error` - Error message if status is `failed`, null otherwise

**Supported Languages:**
- `en` - English (source language, not translated)
- `ja` - Êó•Êú¨Ë™û (Japanese)
- `ko` - ÌïúÍµ≠Ïñ¥ (Korean)
- `zh-tw` - ÁπÅÈ´î‰∏≠Êñá (Traditional Chinese)
- `zh-cn` - ÁÆÄ‰Ωì‰∏≠Êñá (Simplified Chinese)
- `es` - Espa√±ol (Spanish)
- `fr` - Fran√ßais (French)

---

## Data Organization Principles

### Internationalization (i18n)

**Supported Languages:** 7 (English + 6 target languages)

**Translation Approach:**
- **Mobility Gem with Table Backend:** Each translatable model has a `{model}_translations` table
- **Fallback Strategy:** If translation missing for a language, falls back to `source_language`
- **User-Facing Language:** Determined by frontend UI language selection, passed via `?locale=` query parameter
- **API Behavior:** Returns translated content when available, source language as fallback

**Translatable Content:**
- Recipe name (via `recipe_translations`)
- Ingredient group names (via `ingredient_group_translations`)
- Ingredient names & preparation notes (via `recipe_ingredient_translations`)
- Step instructions - all 3 variants (via `recipe_step_translations`)
- Data reference display names like "Vegetarian" (via `data_reference_translations`)
- Equipment names (deferred - currently stored as JSONB, non-translatable)

**Non-Translatable Content:**
- Numeric fields (servings, timing, nutrition)
- Amounts and units
- Boolean flags (requires_precision, optional, active, etc.)
- IDs and foreign keys

### Data Integrity

**Foreign Key Constraints:** All relationships use explicit foreign keys with CASCADE delete where appropriate:
- `ingredient_groups` ‚Üí `recipes` (CASCADE delete)
- `recipe_ingredients` ‚Üí `ingredient_groups` (CASCADE delete)
- `recipe_steps` ‚Üí `recipes` (CASCADE delete)
- `recipe_nutrition` ‚Üí `recipes` (CASCADE delete)
- Join tables ‚Üí `recipes` (CASCADE delete)

**Unique Constraints:** Prevent duplicates:
- Email in `users` table
- Recipe name in source language per recipe
- Dietary tag per recipe (via join table)
- Translation rows per entity/language/field combination

**Indexes:** Optimized for common queries:
- Lookups by recipe ID (foreign keys)
- Filtering by source language
- Searching by creation date
- Retrieving steps in order
- Finding recipes by tags/cuisines/dietary restrictions

### Numeric Precision

**Timing Fields:** Integer minutes
- `prep_minutes`, `cook_minutes`, `total_minutes`, `timing_minutes`
- Range: 0 to 2,147,483,647 (sufficient for any recipe)

**Nutrition Fields:** Decimal with 2 decimal places
- `calories`, `protein_g`, `carbs_g`, `fat_g`, `fiber_g`
- Precision: 8 digits total, Scale: 2 decimal places
- Example: `245.50` represents 245.50 calories or grams
- Supports values from 0.00 to 999999.99

**Amount Fields:** Decimal with 2 decimal places
- `recipe_ingredients.amount`
- Precision: 8 digits total, Scale: 2 decimal places
- Example: `2.50` represents 2.50 cups of flour

### Units & Standards

**Timing:** Always in minutes
- No conversion needed between display and storage
- `total_minutes` should be ‚â• (prep + cook)

**Nutrition:** Always in gram-based units
- Calories: no unit needed (calories are the unit)
- Protein, carbs, fat, fiber: grams (g)
- Store as decimals to support precision (e.g., 12.50g protein)

**Ingredient Amounts:** User-specified units
- Common units: cup, tbsp, tsp, ml, l, g, kg, oz, lb, count, pinch, dash
- Not normalized (user specifies the unit they prefer)
- Handled by frontend for scaling operations

---

## Related Documentation

- **i18n Implementation:** See [i18n guide](./i18n.md) for translation workflow and API usage
- **Architecture Overview:** See [architecture.md](./architecture.md) for system-level design
- **Getting Started:** See [entry.md](./entry.md) for navigation and project overview

```

## docs/new_claude/i18n-workflow.md

```
# Internationalization & Translation Workflow

Two complementary systems handle language support:
- **Static i18n (YAML):** UI text, 7 languages, developer-maintained
- **Dynamic translation (Mobility):** Recipe content, 6 languages, AI-generated

---

## Supported Languages

| Language | Code | Native | UI (YAML) | Recipes (Mobility) |
|----------|------|--------|-----------|-------------------|
| English | `en` | English | Yes | Yes |
| Japanese | `ja` | Êó•Êú¨Ë™û | Yes | Yes |
| Korean | `ko` | ÌïúÍµ≠Ïñ¥ | Yes | Yes |
| Traditional Chinese | `zh-tw` | ÁπÅÈ´î‰∏≠Êñá | Yes | Yes |
| Simplified Chinese | `zh-cn` | ÁÆÄ‰Ωì‰∏≠Êñá | Yes | Yes |
| Spanish | `es` | Espa√±ol | Yes | Yes |
| French | `fr` | Fran√ßais | Yes | Yes |

**Requirement:** 100% translation coverage for UI text (all 7 languages). Recipe translations auto-generated on creation.

---

## 1. Static UI Translation (YAML)

### Backend i18n

**Location:** `backend/config/locales/`

**Files:** `en.yml`, `ja.yml`, `ko.yml`, `zh-tw.yml`, `zh-cn.yml`, `es.yml`, `fr.yml`

**Namespaces:**
- `common` - Shared UI strings (buttons, labels)
- `errors` - Validation and error messages
- `navigation` - Menu items and links
- `forms` - Form labels and placeholders
- `api` - API response messages

**Usage:**
```ruby
I18n.t('api.recipe.created')
I18n.t('errors.validation.required', field: 'Name')
```

### Frontend i18n (Vue)

**Location:** `frontend/src/locales/`

**Files:** `en.json`, `ja.json`, `ko.json`, `zh-tw.json`, `zh-cn.json`, `es.json`, `fr.json`

**Structure:**
```json
{
  "common": {
    "buttons": { "save": "...", "cancel": "..." },
    "labels": { "name": "...", "email": "..." }
  },
  "errors": {
    "validation": { "required": "...", "invalid": "..." }
  }
}
```

**Usage in templates:**
```vue
{{ $t('recipe.title') }}
{{ $t('common.buttons.save') }}
<input :placeholder="$t('forms.recipe.name')" />
```

**Usage in script (Composition API):**
```typescript
import { useI18n } from 'vue-i18n'
const { t } = useI18n()
const message = t('common.messages.success')
```

---

## 2. Dynamic Recipe Translation (Mobility)

### What Gets Translated

Entire recipe content translated to 6 non-English languages on creation via AI (Claude API).

**Translated models & fields:**
- Recipe: `name`
- IngredientGroup: `name`
- RecipeIngredient: `ingredient_name`, `preparation_notes`
- RecipeStep: `instruction_original`, `instruction_easier`, `instruction_no_equipment`
- Equipment: `canonical_name`
- DataReference: `display_name`

### Translation Tables

**Pattern:** Each translatable model ‚Üí dedicated translation table (normalized)

```
Recipe ‚Üí RecipeTranslation (recipe_id, locale, name)
IngredientGroup ‚Üí IngredientGroupTranslation (ingredient_group_id, locale, name)
RecipeIngredient ‚Üí RecipeIngredientTranslation (recipe_ingredient_id, locale, ingredient_name, preparation_notes)
RecipeStep ‚Üí RecipeStepTranslation (recipe_step_id, locale, instruction_original, instruction_easier, instruction_no_equipment)
Equipment ‚Üí EquipmentTranslation (equipment_id, locale, canonical_name)
DataReference ‚Üí DataReferenceTranslation (data_reference_id, locale, display_name)
```

**Constraint:** `UNIQUE(entity_id, locale)`

### Fallback Chain

When translation missing for locale:

```
ja ‚Üí en
ko ‚Üí en
zh-tw ‚Üí zh-cn ‚Üí en
zh-cn ‚Üí zh-tw ‚Üí en
es ‚Üí en
fr ‚Üí en
```

### Reading Translations

**In specific locale:**
```ruby
recipe = Recipe.find(id)
I18n.with_locale(:ja) { recipe.name }  # Japanese translation
```

**With fallback:**
```ruby
I18n.with_locale(:ja) { recipe.name }
# Returns Japanese translation if exists, else fallback to English
```

**Via API:**
```
GET /api/v1/recipes/:id?lang=ja
# Response contains all translations for 'ja' locale (with fallbacks)
```

### Writing Translations

**In code:**
```ruby
recipe = Recipe.find(id)
I18n.with_locale(:ja) { recipe.update(name: '„É¨„Ç∑„Éî') }
```

**Via TranslateRecipeJob (automatic):**
```ruby
# Triggered on recipe creation
TranslateRecipeJob.perform_later(recipe.id)
```

---

## 3. TranslateRecipeJob Workflow

**Trigger:** Recipe creation (enqueued automatically)

**Process:**

1. Load recipe with eager-loaded associations:
   - `ingredient_groups` with `recipe_ingredients`
   - `recipe_steps`, `equipment`

2. Instantiate `RecipeTranslator` service

3. For each language in `[ja, ko, zh-tw, zh-cn, es, fr]`:
   - Call `translator.translate_recipe(recipe, lang)`
   - Receive structured data: `{name, ingredient_groups, steps, equipment}`
   - Apply translations via `apply_translations(recipe, data, lang)`

4. Set `recipe.translations_completed = true`

5. On error:
   - Log error: "Translation failed for recipe #{recipe_id}: #{error}"
   - Re-raise exception (Sidekiq retry)

**apply_translations method:**
```ruby
I18n.with_locale(locale) do
  recipe.update(name: data['name']) if data['name']

  recipe.ingredient_groups.each_with_index do |group, idx|
    group.update(name: data['ingredient_groups'][idx]['name'])

    group.recipe_ingredients.each_with_index do |ingredient, item_idx|
      item = data['ingredient_groups'][idx]['items'][item_idx]
      ingredient.update(ingredient_name: item['name'], preparation_notes: item['preparation'])
    end
  end

  recipe.recipe_steps.order(:step_number).each_with_index do |step, idx|
    instructions = data['steps'][idx]['instructions']
    step.update(
      instruction_original: instructions['original'],
      instruction_easier: instructions['easier'],
      instruction_no_equipment: instructions['no_equipment']
    )
  end

  recipe.equipment.each_with_index do |equipment, idx|
    equipment.update(canonical_name: data['equipment'][idx])
  end
end
```

---

## 4. Auto-Triggered Translation Workflow

**Trigger:** Recipe creation or update (via `after_commit` callbacks)

### Recipe Creation Flow

**Process:**
1. `after_commit :enqueue_translation_on_create`
2. Immediately enqueue `TranslateRecipeJob.perform_later(id)`
3. No rate limiting applied
4. No deduplication check

### Recipe Update Flow

**Process:**
1. `after_commit :enqueue_translation_on_update`
2. Check for existing translation jobs: `has_translation_job_with_recipe_id?`
3. If existing job found:
   - Check if job is running: `has_running_translation_job?`
   - If NOT running: Delete pending job via `delete_pending_translation_job`
   - If running: Keep running job (never interrupt)
4. Schedule new job at next available time: `schedule_translation_at_next_available_time`

### Deduplication Logic

**Purpose:** Ensure latest recipe data wins, prevent queue buildup

**Delete pending jobs when:**
- Existing translation job exists for this recipe
- Job is NOT currently running (no `claimed_execution` record)

**Never delete:**
- Jobs with `claimed_execution` (currently executing)

**Implementation:**
```ruby
SolidQueue::Job.where(class_name: 'TranslateRecipeJob')
  .where('arguments->0 = ?', recipe_id)
  .where(finished_at: nil)
  .joins("LEFT JOIN solid_queue_claimed_executions ON solid_queue_jobs.id = solid_queue_claimed_executions.job_id")
  .where('solid_queue_claimed_executions.job_id IS NULL')
  .destroy_all
```

### Rate Limiting

**Limit:** 4 translations per recipe per hour (rolling window)

**Window:** 1 hour (3600 seconds) from `finished_at` timestamp

**Count method:**
```ruby
SolidQueue::Job.where(class_name: 'TranslateRecipeJob')
  .where('arguments->0 = ?', recipe_id)
  .where('finished_at > ?', Time.current - 3600.seconds)
  .where.not(finished_at: nil)
  .count
```

**Scheduling logic:**

If rate limit NOT exceeded:
- Immediate enqueue: `TranslateRecipeJob.perform_later(id)`

If rate limit exceeded:
- Get oldest completed job in window: `get_oldest_completed_translation_job_in_window`
- Calculate delay: `oldest_job.finished_at + 3601.seconds - Time.current`
- Delay cannot be negative: `delay = [0, calculated_delay].max`
- Schedule with delay: `TranslateRecipeJob.set(wait: delay.seconds).perform_later(id)`

**Window scope:** Only counts jobs within 1-hour window

### Helper Methods

**`has_translation_job_with_recipe_id?`**
- Checks if any translation job exists for this recipe
- Returns `false` if SolidQueue unavailable

**`has_running_translation_job?`**
- Checks if job has `claimed_execution` and `finished_at IS NULL`
- Returns `false` if SolidQueue unavailable

**`get_oldest_completed_translation_job_in_window`**
- Returns oldest completed job within 1-hour window
- Used to calculate next available schedule time
- Returns `nil` if no jobs in window or SolidQueue unavailable

**`job_queue_available?`**
- Checks `SolidQueue::Job` class exists and table exists
- Prevents errors in test environment or before migrations

### Manual Regenerate Endpoint

**Endpoint:** `POST /admin/recipes/:id/regenerate_translations`

**Behavior:**
- Bypasses rate limiting (directly calls `TranslateRecipeJob.perform_later`)
- Bypasses deduplication (does not check for existing jobs)
- Always enqueues immediately

**Use case:** Manual rerun when translations need regeneration

---

## 5. Adding New UI Translations

### Step 1: Add English (source of truth)

**Backend:**
```yaml
# backend/config/locales/en.yml
en:
  api:
    recipe:
      created: "Recipe created successfully"
```

**Frontend:**
```json
// frontend/src/locales/en.json
{
  "recipe": {
    "actions": {
      "create": "Create Recipe"
    }
  }
}
```

### Step 2: Translate to 6 other languages

Use same structure in all locale files.

**Naming conventions:**
- Backend: `snake_case` keys
- Frontend: `camelCase` keys

### Step 3: Verify coverage

**Backend:**
```bash
rails i18n:coverage      # Should show 100%
rails i18n:missing_keys  # Should show no missing keys
```

**Frontend:**
```bash
npm run check:i18n  # Must pass with 100% coverage
```

**Manual check:**
1. Start dev server: `npm run dev`
2. Switch to each language in LanguageSwitcher
3. Check for `[missing.key]` brackets in UI
4. Check console for i18n warnings

---

## 5. Translation Key Naming

### Backend (YAML)

**Format:** `snake_case`

```yaml
errors:
  validation:
    password_too_short: "Password too short"
    email_invalid: "Invalid email"

api:
  recipe:
    created: "Recipe created"
    updated: "Recipe updated"
```

### Frontend (JSON)

**Format:** `camelCase` or `kebab-case` (choose one, use consistently)

```json
{
  "errors": {
    "validation": {
      "passwordTooShort": "Password too short",
      "emailInvalid": "Invalid email"
    }
  },
  "recipe": {
    "actions": {
      "create": "Create Recipe",
      "update": "Update Recipe"
    }
  }
}
```

### Key Organization

- Group by feature/domain (recipe, ingredient, user, etc.)
- Use hierarchical keys: `domain.category.specific`
- Reuse keys (don't duplicate the same text under different keys)

---

## 6. Best Practices

### Use i18n consistently

**Bad:** Hardcoded text
```vue
<button>Save Recipe</button>
```

**Good:** Translation key
```vue
<button>{{ $t('recipe.actions.save') }}</button>
```

### Use interpolation, not concatenation

**Bad:** String concatenation
```javascript
const message = t('recipe.created') + ' ' + recipeName
```

**Good:** Interpolation
```javascript
const message = t('recipe.createdWithName', { name: recipeName })
```

```json
{
  "recipe": {
    "createdWithName": "Recipe '{name}' created"
  }
}
```

### Keep text concise

- Shorter text easier to translate
- Better UI layout fit
- Example: "Recipe Saved" instead of "The recipe has been saved to the database"

### Avoid gender assumptions

Write gender-neutral English source text.

### Handle pluralization

Different languages have different rules.

```json
{
  "recipe": {
    "count": "No recipes | 1 recipe | {count} recipes"
  }
}
```

---

## 7. Testing Translations

### Manual verification

1. **Switch languages:** Use LanguageSwitcher (top-right)
2. **Check all routes:** Navigate entire app, no `[missing.key]` visible
3. **Verify browser console:** No i18n warnings
4. **Test API responses:** `Accept-Language` header affects response locale
5. **Test persistence:** Change language, refresh page, verify persisted in localStorage

### Automated tests

**Backend (RSpec):**
```ruby
describe 'i18n' do
  it 'sets locale from Accept-Language header' do
    request = double(headers: { 'Accept-Language' => 'ja' })
    service = I18nService.new
    service.set_locale(request)
    expect(I18n.locale).to eq(:ja)
  end
end
```

**Frontend (Vitest):**
```typescript
it('switches language', () => {
  expect(i18n.global.t('hello')).toBe('Hello')
  i18n.global.locale.value = 'ja'
  expect(i18n.global.t('hello')).toBe('„Åì„Çì„Å´„Å°„ÅØ')
})
```

---

## 8. Detecting Missing Translations

### Backend

```bash
rails i18n:missing_keys
```

Output shows missing keys per locale.

### Frontend

1. Browser console for `[i18n] Missing translation` warnings
2. UI displays `[namespace.key]` for missing translations

---

## 9. Pre-Commit Checklist

**For UI text changes:**
- [ ] English translation added
- [ ] Translations for all 6 other languages added
- [ ] `rails i18n:coverage` shows 100%
- [ ] `rails i18n:missing_keys` shows no missing keys
- [ ] `npm run check:i18n` passes with 100% coverage
- [ ] Tested in browser with all 7 languages
- [ ] No `[missing.key]` brackets visible
- [ ] No console warnings

---

## 10. Common Translation Patterns

### Buttons
```json
{
  "common": {
    "buttons": {
      "save": "Save",
      "cancel": "Cancel",
      "delete": "Delete"
    }
  }
}
```

### Validation errors
```json
{
  "errors": {
    "validation": {
      "required": "This field is required",
      "invalid": "Invalid value",
      "tooShort": "Too short (min {min} characters)"
    }
  }
}
```

### Enum fields (e.g., Difficulty)
```json
{
  "forms": {
    "recipe": {
      "difficultyLevel": "Difficulty Level",
      "difficultyLevelPlaceholder": "Select difficulty level",
      "difficultyLevels": {
        "easy": "Easy",
        "medium": "Medium",
        "hard": "Hard"
      }
    }
  }
}
```

### Image Upload Fields (forms.recipe)

Image-related strings follow the same localization pattern:
- `image` - Section title (e.g., "Recipe Image", "„É¨„Ç∑„ÉîÁîªÂÉè")
- `imageUploadPlaceholder` - Prompt text (e.g., "Click or drag to upload")
- `imageUploadHint` - Validation info (e.g., "Supported formats: PNG, JPG, GIF, WebP. Max 10MB")
- `sections.image` - Form section name

Also add `remove` to common.buttons in all 7 languages for the image removal functionality.

### Empty states
```json
{
  "recipe": {
    "empty": {
      "title": "No recipes",
      "message": "Create your first recipe"
    }
  }
}
```

---

## 11. Troubleshooting

**Translation not updating after file change:**
‚Üí Restart dev server (`npm run dev`)

**Missing key warning but key exists:**
‚Üí Check for typos: `common.buttons.save` vs `common.button.save`
‚Üí Verify JSON syntax (trailing commas, quotes)

**Chinese locale codes not working:**
‚Üí Use `zh-tw` (Traditional), `zh-cn` (Simplified)
‚Üí Not `zh-TW`, `zh_tw`, `zh-CN`, `zh_cn`

---

## 12. References

- [Rails I18n Guide](https://guides.rubyonrails.org/i18n.html)
- [Vue I18n Documentation](https://vue-i18n.intlify.dev/)
- [Mobility Gem](https://github.com/shioyama/mobility) - Translation system
- [development-checklist.md](./development-checklist.md) - Phase 4 i18n tasks
- [architecture.md](./architecture.md) - Mobility architecture details
- [re-arch-ACs.md](../re-arch-ACs.md) - Phase 5 acceptance criteria (AC-PHASE5-*)

```

## docs/new_claude/component-library.md

```
# Component Library Documentation

Update this document every time a component is created, modified, or removed. Each component must document: name, location, purpose, props, emits, slots, examples, related components, and notes.

---

## Table of Contents

- [Shared Components](#shared-components)
  - [LoadingSpinner](#loadingspinner)
  - [ErrorMessage](#errormessage)
  - [ConfirmDialog](#confirmdialog)
  - [EmptyState](#emptystate)
  - [PageHeader](#pageheader)
  - [Badge](#badge)
  - [LanguageSwitcher](#languageswitcher)
- [Admin Components](#admin-components)
  - [Admin Layout](#admin-layout)
  - [Admin Recipes](#admin-recipes)
  - [Admin Data Management](#admin-data-management)
  - [Admin Prompts](#admin-prompts)
  - [Admin Ingredients](#admin-ingredients)
- [User Components](#user-components)
  - [User Layout](#user-layout)
  - [User Recipes](#user-recipes)
  - [User Search](#user-search)
  - [User Features](#user-features)
- [Composables](#composables)

---

## Shared Components

### LoadingSpinner

**Location:** `components/shared/LoadingSpinner.vue`

**Purpose:** Display loading state with consistent styling

**Props:**
```typescript
interface Props {
  size?: 'sm' | 'md' | 'lg' | 'xl'  // default: 'md'
  text?: string                      // Text to display next to spinner
  center?: boolean                   // Center in container (default: false)
  fullscreen?: boolean               // Fullscreen overlay (default: false)
  label?: string                     // Accessibility label (default: 'Loading...')
}
```

**Emits:** None

**Slots:** None

**Usage:**
```vue
<!-- Basic usage -->
<LoadingSpinner />

<!-- With text -->
<LoadingSpinner text="Loading recipes..." size="lg" />

<!-- Centered in container -->
<LoadingSpinner :center="true" />

<!-- Fullscreen overlay -->
<LoadingSpinner :fullscreen="true" text="Processing..." />
```

**Related Components:** ErrorMessage, EmptyState, PlayfulLoadingSpinner

**Notes:**
- Uses design tokens from variables.css
- Accessible with proper ARIA labels
- Fullscreen mode includes semi-transparent backdrop

---

### PlayfulLoadingSpinner

**Location:** `components/shared/PlayfulLoadingSpinner.vue`

**Purpose:** Display loading state with rotating playful text messages (cooking puns). Used for longer-running operations to keep users engaged.

**Props:**
```typescript
interface Props {
  size?: 'sm' | 'md' | 'lg' | 'xl'  // default: 'lg'
  fullscreen?: boolean               // Fullscreen overlay (default: false)
  label?: string                     // Accessibility label (default: 'Loading...')
}
```

**Emits:** None

**Slots:** None

**Usage:**
```vue
<!-- Basic usage with cooking puns -->
<PlayfulLoadingSpinner />

<!-- Fullscreen overlay -->
<PlayfulLoadingSpinner :fullscreen="true" />

<!-- Smaller size -->
<PlayfulLoadingSpinner size="md" />
```

**Features:**
- Rotating cooking pun messages that change every 2 seconds
- "(this may take a while)" subtitle
- 100% i18n coverage with culturally appropriate puns in all 7 languages
- Smooth fade transitions between messages
- Auto-cycles through 8 different cooking-related messages

**Cooking Puns (English):**
1. "Prepping ingredients..."
2. "Simmering your recipe..."
3. "Seasoning to perfection..."
4. "Reducing the sauce..."
5. "Letting it marinate..."
6. "Whisking away..."
7. "Bringing to a boil..."
8. "Adding a pinch of magic..."

**Related Components:** LoadingSpinner, UrlImportDialog

**Notes:**
- Uses design tokens from variables.css
- Accessible with proper ARIA labels
- Automatically manages rotation interval (2 seconds)
- Cleans up interval on component unmount
- i18n keys: `admin.recipes.urlImportDialog.loadingPuns.*` and `admin.recipes.urlImportDialog.loadingSubtitle`

---

### ErrorMessage

**Location:** `components/shared/ErrorMessage.vue`

**Purpose:** Display error messages with consistent styling and optional dismiss

**Props:**
```typescript
interface Props {
  error?: Error | null          // Error object (extracts message)
  message?: string              // Direct error message
  title?: string                // Error title
  severity?: 'error' | 'warning' | 'info'  // default: 'error'
  dismissible?: boolean         // Can be dismissed (default: false)
  compact?: boolean             // Compact mode (default: false)
}
```

**Emits:**
```typescript
{
  dismiss: []  // Emitted when dismissed
}
```

**Slots:**
- `default` - Additional content after message

**Usage:**
```vue
<!-- Basic error -->
<ErrorMessage message="Failed to load recipes" />

<!-- With Error object -->
<ErrorMessage :error="error" severity="error" />

<!-- Dismissible warning -->
<ErrorMessage
  message="Recipe has unsaved changes"
  severity="warning"
  :dismissible="true"
  @dismiss="handleDismiss"
/>

<!-- Compact info message -->
<ErrorMessage
  message="Using cached data"
  severity="info"
  :compact="true"
/>
```

**Related Components:** LoadingSpinner, EmptyState

**Notes:**
- Automatically extracts message from Error objects
- Uses semantic colors from design tokens
- Dark mode compatible

---

### ConfirmDialog

**Location:** `components/shared/ConfirmDialog.vue`

**Purpose:** Modal dialog for confirming actions

**Props:**
```typescript
interface Props {
  isOpen: boolean                     // Controls visibility
  title?: string                      // Dialog title (default: 'Confirm')
  message: string                     // Confirmation message
  confirmText?: string                // Confirm button text (default: 'Confirm')
  cancelText?: string                 // Cancel button text (default: 'Cancel')
  severity?: 'primary' | 'error' | 'warning' | 'success'  // default: 'primary'
  loading?: boolean                   // Confirm button loading state (default: false)
  closeOnBackdrop?: boolean           // Close on backdrop click (default: true)
}
```

**Emits:**
```typescript
{
  confirm: []                 // User confirmed action
  cancel: []                  // User cancelled action
  'update:isOpen': [value: boolean]  // v-model support
}
```

**Slots:**
- `default` - Custom message content

**Usage:**
```vue
<!-- Delete confirmation -->
<ConfirmDialog
  v-model:is-open="showDeleteDialog"
  title="Delete Recipe"
  message="Are you sure you want to delete this recipe? This action cannot be undone."
  severity="error"
  confirm-text="Delete"
  @confirm="handleDelete"
/>

<!-- With loading state -->
<ConfirmDialog
  v-model:is-open="showDialog"
  message="Save changes to recipe?"
  :loading="saving"
  @confirm="handleSave"
/>

<!-- Custom content -->
<ConfirmDialog
  v-model:is-open="showBulkDelete"
  title="Delete Multiple Recipes"
>
  <p>You are about to delete {{ selectedCount }} recipes.</p>
  <p class="text-secondary">This action cannot be undone.</p>
</ConfirmDialog>
```

**Related Components:** None

**Notes:**
- ESC key closes dialog
- Backdrop click closes dialog (unless loading or closeOnBackdrop=false)
- Uses Teleport to render in body
- Modal animations included

---

### EmptyState

**Location:** `components/shared/EmptyState.vue`

**Purpose:** Display when no data/results are available

**Props:**
```typescript
interface Props {
  icon?: string               // PrimeIcon name (without 'pi-' prefix)
  title?: string              // Main message
  description?: string        // Descriptive text
  actionText?: string         // Action button text (default: 'Get Started')
  action?: () => void         // Action button handler
  compact?: boolean           // Compact mode (default: false)
}
```

**Emits:**
```typescript
{
  action: []  // Emitted when action button clicked
}
```

**Slots:**
- `default` - Additional content
- `actions` - Custom action buttons (replaces default button)

**Usage:**
```vue
<!-- No recipes found -->
<EmptyState
  icon="search"
  title="No recipes found"
  description="Try adjusting your filters or search terms"
  action-text="Clear Filters"
  @action="clearFilters"
/>

<!-- Empty favorites with custom actions -->
<EmptyState
  icon="heart"
  title="No favorites yet"
  description="Start adding recipes to your favorites to see them here"
>
  <template #actions>
    <button class="btn btn-primary" @click="goToBrowse">Browse Recipes</button>
  </template>
</EmptyState>

<!-- Compact mode -->
<EmptyState
  icon="inbox"
  title="No items"
  :compact="true"
/>
```

**Related Components:** LoadingSpinner, ErrorMessage

**Notes:**
- Always provide helpful guidance to user
- Include action when appropriate

---

### PageHeader

**Location:** `components/shared/PageHeader.vue`

**Purpose:** Consistent page header with title, subtitle, back button, and actions

**Props:**
```typescript
interface Props {
  title: string               // Page title (required)
  subtitle?: string           // Optional subtitle
  backTo?: string             // Route name/path to navigate back to (shows back button)
}
```

**Emits:** None

**Slots:**
- `actions` - Right-side action buttons
- `tabs` - Tab navigation below header (with top border)

**Usage:**
```vue
<!-- Basic header -->
<PageHeader title="Recipe Management" />

<!-- With subtitle and actions -->
<PageHeader
  title="Edit Recipe"
  subtitle="Last updated 2 hours ago"
>
  <template #actions>
    <button class="btn btn-primary" @click="save">Save</button>
    <button class="btn btn-outline" @click="cancel">Cancel</button>
  </template>
</PageHeader>

<!-- With back button -->
<PageHeader
  title="Recipe Details"
  subtitle="Chocolate Chip Cookies"
  back-to="/recipes"
/>

<!-- With tabs -->
<PageHeader title="Admin Dashboard">
  <template #tabs>
    <div class="tabs">
      <button class="tab tab-active">Overview</button>
      <button class="tab">Analytics</button>
    </div>
  </template>
</PageHeader>
```

**Related Components:** None

**Notes:**
- Responsive design (stacks on mobile)
- Back button uses router.push() or router.back()
- Border-bottom separates from content

---

### Badge

**Location:** `components/shared/Badge.vue`

**Purpose:** Display status, tags, dietary indicators, or counts

**Props:**
```typescript
interface Props {
  variant?: 'default' | 'primary' | 'secondary' | 'success' | 'warning' | 'error' | 'info'  // default: 'default'
  size?: 'sm' | 'md' | 'lg'  // default: 'md'
  icon?: string               // PrimeIcon name (without 'pi-' prefix)
  pill?: boolean              // Fully rounded pill style (default: false)
  dot?: boolean               // Dot indicator (small circle) (default: false)
}
```

**Emits:** None

**Slots:**
- `default` - Badge content/text

**Usage:**
```vue
<!-- Dietary tag -->
<Badge variant="success">Vegetarian</Badge>

<!-- With icon -->
<Badge variant="info" icon="clock">15 min</Badge>

<!-- Status badge as pill -->
<Badge variant="warning" :pill="true">Draft</Badge>

<!-- Count badge -->
<Badge variant="primary" size="sm">5</Badge>

<!-- Dot indicator -->
<Badge variant="error" :dot="true" />

<!-- Multiple badges -->
<div class="flex gap-sm">
  <Badge variant="success">Gluten-Free</Badge>
  <Badge variant="info">Quick & Easy</Badge>
  <Badge variant="secondary">Italian</Badge>
</div>
```

**Related Components:** None

**Notes:**
- Uses semantic colors from design tokens
- Dark mode compatible
- Dot style useful for status indicators
- Pill style for tags

---

### LanguageSwitcher

**Location:** `components/shared/LanguageSwitcher.vue`

**Purpose:** Allows users to switch between all 7 supported languages. Displays languages with native names and flag emojis. Persists language preference to localStorage and syncs with Vue I18n.

**Props:**
```typescript
// No props - uses uiStore for state management
```

**Emits:**
```typescript
// No emits - updates state through uiStore.setLanguage()
```

**Slots:** None

**Usage:**
```vue
<!-- Basic usage - typically in header/navbar -->
<LanguageSwitcher />
```

**Supported Languages:**
- üá¨üáß English (en)
- üáØüáµ Êó•Êú¨Ë™û (ja)
- üá∞üá∑ ÌïúÍµ≠Ïñ¥ (ko)
- üáπüáº ÁπÅÈ´î‰∏≠Êñá (zh-tw)
- üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá (zh-cn)
- üá™üá∏ Espa√±ol (es)
- üá´üá∑ Fran√ßais (fr)

**How It Works:**
1. Displays current language from `useI18n().locale`
2. When user selects new language:
   - Calls `uiStore.setLanguage(code)`
   - Updates Vue I18n locale
   - Saves to localStorage (`locale` key)
   - Updates document language attribute
   - Updates text direction (LTR/RTL if needed)
3. All UI text updates immediately via Vue I18n's `$t()` function

**Related Components:** None (standalone)

**i18n Keys Used:**
- `common.labels.language` - Accessibility label for select dropdown

**Notes:**
- Language preference persists across sessions via localStorage
- Falls back to browser language ‚Üí 'en' on first visit
- Uses CSS custom properties for styling (border, background, colors)
- Fully accessible with aria-label
- Mobile responsive (adapts to small screens)
- Works in both light and dark modes

---

## Admin Components

### Admin Layout

#### AdminLayout

**Location:** `components/admin/layout/AdminLayout.vue`

**Purpose:** Main layout wrapper for all admin pages. Provides consistent structure with navbar, sidebar, and main content area. Manages sidebar open/close state.

**Props:**
```typescript
// No props - internal state management only
```

**Emits:**
```typescript
// No emits - internal state management only
```

**Slots:**
- `default` - Main content area for page-specific content

**Usage:**
```vue
<!-- In router configuration -->
{
  path: '/admin',
  component: AdminLayout,
  children: [
    {
      path: '',
      component: AdminDashboard
    }
  ]
}

<!-- AdminDashboard.vue renders inside the layout -->
<template>
  <div class="admin-dashboard">
    <PageHeader title="Dashboard" subtitle="Welcome back to Ember Admin" />
    <!-- Dashboard content here -->
  </div>
</template>
```

**Related Components:** AdminNavBar, AdminSidebar, AdminBreadcrumbs

**Notes:**
- Manages sidebar state internally with `ref(true)` - defaults to open on desktop
- Sidebar toggles on mobile (<768px) with overlay backdrop
- Uses flexbox layout: sticky navbar at top, sidebar on left, scrollable main content
- Background color uses `--color-background-secondary` for subtle contrast
- Max width `--max-width-7xl` with auto margins for content centering
- Responsive padding: `--spacing-xl` on desktop, `--spacing-md` on mobile

---

#### AdminNavBar

**Location:** `components/admin/layout/AdminNavBar.vue`

**Purpose:** Top navigation bar for admin interface with branding, sidebar toggle, theme controls, and user menu

**Props:**
```typescript
// No props
```

**Emits:**
```typescript
interface Emits {
  (e: 'toggle-sidebar'): void  // Emitted when sidebar toggle button is clicked
}
```

**Slots:**
- None

**Usage:**
```vue
<!-- Used internally by AdminLayout -->
<AdminNavBar @toggle-sidebar="toggleSidebar" />

<!-- Features available to users: -->
<!-- - Click hamburger menu to toggle sidebar -->
<!-- - Click globe icon to change language (future feature) -->
<!-- - Click sun/moon icon to toggle light/dark theme -->
<!-- - Click user avatar to open dropdown menu -->
<!-- - User menu includes: Profile, Settings, Logout -->
```

**Related Components:** AdminLayout, AdminSidebar

**Notes:**
- **Branding:** Displays Ember logo (fire icon) + "Ember" text + "Admin" badge
- **Sidebar Toggle:** Hamburger menu button on left side, emits 'toggle-sidebar' event
- **Language Selector:** Globe icon (placeholder for future i18n feature)
- **Theme Toggle:** Sun/moon icon, integrates with `useUiStore().setTheme()`
- **User Menu:** Shows user avatar with initials, name (desktop only), dropdown with:
  - Profile link ‚Üí `/admin/profile`
  - Settings link ‚Üí `/admin/settings`
  - Logout button ‚Üí calls `userStore.logout()` and redirects to `/login`
- **Responsive:** Hides user name and dropdown chevron on mobile (<768px)
- **Click-Outside:** Dropdowns close when clicking outside (window event listener)
- **Sticky Positioning:** Stays at top with `position: sticky; top: 0;`
- **Height:** Fixed 64px height for consistent layout
- **Z-index:** Uses `--z-index-sticky` to stay above content

---

#### AdminSidebar

**Location:** `components/admin/layout/AdminSidebar.vue`

**Purpose:** Persistent sidebar with admin menu navigation. Supports desktop and mobile responsive modes.

**Props:**
```typescript
interface Props {
  isOpen: boolean  // Controls sidebar visibility (managed by AdminLayout)
}
```

**Emits:**
```typescript
interface Emits {
  (e: 'close'): void  // Emitted when mobile overlay is clicked
}
```

**Slots:**
- None

**Usage:**
```vue
<!-- Used internally by AdminLayout -->
<AdminSidebar :is-open="sidebarOpen" @close="closeSidebar" />

<!-- The sidebar contains these navigation items: -->
<!-- Primary Menu: -->
<!-- - Dashboard (/admin) - chart-line icon -->
<!-- - Recipes (/admin/recipes) - book icon -->
<!-- - Data References (/admin/data-references) - database icon -->
<!-- - AI Prompts (/admin/prompts) - sparkles icon -->
<!-- - Ingredients (/admin/ingredients) - list icon -->

<!-- Secondary Menu (after divider): -->
<!-- - Settings (/admin/settings) - cog icon -->
<!-- - Help & Support (/admin/help) - question-circle icon -->
```

**Related Components:** AdminLayout, AdminNavBar, Badge

**Notes:**
- **Menu Items:** Defined as TypeScript array with path, label, icon, optional badge
- **Active State:** Uses `active-class="admin-sidebar__link--active"` from Vue Router
- **Desktop Behavior (>768px):**
  - Width: 260px when open, 0px when closed
  - Smooth transitions with `transition: transform var(--transition-base)`
  - Sticky positioning: `top: 64px` (below navbar)
  - Height: `calc(100vh - 64px)` for full viewport minus navbar
- **Mobile Behavior (<768px):**
  - Fixed positioning with slide-in animation
  - Transforms from `-100%` (off-screen) to `0` (visible)
  - Semi-transparent overlay backdrop when open
  - Clicking overlay emits 'close' event
  - Box shadow for elevation effect
- **Scrolling:** Content area is scrollable with custom scrollbar styling
- **Divider:** Separates primary and secondary menus
- **Icons:** Uses PrimeIcons with consistent sizing (20px width, centered)
- **Badge Support:** Can display badges on menu items (e.g., notification counts)

---

#### AdminBreadcrumbs

**Location:** `components/admin/layout/AdminBreadcrumbs.vue`

**Purpose:** Display navigation breadcrumbs for admin pages to show current location and allow easy navigation

**Props:**
```typescript
interface Breadcrumb {
  label: string    // Display text for breadcrumb
  path: string     // Router path to navigate to
  icon?: string    // Optional PrimeIcon name (without 'pi-' prefix)
}

interface Props {
  breadcrumbs: Breadcrumb[]  // Array of breadcrumb items
}
```

**Emits:**
```typescript
// No emits - uses router-link for navigation
```

**Slots:**
- None

**Usage:**
```vue
<!-- Basic usage in admin page -->
<AdminBreadcrumbs
  :breadcrumbs="[
    { label: 'Dashboard', path: '/admin', icon: 'home' },
    { label: 'Recipes', path: '/admin/recipes', icon: 'book' },
    { label: 'Edit Recipe', path: '/admin/recipes/123' }
  ]"
/>

<!-- With computed breadcrumbs -->
<script setup>
import { computed } from 'vue'
import { useRoute } from 'vue-router'

const route = useRoute()
const breadcrumbs = computed(() => [
  { label: 'Dashboard', path: '/admin', icon: 'chart-line' },
  { label: 'Recipes', path: '/admin/recipes' },
  { label: route.params.name, path: route.path }
])
</script>

<template>
  <AdminBreadcrumbs :breadcrumbs="breadcrumbs" />
</template>
```

**Related Components:** PageHeader, AdminLayout

**Notes:**
- **Last Item:** Always rendered as `<span>` with `aria-current="page"` (not a link)
- **Icons:** Optional icons displayed before label using PrimeIcons
- **Separator:** Uses `pi-angle-right` icon between items
- **Accessibility:** Wrapped in `<nav aria-label="Breadcrumb">` for screen readers
- **Responsive:** Smaller font on mobile (<768px)
- **Hover Effect:** Links change to primary color on hover
- **Flex Wrap:** Breadcrumbs wrap to multiple lines if needed

---

### Admin Recipes

#### RecipeForm

**Location:** `components/admin/recipes/RecipeForm.vue`

**Purpose:** Comprehensive form for creating and editing recipes with all required fields including ingredients, steps, timing, tags, and equipment

**Props:**
```typescript
interface Props {
  modelValue?: Partial<Recipe> | null  // Recipe data for editing (default: null)
  loading?: boolean                     // Show loading state on save (default: false)
}
```

**Emits:**
```typescript
{
  'update:modelValue': [value: Partial<Recipe>]  // v-model support
  save: []                                         // User clicked Save
  cancel: []                                       // User clicked Cancel
}
```

**Slots:**
None

**Usage:**
```vue
<!-- Create new recipe -->
<RecipeForm
  v-model="recipeData"
  :loading="saving"
  @save="handleSave"
  @cancel="handleCancel"
/>

<!-- Edit existing recipe -->
<RecipeForm
  v-model="existingRecipe"
  :loading="updating"
  @save="handleUpdate"
  @cancel="router.back()"
/>
```

**Form Sections:**
1. **Basic Information**
   - Title (required)
   - Source URL
   - Servings (required)
   - Difficulty (easy/medium/hard)
   - Language (en, ja, ko, zh-tw, zh-cn, es, fr)

2. **Timing**
   - Prep time (minutes)
   - Cook time (minutes)
   - Total time (minutes)

3. **Tags & Classification**
   - Dietary tags (multi-select from dataReferenceStore)
   - Cuisines (multi-select)

4. **Ingredient Groups**
   - Dynamic ingredient groups with add/remove
   - Each ingredient has: name, amount, unit, notes, optional flag
   - Add/remove individual ingredients
   - Delete entire groups (minimum 1 group required)

5. **Steps**
   - Dynamic step list with add/remove/reorder
   - Each step has: instruction (required), timing (optional)
   - Move up/down buttons for reordering
   - Auto-renumbering on changes

6. **Equipment**
   - Comma-separated equipment list
   - Hint text to guide user

**Features:**
- **Validation:** Form validates required fields (title, servings > 0, at least 1 ingredient, at least 1 step)
- **Auto-fetch Data References:** Automatically loads dietary tags, cuisines on mount
- **Responsive:** Mobile-friendly layout with grid-to-column transformation
- **i18n:** 100% translated in all 7 languages
- **Design Tokens:** Uses CSS custom properties for all styling

**Related Components:**
- RecipeImportModal (will use this form for preview/edit)
- RecipeListAdmin (navigation to this form)
- DataReferenceStore (provides tag/cuisine options)

**Notes:**
- Form initializes with 1 empty ingredient and 1 empty step on mount
- Ingredient groups require at least 1 group (cannot delete last group)
- Steps auto-renumber when moved or deleted
- Equipment is stored as comma-separated string, converted to array on save
- Uses PrimeVue components (InputText, InputNumber, Textarea, Dropdown, MultiSelect, Button, Checkbox)
- Satisfies AC-ADMIN-001: Manual Recipe Creation - Full Form

---

#### Image Upload Component

**File:** `frontend/src/components/admin/recipes/RecipeForm.vue`

**Usage:** Admin recipe creation and editing

**Props:** Exposed ref `selectedImageFile: Ref<File | null>`

**Features:**
- File input with drag-and-drop visualization
- Image preview with remove button
- Client-side validation (format: PNG, JPG, GIF, WebP; max 10MB)
- Integrated error messaging

**Localization Keys:**
- `forms.recipe.sections.image` - Section title
- `forms.recipe.image` - Field label
- `forms.recipe.imageUploadPlaceholder` - Upload prompt
- `forms.recipe.imageUploadHint` - Validation help text
- `common.buttons.remove` - Remove image button

---

#### TextImportDialog

**Location:** `components/admin/recipes/TextImportDialog.vue`

**Purpose:** Modal dialog for importing recipes by pasting recipe text. Uses AI (Claude) to parse unstructured recipe text and extract structured data

**Props:**
```typescript
interface Props {
  visible: boolean  // Controls dialog visibility (v-model:visible)
}
```

**Emits:**
```typescript
{
  'update:visible': [value: boolean]  // v-model:visible support
  'import': [text: string]             // User clicked Import with text
}
```

**Exposed Methods:**
```typescript
{
  setLoading(value: boolean): void   // Set loading state from parent
  setError(message: string): void    // Display error message from parent
  resetDialog(): void                // Clear form and reset state
}
```

**Slots:** None

**Usage:**
```vue
<script setup>
const dialogVisible = ref(false)
const dialogRef = ref(null)

async function handleImport(text) {
  dialogRef.value.setLoading(true)
  try {
    const response = await adminApi.parseText({ text_content: text })
    formData.value = response.data.recipe_data
    dialogVisible.value = false
    dialogRef.value.resetDialog()
  } catch (error) {
    dialogRef.value.setError('Failed to parse recipe')
  }
}
</script>

<template>
  <Button label="Import from Text" @click="dialogVisible = true" />
  <TextImportDialog
    ref="dialogRef"
    v-model:visible="dialogVisible"
    @import="handleImport"
  />
</template>
```

**Features:**
- Large monospace textarea (400px min-height)
- Validation: Requires min 50 characters
- Loading state with spinner
- Error handling (keeps dialog open for retry)
- 100% i18n coverage (7 languages)
- Keyboard accessible (Tab, Enter, Escape)

**States:**
1. Empty: Import button disabled
2. Text entered (>= 50 chars): Import enabled
3. Loading: Spinner shown, controls disabled
4. Error: Message displayed inline, text preserved
5. Success: Dialog closes, parent shows feedback

**Related Components:** RecipeForm, AdminRecipeNew

**API:** `POST /admin/recipes/parse_text` with `{ text_content: string }`

**Notes:**
- Dialog not closable during loading
- Uses PrimeVue Dialog, Textarea, Button
- Typical parse time: 5-15 seconds
- Satisfies AC-ADMIN-UI-TEXT-001 through AC-ADMIN-UI-TEXT-005

---

#### UrlImportDialog

**Location:** `components/admin/recipes/UrlImportDialog.vue`

**Purpose:** Modal dialog for importing recipes from URL. Uses AI (Claude) to fetch and parse recipe from webpage, with web scraping fallback. Features playful loading state with cooking puns.

**Props:**
```typescript
interface Props {
  visible: boolean  // Controls dialog visibility (v-model:visible)
}
```

**Emits:**
```typescript
{
  'update:visible': [value: boolean]    // v-model:visible support
  'import': [url: string]                // User clicked Import with URL
  'switch-to-text': [url: string]        // User clicked Switch to Text Import
}
```

**Exposed Methods:**
```typescript
{
  setLoading(value: boolean): void   // Set loading state from parent
  setError(message: string): void    // Display error message from parent
  resetDialog(): void                // Clear form and reset state
}
```

**Slots:** None

**Usage:**
```vue
<script setup>
const dialogVisible = ref(false)
const dialogRef = ref(null)

async function handleImportUrl(url) {
  dialogRef.value.setLoading(true)
  try {
    const response = await adminApi.parseUrl({ url })
    formData.value = response.data.recipe_data
    dialogVisible.value = false
    dialogRef.value.resetDialog()
  } catch (error) {
    if (error.message.includes('not find')) {
      dialogRef.value.setError('Could not find a recipe on this page')
    } else {
      dialogRef.value.setError('Failed to parse recipe from URL')
    }
  }
}

function handleSwitchToText(url) {
  // Close URL dialog, open text dialog
  dialogVisible.value = false
  textDialogVisible.value = true
}
</script>

<template>
  <Button label="Import from URL" @click="dialogVisible = true" />
  <UrlImportDialog
    ref="dialogRef"
    v-model:visible="dialogVisible"
    @import="handleImportUrl"
    @switch-to-text="handleSwitchToText"
  />
</template>
```

**Features:**
- URL format validation (HTTP/HTTPS only)
- PlayfulLoadingSpinner with rotating cooking puns every 2 seconds
- Error recovery with "Switch to Text Import" option
- Error handling for all scenarios (timeout, 403, 404, no recipe, etc.)
- 100% i18n coverage (7 languages with culturally appropriate cooking puns)
- Keyboard accessible (Tab, Enter, Escape)

**States:**
1. Empty: Import button disabled
2. Invalid URL: Validation error shown, Import disabled
3. Valid URL: Import enabled
4. Loading: PlayfulLoadingSpinner shown, dialog not dismissible
5. Error: Message displayed, URL preserved, "Try Again" and "Switch to Text Import" buttons shown
6. Success: Dialog closes, parent shows feedback

**Related Components:** RecipeForm, AdminRecipeNew, PlayfulLoadingSpinner

**API:** `POST /admin/recipes/parse_url` with `{ url: string }`

**Notes:**
- Dialog not closable during loading
- Uses PrimeVue Dialog, InputText, Button
- Typical parse time: 10-30 seconds (AI direct access) or 15-45 seconds (with scraping fallback)
- Satisfies AC-ADMIN-UI-URL-001 through AC-ADMIN-UI-URL-012
- Backend uses two-tier approach: AI direct access first, web scraping fallback if needed

---

## User Components

### User Layout

*(Components to be documented as they are created)*

---

## Composables

### useBreakpoints

**Location:** `composables/useBreakpoints.ts`

**Purpose:** Reactive breakpoint detection for responsive design

**Returns:**
```typescript
{
  isMobile: Ref<boolean>      // < 768px
  isTablet: Ref<boolean>      // 768px - 1023px
  isDesktop: Ref<boolean>     // >= 1024px
  width: Ref<number>          // Current window width
}
```

**Usage:**
```vue
<script setup lang="ts">
import { useBreakpoints } from '@/composables/useBreakpoints'

const { isMobile, isTablet, isDesktop } = useBreakpoints()
</script>

<template>
  <div>
    <MobileNav v-if="isMobile" />
    <DesktopNav v-else />
  </div>
</template>
```

**Notes:**
- Automatically handles window resize
- Cleans up event listeners on unmount

---

### useDebounce

**Location:** `composables/useDebounce.ts`

**Purpose:** Debounce input values to reduce API calls

**Parameters:**
```typescript
function useDebounce<T>(
  value: Ref<T>,
  delay?: number  // default: 300ms
): Ref<T>
```

**Usage:**
```vue
<script setup lang="ts">
import { ref } from 'vue'
import { useDebounce } from '@/composables/useDebounce'

const searchQuery = ref('')
const debouncedQuery = useDebounce(searchQuery, 500)

watch(debouncedQuery, (newQuery) => {
  // This will only fire 500ms after user stops typing
  searchRecipes(newQuery)
})
</script>

<template>
  <input v-model="searchQuery" placeholder="Search recipes..." />
</template>
```

**Notes:**
- Use for search inputs and filters
- 300-500ms delay is recommended

---

### useToast

**Location:** `composables/useToast.ts`

**Purpose:** Display toast notifications

**Returns:**
```typescript
{
  showSuccess: (message: string, duration?: number) => void
  showError: (message: string, duration?: number) => void
  showWarning: (message: string, duration?: number) => void
  showInfo: (message: string, duration?: number) => void
}
```

**Usage:**
```vue
<script setup lang="ts">
import { useToast } from '@/composables/useToast'

const { showSuccess, showError } = useToast()

async function saveRecipe() {
  try {
    await recipeApi.createRecipe(recipe)
    showSuccess('Recipe saved successfully!')
  } catch (error) {
    showError('Failed to save recipe')
  }
}
</script>
```

**Notes:**
- Integrates with uiStore notifications
- Default duration: 5 seconds
- Auto-dismiss after duration

---

### useAuth

**Location:** `composables/useAuth.ts`

**Purpose:** Authentication helper functions

**Returns:**
```typescript
{
  isAuthenticated: ComputedRef<boolean>
  isAdmin: ComputedRef<boolean>
  currentUser: ComputedRef<User | null>
  login: (credentials: LoginCredentials) => Promise<void>
  logout: () => Promise<void>
  requireAuth: () => boolean  // Redirects to login if not authenticated
}
```

**Usage:**
```vue
<script setup lang="ts">
import { useAuth } from '@/composables/useAuth'

const { isAuthenticated, isAdmin, requireAuth } = useAuth()

function handleFavorite() {
  if (!requireAuth()) return
  // User is authenticated, proceed
  toggleFavorite()
}
</script>

<template>
  <Button v-if="isAdmin" label="Admin Panel" />
</template>
```

**Notes:**
- Wraps userStore for convenience
- Use requireAuth() before protected actions

---

## Template for New Components

When adding a new component, copy this template:

```markdown
### ComponentName

**Location:** `components/path/to/ComponentName.vue`

**Purpose:** Brief description of what this component does

**Props:**
```typescript
interface Props {
  propName: PropType         // Description
  optional?: string          // Optional prop (default: 'value')
}
```

**Emits:**
```typescript
{
  eventName: [payload: Type]  // When this event is emitted
}
```

**Slots:**
- `slotName` - Description of slot purpose

**Usage:**
```vue
<!-- Basic usage -->
<ComponentName :prop="value" />

<!-- Advanced usage -->
<ComponentName :prop="value" @event="handler">
  <template #slot>Custom content</template>
</ComponentName>
```

**Related Components:** OtherComponent, AnotherComponent

**Notes:**
- Important considerations
- limitations or limitations
```

---

## Component Status Tracker

| Component | Status | Documented | Last Updated |
|-----------|--------|------------|--------------|
| LoadingSpinner | ‚úÖ Defined | ‚úÖ Yes | 2025-10-08 |
| ErrorMessage | ‚úÖ Defined | ‚úÖ Yes | 2025-10-08 |
| ConfirmDialog | ‚úÖ Defined | ‚úÖ Yes | 2025-10-08 |
| EmptyState | ‚úÖ Defined | ‚úÖ Yes | 2025-10-08 |
| PageHeader | ‚úÖ Defined | ‚úÖ Yes | 2025-10-08 |
| Badge | ‚úÖ Defined | ‚úÖ Yes | 2025-10-08 |
| AdminLayout | üìù Placeholder | ‚è≥ Pending | - |
| AdminNavBar | üìù Placeholder | ‚è≥ Pending | - |
| AdminSidebar | üìù Placeholder | ‚è≥ Pending | - |
| AdminBreadcrumbs | üìù Placeholder | ‚è≥ Pending | - |
| RecipeForm | üìù Placeholder | ‚è≥ Pending | - |

**Legend:**
- Defined - Component spec fully documented
- Placeholder - Component not yet created
- Pending - Needs documentation
- Outdated - Documentation out of sync

---

## Maintenance Checklist

Before marking any component work as "complete":

- [ ] Component is fully functional
- [ ] All props are documented with types and defaults
- [ ] All emits are documented with payload types
- [ ] All slots are documented
- [ ] At least 2 usage examples provided
- [ ] Related components are listed
- [ ] Notes section includes limitations and best practices
- [ ] Component status tracker is updated
- [ ] `Last Updated` date is current

---


```



---

# Workflow History

## Workflow Log

[2:21:11 am] System performed user-input
[2:21:16 am] System performed user-input
[2:21:16 am] System performed deterministic
[2:21:16 am] System performed deterministic
[2:21:16 am] User described feature, saved to feature.json and feature.md [commit #eb67fe0]

## Git Commits

[2:21:16 am] [eb67fe0] [Feature] [ANCHOR-AI] Feature: Describe feature


---

# Session Artifacts

## feature

```json
{
  "name": "recipes can have tags",
  "description": "- each recipe can have tags\n- each tag is just a string of characters\n  - case preserved\n  - 40 chars max\n- each recipe has it's own set of tags, there's no universally shared tags or anything like that, even if there are duplicates\n- whitespace should be trimmed\n- added below aliases in admin create recipe form",
  "items": [
    {
      "text": "each recipe can have tags"
    },
    {
      "text": "each tag is just a string of characters",
      "items": [
        {
          "text": "case preserved"
        },
        {
          "text": "40 chars max"
        }
      ]
    },
    {
      "text": "each recipe has it's own set of tags, there's no universally shared tags or anything like that, even if there are duplicates"
    },
    {
      "text": "whitespace should be trimmed"
    },
    {
      "text": "added below aliases in admin create recipe form"
    }
  ]
}
```

---

# Task

Create a comprehensive development plan for this feature.

## Phase 1: Explore the Codebase

Use your available tools to understand the project structure:
- **glob**: List files to understand project structure
  - Example: glob("backend/app/controllers/**/*.rb")
- **grep**: Search for patterns, classes, methods
  - Example: grep("class.*Controller", "backend/app/controllers/**/*.rb")
- **read_file**: Read specific files to understand implementation details
  - Example: read_file("backend/app/controllers/api/v1/recipes_controller.rb")

### Backend Exploration
Analyze:
- Controllers (backend/app/controllers/)
- Models (backend/app/models/)
- Services (backend/app/services/)
- Configuration files
- Testing patterns (backend/spec/)

### Frontend Exploration
Analyze:
- Components (frontend/src/components/)
- Views (frontend/src/views/)
- Stores (frontend/src/stores/)
- Routing structure
- Testing patterns (frontend/tests/)

## Phase 2: Create Development Plan

Based on your exploration, break down the feature into:

1. **Backend tasks** - Each task should have a clear description and atomic subtasks
   - Models: What database tables/models need to be created/modified?
   - Controllers: What API endpoints need to be implemented?
   - Services: What business logic needs to be encapsulated?
   - Tests: What RSpec tests need to be written?

2. **Frontend tasks** - Each task should have a clear description and atomic subtasks
   - Components: What UI components need to be created/modified?
   - Views: What pages/views need to be implemented?
   - Stores: What state management is needed?
   - Routing: What routes need to be added/modified?
   - Tests: What Playwright tests need to be written?

Each subtask should be atomic - implementable in one focused development session.

# Output Format

Return JSON matching this exact structure:
```json
{
  "backend": [
    {
      "desc": "Description of the backend task/step",
      "subtasks": [
        {"desc": "Atomic subtask 1"},
        {"desc": "Atomic subtask 2"}
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Description of the frontend task/step",
      "subtasks": [
        {"desc": "Atomic subtask 1"},
        {"desc": "Atomic subtask 2"}
      ]
    }
  ]
}
```




================================================================================
[2025-11-10T18:22:00.663Z] RESPONSE
Step: step-2-plan-feature
Model: claude-sonnet-4-5-20250929
Tokens: 2642
================================================================================

I'll explore the codebase to understand the current structure and then create a comprehensive development plan for adding tags to recipes.

## Phase 1: Exploring the Codebase

Let me start by understanding the project structure and existing implementations.

<function_calls>
<invoke name="glob">
<parameter name="pattern">backend/app/models/*.rb</parameter>
</invoke>
</function_calls>
<invoke name="glob">
<parameter name="pattern">backend/app/controllers/api/**/*.rb</parameter>
</invoke>
<function_calls>
<invoke name="read_file">
<parameter name="path">backend/app/models/recipe.rb</parameter>
</invoke>
</function_calls>
<invoke name="read_file">
<parameter name="path">backend/db/schema.rb</parameter>
</invoke>
</function_calls>
<invoke name="grep">
<parameter name="pattern">recipe_aliases</parameter>
<parameter name="path">backend/db/schema.rb</parameter>
</invoke>
</function_calls>
<invoke name="read_file">
<parameter name="path">backend/app/models/recipe_alias.rb</parameter>
</invoke>
</function_calls>
<invoke name="read_file">
<parameter name="path">backend/app/controllers/api/v1/admin/recipes_controller.rb</parameter>
</invoke>
</function_calls>
<invoke name="glob">
<parameter name="pattern">frontend/src/components/admin/recipes/*.vue</parameter>
</invoke>
</function_calls>
<invoke name="read_file">
<parameter name="path">frontend/src/components/admin/recipes/RecipeForm.vue</parameter>
</invoke>
</function_calls>
<invoke name="grep">
<parameter name="pattern">aliases</parameter>
<parameter name="path">frontend/src/components/admin/recipes/RecipeForm.vue</parameter>
</invoke>
</function_calls>
<invoke name="glob">
<parameter name="pattern">backend/spec/models/*.rb</parameter>
</invoke>
</function_calls>
<invoke name="read_file">
<parameter name="path">backend/spec/models/recipe_spec.rb</parameter>
</invoke>
</function_calls>
<invoke name="read_file">
<parameter name="path">backend/spec/models/recipe_alias_spec.rb</parameter>
</invoke>

Now let me check the i18n structure for localization:

<function_calls>
<invoke name="grep">
<parameter name="pattern">aliases</parameter>
<parameter name="path">frontend/src/locales/en.json</parameter>
</invoke>
</function_calls>
<invoke name="read_file">
<parameter name="path">frontend/src/locales/en.json</parameter>
</invoke>

Let me check how the admin controller handles nested attributes:

<function_calls>
<invoke name="grep">
<parameter name="pattern">recipe_params</parameter>
<parameter name="path">backend/app/controllers/api/v1/admin/recipes_controller.rb</parameter>
</invoke>

## Phase 2: Development Plan

Based on my exploration, I can see that:
1. The project already has a similar pattern with `recipe_aliases` - a simple string-based association
2. Tags should follow a similar pattern: simple string storage per recipe
3. The `RecipeForm.vue` has aliases in the "Tags & Classification" section
4. The backend uses `accepts_nested_attributes_for` pattern

Here's the comprehensive development plan:

```json
{
  "backend": [
    {
      "desc": "Create RecipeTag model and migration for tags table",
      "subtasks": [
        {"desc": "Generate migration for recipe_tags table with columns: id (bigint), recipe_id (bigint), tag (string, limit: 40), created_at, updated_at"},
        {"desc": "Add foreign key constraint from recipe_tags to recipes with ON DELETE CASCADE"},
        {"desc": "Add index on recipe_id for efficient lookups"},
        {"desc": "Add unique index on [recipe_id, tag] to prevent duplicate tags per recipe"},
        {"desc": "Run migration"},
        {"desc": "Create RecipeTag model at backend/app/models/recipe_tag.rb"},
        {"desc": "Add belongs_to :recipe association in RecipeTag model"},
        {"desc": "Add validations: presence of tag, length maximum 40, format to trim whitespace"}
      ]
    },
    {
      "desc": "Update Recipe model to support tags",
      "subtasks": [
        {"desc": "Add has_many :recipe_tags, dependent: :destroy association"},
        {"desc": "Add accepts_nested_attributes_for :recipe_tags with allow_destroy: true and reject_if for blank tags"},
        {"desc": "Add before_validation callback to trim whitespace from tag values via nested attributes"}
      ]
    },
    {
      "desc": "Update Admin Recipes Controller to handle tags",
      "subtasks": [
        {"desc": "Add recipe_tags_attributes: [:id, :tag, :_destroy] to recipe_params strong parameters"},
        {"desc": "Update show action JSON response to include tags array (map recipe_tags to just tag strings)"},
        {"desc": "Update index action JSON response to include tags array for each recipe"}
      ]
    },
    {
      "desc": "Write RSpec tests for RecipeTag model",
      "subtasks": [
        {"desc": "Create backend/spec/models/recipe_tag_spec.rb"},
        {"desc": "Test belongs_to :recipe association"},
        {"desc": "Test validation: tag presence is required"},
        {"desc": "Test validation: tag maximum length is 40 characters"},
        {"desc": "Test validation: whitespace is trimmed from tag value"},
        {"desc": "Test uniqueness: duplicate tags within same recipe are prevented"},
        {"desc": "Test that tags can be duplicated across different recipes"}
      ]
    },
    {
      "desc": "Write RSpec request tests for tags in recipes API",
      "subtasks": [
        {"desc": "Add tests in backend/spec/requests/api/v1/admin/recipes_spec.rb for creating recipe with tags"},
        {"desc": "Test that tags are returned in GET /admin/recipes/:id response"},
        {"desc": "Test that tags are returned in GET /admin/recipes index response"},
        {"desc": "Test updating recipe tags via PATCH /admin/recipes/:id"},
        {"desc": "Test deleting tags via nested attributes with _destroy: true"},
        {"desc": "Test validation error when tag exceeds 40 characters"},
        {"desc": "Test that whitespace is trimmed when creating/updating tags"}
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Add tags input section to RecipeForm component",
      "subtasks": [
        {"desc": "Add tags array to formData reactive object in RecipeForm.vue (initialize as empty array)"},
        {"desc": "Add computed property to convert recipe.recipe_tags array to tags string array on mount/edit"},
        {"desc": "Add tags input field in 'Tags & Classification' section, below aliases"},
        {"desc": "Implement Chips component for tag input (PrimeVue Chips with max-length validation)"},
        {"desc": "Add validation: trim whitespace on tag input"},
        {"desc": "Add validation: reject tags longer than 40 characters"},
        {"desc": "Display character count hint below input (e.g., '0/40 characters')"},
        {"desc": "Convert tags array to recipe_tags_attributes format when saving (map to {tag: value} objects)"},
        {"desc": "Handle tag deletion by adding _destroy: true to recipe_tags_attributes"}
      ]
    },
    {
      "desc": "Add i18n translations for tags UI",
      "subtasks": [
        {"desc": "Add 'tags' label to forms.recipe section in all 7 locale files (en.json, ja.json, ko.json, zh-tw.json, zh-cn.json, es.json, fr.json)"},
        {"desc": "Add 'tagsPlaceholder' hint text to forms.recipe in all locale files (e.g., 'Add tags (press Enter)')"},
        {"desc": "Add 'tagsHint' description to forms.recipe in all locale files (e.g., 'Max 40 characters per tag')"},
        {"desc": "Add validation error message 'tagTooLong' to errors.validation in all locale files"},
        {"desc": "Verify 100% i18n coverage with npm run check:i18n"}
      ]
    },
    {
      "desc": "Update recipe display components to show tags",
      "subtasks": [
        {"desc": "Add tags display section to recipe detail views (if exists)"},
        {"desc": "Use Badge component to render individual tags"},
        {"desc": "Style tags with variant='default' and size='sm' for consistency"},
        {"desc": "Ensure tags wrap properly on small screens"}
      ]
    },
    {
      "desc": "Write Playwright tests for tags functionality",
      "subtasks": [
        {"desc": "Create test file frontend/tests/e2e/admin/recipe-tags.spec.ts"},
        {"desc": "Test adding tags when creating a new recipe"},
        {"desc": "Test that tags are displayed after recipe creation"},
        {"desc": "Test editing existing recipe and adding new tags"},
        {"desc": "Test editing existing recipe and removing tags"},
        {"desc": "Test validation: tags longer than 40 characters are rejected"},
        {"desc": "Test that whitespace is trimmed from tags"},
        {"desc": "Test that duplicate tags within same recipe are handled gracefully"}
      ]
    }
  ]
}
```


================================================================================
[2025-11-10T18:22:57.835Z] REQUEST
Step: step-2-plan-feature
Model: claude-sonnet-4-5-20250929
================================================================================

SYSTEM:
# Planner Agent

You are a specialized AI planning agent for full-stack feature development. Your role is to break down feature descriptions into detailed, actionable task plans for backend and frontend implementation.

## Your Responsibilities

1. **Analyze** the feature description thoroughly
2. **Explore** the existing codebase using read_file, grep, and glob tools
3. **Plan** the implementation steps for both backend and frontend
4. **Break down** complex tasks into atomic subtasks
5. **Output** structured JSON following the exact schema

## 2025 Best Practices You Follow

### Structured Planning (Chain-of-Thought)
- Think step-by-step before outputting the final plan
- State your reasoning explicitly: "First I will..., then I will..."
- Consider dependencies between tasks
- Plan for both happy path and error handling

### PLAN-ACT Separation
- You are in PLAN MODE only - you do NOT write code
- Focus on WHAT needs to be done, not HOW to code it
- Be specific about outcomes, not implementation details

### Task Breakdown Principles
- Each main task should be implementable in one development session
- Subtasks should be atomic (can't be broken down further without losing meaning)
- Use action verbs: "Create", "Add", "Update", "Implement", "Define"
- Be specific about files/components when possible

## Your Process

### Step 1: Understand the Feature
Read the feature description carefully. Identify:
- Core functionality required
- Data models needed (backend)
- UI components needed (frontend)
- Integration points between BE and FE

### Step 2: Explore Existing Codebase
Use your tools to explore and understand the codebase:
- **glob**: Find existing controllers, models, services (backend) and components, views, stores (frontend)
  - Example: `glob("backend/app/controllers/**/*.rb")`
- **grep**: Search for patterns and architectural conventions
  - Example: `grep("class.*Controller", "backend/app/controllers/**/*.rb")`
- **read_file**: Read key files to understand implementation details
  - Example: `read_file("backend/app/models/user.rb")`
- Identify current architectural patterns and testing approach

**Tool Usage Tips:**
- Start broad with `glob` to see what files exist
- Use `grep` to find patterns and similar implementations
- Use `read_file` selectively for key files (don't read everything)
- Focus on understanding patterns, not memorizing every detail

### Step 3: Plan Backend Tasks
For Rails backend, consider:
- Database changes (models, migrations)
- API endpoints (controllers)
- Business logic (services)
- Background jobs (if needed)
- Tests (RSpec)

### Step 4: Plan Frontend Tasks
For Vue 3 frontend, consider:
- New components or views
- State management (Pinia stores)
- API integration (services)
- Routing changes
- Tests (Playwright)

### Step 5: Output Structured JSON
Follow this EXACT schema:

```json
{
  "backend": [
    {
      "desc": "Main task description",
      "subtasks": [
        { "desc": "Specific subtask 1" },
        { "desc": "Specific subtask 2" }
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Main task description",
      "subtasks": [
        { "desc": "Specific subtask 1" },
        { "desc": "Specific subtask 2" }
      ]
    }
  ]
}
```

## Quality Standards

### ‚úÖ Good Task Descriptions
- "Create User model with authentication fields"
- "Add POST /api/v1/recipes endpoint with validation"
- "Implement RecipeCard component with image and title"
- "Add recipe favoriting to Pinia store"

### ‚ùå Bad Task Descriptions
- "Set up the database" (too vague)
- "Fix the frontend" (not specific)
- "Make it work" (no clear outcome)
- "Implement the feature" (not broken down)

### ‚úÖ Good Subtasks
- "Add has_many :favorites association"
- "Validate presence of recipe_id and user_id"
- "Create migration for favorites table"

### ‚ùå Bad Subtasks
- "Do the model stuff" (vague)
- "Add validations" (which ones?)
- "Update database" (how?)

## Important Constraints

- **Read-only access**: You cannot modify files
- **No code writing**: You plan, you don't implement
- **Structured output only**: Always return valid JSON
- **Complete coverage**: Don't skip obvious requirements

## Interaction with User

The user may iterate on your plan. They may say:
- "Break down task X further"
- "Add Y to the plan"
- "This seems too complex, simplify"

Listen to their feedback and revise your plan accordingly. When they approve, output the final JSON.

## Example Output

```json
{
  "backend": [
    {
      "desc": "Create Recipe model with core fields",
      "subtasks": [
        { "desc": "Generate Recipe model with name, description, servings fields" },
        { "desc": "Add validations for required fields" },
        { "desc": "Create migration for recipes table" },
        { "desc": "Run migration" }
      ]
    },
    {
      "desc": "Implement Recipe API endpoints",
      "subtasks": [
        { "desc": "Create RecipesController with index, show, create actions" },
        { "desc": "Add routes for /api/v1/recipes" },
        { "desc": "Add JSON serialization for Recipe model" }
      ]
    },
    {
      "desc": "Write RSpec tests for Recipe",
      "subtasks": [
        { "desc": "Write model specs for validations" },
        { "desc": "Write request specs for API endpoints" }
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Create recipe listing UI",
      "subtasks": [
        { "desc": "Create RecipeList.vue component" },
        { "desc": "Create RecipeCard.vue component for displaying individual recipes" },
        { "desc": "Add route /recipes to router" }
      ]
    },
    {
      "desc": "Integrate with Recipe API",
      "subtasks": [
        { "desc": "Create recipeService.ts with getRecipes method" },
        { "desc": "Create useRecipes composable for state management" },
        { "desc": "Fetch and display recipes in RecipeList component" }
      ]
    }
  ]
}
```

## Remember

- Your goal is to make the implementer's job easy by providing clear, actionable tasks
- Think like a tech lead breaking down work for a development team
- Be thorough but not overwhelming - aim for 3-6 main tasks per side
- Each main task should take 30min - 2 hours to implement
- Subtasks should take 5-30 minutes each

Now, analyze the feature description and create your plan!


USER:
Current output:
```json
{
  "backend": [
    {
      "desc": "Create RecipeTag model and migration for tags table",
      "subtasks": [
        {
          "desc": "Generate migration for recipe_tags table with columns: id (bigint), recipe_id (bigint), tag (string, limit: 40), created_at, updated_at"
        },
        {
          "desc": "Add foreign key constraint from recipe_tags to recipes with ON DELETE CASCADE"
        },
        {
          "desc": "Add index on recipe_id for efficient lookups"
        },
        {
          "desc": "Add unique index on [recipe_id, tag] to prevent duplicate tags per recipe"
        },
        {
          "desc": "Run migration"
        },
        {
          "desc": "Create RecipeTag model at backend/app/models/recipe_tag.rb"
        },
        {
          "desc": "Add belongs_to :recipe association in RecipeTag model"
        },
        {
          "desc": "Add validations: presence of tag, length maximum 40, format to trim whitespace"
        }
      ]
    },
    {
      "desc": "Update Recipe model to support tags",
      "subtasks": [
        {
          "desc": "Add has_many :recipe_tags, dependent: :destroy association"
        },
        {
          "desc": "Add accepts_nested_attributes_for :recipe_tags with allow_destroy: true and reject_if for blank tags"
        },
        {
          "desc": "Add before_validation callback to trim whitespace from tag values via nested attributes"
        }
      ]
    },
    {
      "desc": "Update Admin Recipes Controller to handle tags",
      "subtasks": [
        {
          "desc": "Add recipe_tags_attributes: [:id, :tag, :_destroy] to recipe_params strong parameters"
        },
        {
          "desc": "Update show action JSON response to include tags array (map recipe_tags to just tag strings)"
        },
        {
          "desc": "Update index action JSON response to include tags array for each recipe"
        }
      ]
    },
    {
      "desc": "Write RSpec tests for RecipeTag model",
      "subtasks": [
        {
          "desc": "Create backend/spec/models/recipe_tag_spec.rb"
        },
        {
          "desc": "Test belongs_to :recipe association"
        },
        {
          "desc": "Test validation: tag presence is required"
        },
        {
          "desc": "Test validation: tag maximum length is 40 characters"
        },
        {
          "desc": "Test validation: whitespace is trimmed from tag value"
        },
        {
          "desc": "Test uniqueness: duplicate tags within same recipe are prevented"
        },
        {
          "desc": "Test that tags can be duplicated across different recipes"
        }
      ]
    },
    {
      "desc": "Write RSpec request tests for tags in recipes API",
      "subtasks": [
        {
          "desc": "Add tests in backend/spec/requests/api/v1/admin/recipes_spec.rb for creating recipe with tags"
        },
        {
          "desc": "Test that tags are returned in GET /admin/recipes/:id response"
        },
        {
          "desc": "Test that tags are returned in GET /admin/recipes index response"
        },
        {
          "desc": "Test updating recipe tags via PATCH /admin/recipes/:id"
        },
        {
          "desc": "Test deleting tags via nested attributes with _destroy: true"
        },
        {
          "desc": "Test validation error when tag exceeds 40 characters"
        },
        {
          "desc": "Test that whitespace is trimmed when creating/updating tags"
        }
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Add tags input section to RecipeForm component",
      "subtasks": [
        {
          "desc": "Add tags array to formData reactive object in RecipeForm.vue (initialize as empty array)"
        },
        {
          "desc": "Add computed property to convert recipe.recipe_tags array to tags string array on mount/edit"
        },
        {
          "desc": "Add tags input field in 'Tags & Classification' section, below aliases"
        },
        {
          "desc": "Implement Chips component for tag input (PrimeVue Chips with max-length validation)"
        },
        {
          "desc": "Add validation: trim whitespace on tag input"
        },
        {
          "desc": "Add validation: reject tags longer than 40 characters"
        },
        {
          "desc": "Display character count hint below input (e.g., '0/40 characters')"
        },
        {
          "desc": "Convert tags array to recipe_tags_attributes format when saving (map to {tag: value} objects)"
        },
        {
          "desc": "Handle tag deletion by adding _destroy: true to recipe_tags_attributes"
        }
      ]
    },
    {
      "desc": "Add i18n translations for tags UI",
      "subtasks": [
        {
          "desc": "Add 'tags' label to forms.recipe section in all 7 locale files (en.json, ja.json, ko.json, zh-tw.json, zh-cn.json, es.json, fr.json)"
        },
        {
          "desc": "Add 'tagsPlaceholder' hint text to forms.recipe in all locale files (e.g., 'Add tags (press Enter)')"
        },
        {
          "desc": "Add 'tagsHint' description to forms.recipe in all locale files (e.g., 'Max 40 characters per tag')"
        },
        {
          "desc": "Add validation error message 'tagTooLong' to errors.validation in all locale files"
        },
        {
          "desc": "Verify 100% i18n coverage with npm run check:i18n"
        }
      ]
    },
    {
      "desc": "Update recipe display components to show tags",
      "subtasks": [
        {
          "desc": "Add tags display section to recipe detail views (if exists)"
        },
        {
          "desc": "Use Badge component to render individual tags"
        },
        {
          "desc": "Style tags with variant='default' and size='sm' for consistency"
        },
        {
          "desc": "Ensure tags wrap properly on small screens"
        }
      ]
    },
    {
      "desc": "Write Playwright tests for tags functionality",
      "subtasks": [
        {
          "desc": "Create test file frontend/tests/e2e/admin/recipe-tags.spec.ts"
        },
        {
          "desc": "Test adding tags when creating a new recipe"
        },
        {
          "desc": "Test that tags are displayed after recipe creation"
        },
        {
          "desc": "Test editing existing recipe and adding new tags"
        },
        {
          "desc": "Test editing existing recipe and removing tags"
        },
        {
          "desc": "Test validation: tags longer than 40 characters are rejected"
        },
        {
          "desc": "Test that whitespace is trimmed from tags"
        },
        {
          "desc": "Test that duplicate tags within same recipe are handled gracefully"
        }
      ]
    }
  ]
}
```

User feedback: tags are primarily used to enhance search capibilities, so we need to enhance our search to include fuzzy searching through tags as well

Please revise the output based on this feedback and return the updated JSON.


================================================================================
[2025-11-10T18:24:58.848Z] RESPONSE
Step: step-2-plan-feature
Model: claude-sonnet-4-5-20250929
Tokens: 4244
================================================================================

Perfect! Now I have a comprehensive understanding of the codebase. Let me revise the plan to include tag-based fuzzy search functionality. Based on my exploration:

1. **Backend**: There's already a `RecipeSearchService` with fuzzy search capabilities for recipe names and aliases
2. **Search is used in**: 
   - Admin recipes controller (line 10-11: simple LIKE search)
   - Public API recipes controller (uses `RecipeSearchService.advanced_search` and `comprehensive_search`)
3. **Need to**: Add tag searching to the existing search service and integrate it into the comprehensive search flow

Here's the revised plan with tag search integration:

```json
{
  "backend": [
    {
      "desc": "Create RecipeTag model and migration for tags table",
      "subtasks": [
        {
          "desc": "Generate migration for recipe_tags table with columns: id (bigint), recipe_id (bigint), tag (string, limit: 40), created_at, updated_at"
        },
        {
          "desc": "Add foreign key constraint from recipe_tags to recipes with ON DELETE CASCADE"
        },
        {
          "desc": "Add index on recipe_id for efficient lookups"
        },
        {
          "desc": "Add unique index on [recipe_id, tag] to prevent duplicate tags per recipe"
        },
        {
          "desc": "Add GIN index on tag column using pg_trgm for efficient fuzzy searching"
        },
        {
          "desc": "Run migration"
        },
        {
          "desc": "Create RecipeTag model at backend/app/models/recipe_tag.rb"
        },
        {
          "desc": "Add belongs_to :recipe association in RecipeTag model"
        },
        {
          "desc": "Add validations: presence of tag, length maximum 40, format to trim whitespace"
        },
        {
          "desc": "Add before_validation callback to normalize tag (downcase and strip whitespace)"
        }
      ]
    },
    {
      "desc": "Update Recipe model to support tags",
      "subtasks": [
        {
          "desc": "Add has_many :recipe_tags, dependent: :destroy association"
        },
        {
          "desc": "Add accepts_nested_attributes_for :recipe_tags with allow_destroy: true and reject_if for blank tags"
        },
        {
          "desc": "Add helper method 'tags' that returns array of tag strings (pluck :tag)"
        }
      ]
    },
    {
      "desc": "Extend RecipeSearchService to support fuzzy tag searching",
      "subtasks": [
        {
          "desc": "Add search_by_tag method with fuzzy matching using pg_trgm similarity"
        },
        {
          "desc": "Implement exact match fallback if similarity threshold not met"
        },
        {
          "desc": "Add similarity_threshold parameter (default 0.6 for tags, lower than name search)"
        },
        {
          "desc": "Return recipes ordered by similarity score when using fuzzy match"
        },
        {
          "desc": "Update comprehensive_search method to include tag search after alias search"
        },
        {
          "desc": "Update advanced_search method to support :tag or :tags parameter"
        },
        {
          "desc": "Add filter_by_tags method to filter by multiple tags (OR logic)"
        }
      ]
    },
    {
      "desc": "Update Admin Recipes Controller to handle tags",
      "subtasks": [
        {
          "desc": "Add recipe_tags_attributes: [:id, :tag, :_destroy] to recipe_params strong parameters"
        },
        {
          "desc": "Update index action to support :tag query parameter for tag-based search"
        },
        {
          "desc": "Update show action JSON response to include tags array"
        },
        {
          "desc": "Update index action JSON response to include tags array for each recipe"
        },
        {
          "desc": "Update admin_recipe_json method to include tags in serialization"
        }
      ]
    },
    {
      "desc": "Update Public API Recipes Controller to support tag search",
      "subtasks": [
        {
          "desc": "Add :tag and :tags parameters to advanced search parameter check"
        },
        {
          "desc": "Update recipe_list_json to include tags array"
        },
        {
          "desc": "Update recipe_detail_json to include tags array"
        },
        {
          "desc": "Ensure eager loading includes :recipe_tags in index and show actions"
        }
      ]
    },
    {
      "desc": "Write RSpec tests for RecipeTag model",
      "subtasks": [
        {
          "desc": "Create backend/spec/models/recipe_tag_spec.rb"
        },
        {
          "desc": "Test belongs_to :recipe association"
        },
        {
          "desc": "Test validation: tag presence is required"
        },
        {
          "desc": "Test validation: tag maximum length is 40 characters"
        },
        {
          "desc": "Test before_validation: tag is normalized (downcased and stripped)"
        },
        {
          "desc": "Test uniqueness: duplicate tags within same recipe are prevented"
        },
        {
          "desc": "Test that tags can be duplicated across different recipes"
        }
      ]
    },
    {
      "desc": "Write RSpec tests for tag search in RecipeSearchService",
      "subtasks": [
        {
          "desc": "Create backend/spec/services/recipe_search_service_tag_spec.rb"
        },
        {
          "desc": "Test search_by_tag with exact match"
        },
        {
          "desc": "Test search_by_tag with fuzzy match (typos and partial matches)"
        },
        {
          "desc": "Test search_by_tag similarity scoring and ordering"
        },
        {
          "desc": "Test comprehensive_search includes tag results"
        },
        {
          "desc": "Test advanced_search with :tag parameter"
        },
        {
          "desc": "Test filter_by_tags with multiple tags (OR logic)"
        },
        {
          "desc": "Test that tag search is case-insensitive"
        }
      ]
    },
    {
      "desc": "Write RSpec request tests for tags in recipes API",
      "subtasks": [
        {
          "desc": "Add tests in backend/spec/requests/api/v1/admin/recipes_spec.rb for creating recipe with tags"
        },
        {
          "desc": "Test that tags are returned in GET /admin/recipes/:id response"
        },
        {
          "desc": "Test that tags are returned in GET /admin/recipes index response"
        },
        {
          "desc": "Test searching recipes by tag via GET /admin/recipes?tag=vegan"
        },
        {
          "desc": "Test updating recipe tags via PATCH /admin/recipes/:id"
        },
        {
          "desc": "Test deleting tags via nested attributes with _destroy: true"
        },
        {
          "desc": "Test validation error when tag exceeds 40 characters"
        },
        {
          "desc": "Test fuzzy tag search with typos"
        },
        {
          "desc": "Add tests in backend/spec/requests/api/v1/recipes_spec.rb for tag search in public API"
        },
        {
          "desc": "Test GET /api/v1/recipes?tag=quick returns recipes with similar tags"
        },
        {
          "desc": "Test GET /api/v1/recipes?q=healthy searches through tags as part of comprehensive search"
        }
      ]
    }
  ],
  "frontend": [
    {
      "desc": "Add tags input section to RecipeForm component",
      "subtasks": [
        {
          "desc": "Add tags array to formData reactive object in RecipeForm.vue (initialize as empty array)"
        },
        {
          "desc": "Add computed property to convert recipe.recipe_tags array to tags string array on mount/edit"
        },
        {
          "desc": "Add tags input field in 'Tags & Classification' section, below aliases"
        },
        {
          "desc": "Implement Chips component for tag input (PrimeVue Chips with max-length validation)"
        },
        {
          "desc": "Add validation: trim whitespace and convert to lowercase on tag input"
        },
        {
          "desc": "Add validation: reject tags longer than 40 characters"
        },
        {
          "desc": "Display character count hint below input (e.g., '0/40 characters')"
        },
        {
          "desc": "Convert tags array to recipe_tags_attributes format when saving (map to {tag: value} objects)"
        },
        {
          "desc": "Handle tag deletion by adding _destroy: true to recipe_tags_attributes"
        }
      ]
    },
    {
      "desc": "Add i18n translations for tags UI",
      "subtasks": [
        {
          "desc": "Add 'tags' label to forms.recipe section in all 7 locale files (en.json, ja.json, ko.json, zh-tw.json, zh-cn.json, es.json, fr.json)"
        },
        {
          "desc": "Add 'tagsPlaceholder' hint text to forms.recipe in all locale files (e.g., 'Add tags (press Enter)')"
        },
        {
          "desc": "Add 'tagsHint' description to forms.recipe in all locale files (e.g., 'Max 40 characters per tag. Used to enhance search.')"
        },
        {
          "desc": "Add validation error message 'tagTooLong' to errors.validation in all locale files"
        },
        {
          "desc": "Verify 100% i18n coverage with npm run check:i18n"
        }
      ]
    },
    {
      "desc": "Update recipe display components to show tags",
      "subtasks": [
        {
          "desc": "Add tags display section to recipe detail views (if exists)"
        },
        {
          "desc": "Use Badge or Tag component to render individual tags"
        },
        {
          "desc": "Style tags with appropriate variant and size for consistency"
        },
        {
          "desc": "Ensure tags wrap properly on small screens"
        },
        {
          "desc": "Display tags prominently to indicate they enhance search"
        }
      ]
    },
    {
      "desc": "Enhance search UI to support tag-based searching",
      "subtasks": [
        {
          "desc": "Update recipe search/filter components to explain tag search capability"
        },
        {
          "desc": "Add example text or tooltip indicating tags can be searched (e.g., 'Search by name, ingredient, or tag')"
        },
        {
          "desc": "If advanced search form exists, add dedicated tag search field"
        },
        {
          "desc": "Display matched tags in search results to show why recipe matched"
        }
      ]
    },
    {
      "desc": "Write Playwright tests for tags functionality",
      "subtasks": [
        {
          "desc": "Create test file frontend/tests/e2e/admin/recipe-tags.spec.ts"
        },
        {
          "desc": "Test adding tags when creating a new recipe"
        },
        {
          "desc": "Test that tags are displayed after recipe creation"
        },
        {
          "desc": "Test editing existing recipe and adding new tags"
        },
        {
          "desc": "Test editing existing recipe and removing tags"
        },
        {
          "desc": "Test validation: tags longer than 40 characters are rejected"
        },
        {
          "desc": "Test that whitespace is trimmed and tags are normalized"
        },
        {
          "desc": "Test that duplicate tags within same recipe are handled gracefully"
        },
        {
          "desc": "Test searching recipes by tag returns correct results"
        },
        {
          "desc": "Test fuzzy tag search with typos (e.g., searching 'vgan' finds 'vegan')"
        },
        {
          "desc": "Test that comprehensive search includes tag matches"
        }
      ]
    }
  ]
}
```

